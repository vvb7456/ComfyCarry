<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ComfyCarry</title>
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" href="/static/apple-touch-icon.png">
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&family=IBM+Plex+Sans+SC:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/dashboard.css">
    <script>
        // 主题初始化 — 在 <head> 中内联执行以防止闪烁
        (function() {
            function getTheme() { return localStorage.getItem('theme') || 'system'; }
            function applyTheme(pref) {
                var isDark = pref === 'dark' || (pref === 'system' && matchMedia('(prefers-color-scheme: dark)').matches);
                document.documentElement.dataset.theme = isDark ? '' : 'light';
            }
            applyTheme(getTheme());
            matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function() {
                if (getTheme() === 'system') applyTheme(getTheme());
            });
        })();
    </script>
</head>

<body>

    <!-- Sidebar -->
    <nav class="sidebar" id="sidebar">
        <button class="sidebar-toggle" onclick="toggleSidebar()" title="收起/展开">◀</button>
        <div class="sidebar-logo">
            <img src="/static/logo.png" alt="ComfyCarry" class="logo-icon" width="36" height="36">
            <span class="logo-text">ComfyCarry</span>
        </div>
        <div class="sidebar-nav">
            <div class="nav-item active" data-page="dashboard" onclick="showPage('dashboard')"><span class="icon"><span class="ms" style="color:#8b5cf6">dashboard</span></span><span class="nav-label">总览</span></div>
            <div class="nav-item" data-page="comfyui" onclick="showPage('comfyui')"><span class="icon"><span class="ms" style="color:#22d3ee">terminal</span></span><span class="nav-label">ComfyUI</span></div>
            <div class="nav-item" data-page="models" onclick="showPage('models')"><span class="icon"><span class="ms" style="color:#f472b6">palette</span></span><span class="nav-label">模型管理</span></div>
            <div class="nav-item" data-page="plugins" onclick="showPage('plugins')"><span class="icon"><span class="ms" style="color:#a78bfa">extension</span></span><span class="nav-label">插件管理</span></div>
            <div class="nav-item" data-page="tunnel" onclick="showPage('tunnel')"><span class="icon"><span class="ms" style="color:#60a5fa">language</span></span><span class="nav-label">Tunnel</span></div>
            <div class="nav-item" data-page="jupyter" onclick="showPage('jupyter')"><span class="icon"><span class="ms" style="color:#fb923c">book_2</span></span><span class="nav-label">Jupyter</span></div>
            <div class="nav-item" data-page="sync" onclick="showPage('sync')"><span class="icon"><span class="ms" style="color:#34d399">cloud_sync</span></span><span class="nav-label">Sync</span></div>
            <div class="nav-item" data-page="ssh" onclick="showPage('ssh')"><span class="icon"><span class="ms" style="color:#fbbf24">key</span></span><span class="nav-label">SSH</span></div>
            <div style="flex:1"></div>
            <div class="nav-item" data-page="settings" onclick="showPage('settings')"><span class="icon"><span class="ms" style="color:#94a3b8">settings</span></span><span class="nav-label">设置</span></div>
        </div>
        <div class="sidebar-footer">
            <div class="footer-expanded">
                <a href="/logout" class="btn btn-sm" style="font-size:.72rem;padding:4px 10px;width:100%;text-align:center;justify-content:center;margin-bottom:8px;text-decoration:none"><span class="ms ms-sm" style="color:#94a3b8">logout</span> 登出</a>
                <div id="version-info" style="text-align:center">
                    <a href="https://github.com/vvb7456/ComfyCarry" target="_blank" style="font-size:.68rem;color:var(--t3);text-decoration:none;font-family:'IBM Plex Mono',monospace" title="GitHub">v2.4</a>
                </div>
            </div>
            <div class="footer-collapsed">
                <a href="/logout" title="登出" style="color:var(--t3);font-size:.9rem"><span class="ms ms-sm" style="color:#94a3b8">logout</span></a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="content">

        <!-- ========== Dashboard Page (Overview) ========== -->
        <div id="page-dashboard" class="page">
            <div class="page-header">
                <h2><span class="ms" style="color:#8b5cf6">dashboard</span> 总览</h2>
                <div class="top-toolbar">
                    <button class="btn" onclick="openIEModal()" title="导入/导出配置"><span class="ms ms-sm" style="color:#94a3b8">tune</span> 配置</button>
                </div>
            </div>
            <div class="page-body">
                <!-- Status Bar -->
                <div class="status-bar" id="overview-status-bar">
                    <span class="status-badge muted"><span class="ms ms-sm" style="color:var(--amber)">hourglass_top</span> 加载中...</span>
                </div>

                <!-- Metrics Grid -->
                <div class="section-title"><span class="ms ms-sm" style="color:#f472b6">monitoring</span> 性能指标</div>
                <div class="metrics-grid" id="overview-metrics"></div>

                <!-- Activity Feed -->
                <div class="section-title"><span class="ms ms-sm" style="color:#34d399">trending_up</span> 活动</div>
                <div class="activity-feed" id="overview-activity">
                    <div class="activity-empty"><span class="ms ms-sm" style="color:var(--amber)">hourglass_top</span> 加载中...</div>
                </div>

                <!-- Services Table -->
                <div class="section-title"><span class="ms ms-sm" style="color:#60a5fa">dns</span> 服务</div>
                <div class="card" style="padding:0;overflow-x:auto">
                <table class="svc-table" id="svc-table">
                    <thead>
                        <tr>
                            <th>服务</th>
                            <th>状态</th>
                            <th>运行时间</th>
                            <th>CPU</th>
                            <th>内存</th>
                            <th>重启</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="overview-svc-tbody"></tbody>
                </table>
                </div>

                <!-- Environment Info -->
                <div class="section-header">
                    <div class="section-title"><span class="ms ms-sm" style="color:#60a5fa">info</span> 环境</div>
                </div>
                <div class="env-info" id="overview-env-info"></div>
            </div>
        </div>

        <!-- ========== Models Page (unified: local + civitai + downloads) ========== -->
        <div id="page-models" class="page hidden">
            <div class="page-header">
                <h2><span class="ms" style="color:#f472b6">palette</span> 模型管理</h2>
                <div class="top-toolbar">
                    <button class="btn" onclick="openIEModal()" title="导入/导出配置"><span class="ms ms-sm" style="color:#94a3b8">tune</span> 配置</button>
                </div>
            </div>
            <div class="page-body">
                <div class="tabs">
                    <div class="tab active" data-mtab="local" onclick="switchModelTab('local')"><span class="ms ms-sm" style="color:#a78bfa">inventory_2</span> 本地模型</div>
                    <div class="tab" data-mtab="civitai" onclick="switchModelTab('civitai')"><span class="ms ms-sm" style="color:#60a5fa">search</span> CivitAI</div>
                    <div class="tab" data-mtab="downloads" onclick="switchModelTab('downloads')"><span class="ms ms-sm" style="color:#60a5fa">download</span> 下载管理 <span class="badge-count" id="cart-badge" style="display:none">0</span></div>
                    <div class="tab" data-mtab="workflow" onclick="switchModelTab('workflow')"><span class="ms ms-sm" style="color:#34d399">account_tree</span> 工作流解析</div>
                </div>
                <!-- Local Models Tab -->
                <div id="mtab-local">
                    <div class="toolbar">
                        <div id="local-models-status" style="font-size:.85rem;color:var(--t2)"></div>
                        <div class="toolbar-spacer"></div>
                        <select id="model-category" onchange="loadLocalModels()" style="width:auto;min-width:140px">
                            <option value="all">全部类型</option>
                            <option value="checkpoints">Checkpoints</option>
                            <option value="loras">LoRA</option>
                            <option value="controlnet">ControlNet</option>
                            <option value="vae">VAE</option>
                            <option value="upscale_models">Upscale</option>
                            <option value="embeddings">Embeddings</option>
                        </select>
                        <button class="btn btn-sm" onclick="loadLocalModels()">刷新</button>
                        <button class="btn btn-sm btn-primary" onclick="fetchAllInfo()">全部获取</button>
                    </div>
                    <div id="local-models-grid" class="model-grid"></div>
                </div>
                <!-- CivitAI Tab (unified search + ID lookup) -->
                <div id="mtab-civitai" class="hidden">
                        <div class="search-bar" style="gap:8px;align-items:center;flex-wrap:wrap">
                            <input type="text" id="search-input" placeholder="搜索模型名 / 输入 ID / 粘贴 CivitAI URL..." onkeydown="if(event.key==='Enter')smartSearch()" style="flex:1;min-width:200px">
                            <select id="filter-sort" style="width:auto;min-width:140px">
                                <option value="Relevancy">相关性</option>
                                <option value="Most Downloaded">最多下载</option>
                                <option value="Highest Rated">最高评分</option>
                                <option value="Newest">最新</option>
                            </select>
                            <button class="btn btn-primary" onclick="smartSearch()">搜索</button>
                        </div>
                        <div class="filters">
                            <div class="filter-row"><label>类型</label>
                                <div class="chip-select" id="filter-type-chips"></div>
                            </div>
                            <div class="filter-row"><label>Base Model</label>
                                <div class="chip-select" id="filter-bm-chips" style="max-height:120px;overflow-y:auto"></div>
                            </div>
                        </div>
                        <div id="search-error"></div>
                        <div id="search-loading" class="loading hidden"><div class="spinner"></div><div>搜索中...</div><div id="lookup-progress" style="margin-top:6px;font-size:.78rem"></div></div>
                        <div id="search-results" class="results-grid"></div>
                        <div id="search-pagination" class="pagination"></div>
                </div>
                <!-- Downloads Tab (unified: cart + active + history) -->
                <div id="mtab-downloads" class="hidden">
                    <!-- Sub-tabs -->
                    <div class="tabs" style="font-size:.85rem">
                        <div class="tab active" data-dltab="pending" onclick="switchDlTab('pending')"><span class="ms ms-sm" style="color:#f472b6">push_pin</span> 已选</div>
                        <div class="tab" data-dltab="active" onclick="switchDlTab('active')"><span class="ms ms-sm" style="color:#34d399">sync</span> 队列</div>
                        <div class="tab" data-dltab="completed" onclick="switchDlTab('completed')"><span class="ms ms-sm" style="color:var(--green)">check_circle</span> 已完成</div>
                        <div class="tab" data-dltab="failed" onclick="switchDlTab('failed')"><span class="ms ms-sm" style="color:var(--red)">error</span> 失败</div>
                    </div>
                    <div id="dl-pending-content"></div>
                    <div id="dl-active-content" class="hidden"></div>
                    <div id="dl-completed-content" class="hidden"></div>
                    <div id="dl-failed-content" class="hidden"></div>
                </div>
                <!-- Workflow Parse Tab -->
                <div id="mtab-workflow" class="hidden">
                    <div id="wf-drop-zone" style="border:2px dashed var(--bd);border-radius:var(--r);padding:40px 20px;text-align:center;cursor:pointer;transition:border-color .2s,background .2s;margin-bottom:16px"
                         onclick="document.getElementById('wf-file-input').click()">
                        <span class="ms" style="font-size:48px;color:var(--t3);display:block;margin-bottom:12px">upload_file</span>
                        <p style="color:var(--t2);font-size:.9rem;margin-bottom:4px">拖拽 ComfyUI 生成的文件到此处</p>
                        <p style="color:var(--t3);font-size:.8rem">或点击选择文件 (支持图片 / 视频 / 音频 / 3D / 权重 / JSON)</p>
                        <input type="file" id="wf-file-input" accept=".png,.webp,.svg,.webm,.mp4,.flac,.mp3,.opus,.ogg,.glb,.safetensors,.latent,.json" style="display:none" onchange="handleWorkflowFile(this.files[0])">
                    </div>
                    <div id="wf-parse-status" style="display:none;margin-bottom:12px"></div>
                    <div id="wf-results" style="display:none">
                        <div id="wf-stat-bar" class="wf-stat-bar"></div>
                        <div class="wf-panels">
                            <div class="wf-panel">
                                <div class="wf-panel-header">
                                    <span class="ms" style="color:#a78bfa">inventory_2</span>
                                    <span>模型依赖</span>
                                    <span id="wf-models-count" class="wf-panel-count"></span>
                                </div>
                                <div id="wf-models-panel" class="wf-panel-body"></div>
                            </div>
                            <div class="wf-panel">
                                <div class="wf-panel-header">
                                    <span class="ms" style="color:var(--amber)">extension</span>
                                    <span>缺失插件</span>
                                    <span id="wf-plugins-count" class="wf-panel-count"></span>
                                </div>
                                <div id="wf-plugins-panel" class="wf-panel-body"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========== JupyterLab Page ========== -->
        <div id="page-jupyter" class="page hidden">
            <div class="page-header">
                <div class="page-title-group">
                    <h2><span class="ms" style="color:#fb923c">book_2</span> JupyterLab</h2>
                    <span id="jupyter-header-badge" class="page-status-badge"></span>
                </div>
                <div class="top-toolbar">
                    <span id="jupyter-header-controls"></span>
                    <button class="btn" onclick="openIEModal()" title="导入/导出配置"><span class="ms ms-sm" style="color:#94a3b8">tune</span> 配置</button>
                </div>
            </div>
            <div class="page-body">
                <!-- 状态 -->
                <div id="jupyter-status-content">
                    <div class="loading"><div class="spinner"></div><div>加载中...</div></div>
                </div>

                <!-- 访问令牌 -->
                <div class="section-header">
                    <div class="section-title"><span class="ms ms-sm" style="color:#fbbf24">key</span> 访问令牌</div>
                </div>
                <div class="card" style="padding:12px 14px">
                    <div class="input-secret">
                        <input type="password" id="jupyter-token-value" value="" readonly
                               style="font-family:'IBM Plex Mono',monospace;font-size:.78rem;letter-spacing:.02em;background:var(--bg3);border:1px solid var(--bd);border-radius:6px;padding:6px 10px;color:var(--t1)">
                        <button type="button" class="input-secret-toggle" onclick="toggleSecret(this)" title="显示"><span class="ms ms-sm">visibility</span></button>
                        <button type="button" class="input-secret-copy" onclick="copySecret(this)" title="复制"><span class="ms ms-sm">content_copy</span></button>
                    </div>
                </div>

                <!-- 活跃内核 -->
                <div id="jupyter-section-kernels" style="display:none">
                    <div class="section-header">
                        <div class="section-title"><span class="ms ms-sm" style="color:#22d3ee">memory</span> 活跃内核</div>
                    </div>
                    <div class="card" style="padding:10px 14px">
                        <div id="jupyter-kernels-list"></div>
                    </div>
                </div>

                <!-- 活跃会话 -->
                <div id="jupyter-section-sessions" style="display:none">
                    <div class="section-header">
                        <div class="section-title"><span class="ms ms-sm" style="color:#fbbf24">folder_open</span> 活跃会话</div>
                    </div>
                    <div class="card" style="padding:10px 14px">
                        <div id="jupyter-sessions-list"></div>
                    </div>
                </div>

                <!-- 终端 -->
                <div id="jupyter-section-terminals" style="display:none">
                    <div class="section-header">
                        <div class="section-title"><span class="ms ms-sm" style="color:#22d3ee">terminal</span> 终端</div>
                    </div>
                    <div class="card" style="padding:10px 14px">
                        <div id="jupyter-terminals-list"></div>
                    </div>
                </div>

                <!-- 日志 -->
                <div class="section-header">
                    <div class="section-title"><span class="ms ms-sm" style="color:#94a3b8">receipt_long</span> 日志</div>
                </div>
                <div class="card" style="padding:10px 14px">
                    <div class="log-box" id="jupyter-log-content">加载中...</div>
                </div>
            </div>
        </div>

        <!-- ========== Tunnel Page ========== -->
        <div id="page-tunnel" class="page hidden">
            <div class="page-header">
                <div class="page-title-group">
                    <h2><span class="ms" style="color:#60a5fa">language</span> Tunnel</h2>
                    <span id="tunnel-header-badge" class="page-status-badge"></span>
                </div>
                <div class="top-toolbar">
                    <span id="tunnel-header-controls"></span>
                    <button class="btn" onclick="openIEModal()" title="导入/导出配置"><span class="ms ms-sm" style="color:#94a3b8">tune</span> 配置</button>
                </div>
            </div>
            <div class="page-body">
                <!-- Sub-tabs -->
                <div class="tabs">
                    <div class="tab active" data-ttab="status" onclick="switchTunnelTab('status')"><span class="ms ms-sm" style="color:#60a5fa">link</span> 服务 & 日志</div>
                    <div class="tab" data-ttab="config" onclick="switchTunnelTab('config')"><span class="ms ms-sm" style="color:#94a3b8">settings</span> 配置</div>
                </div>

                <!-- Status Tab -->
                <div id="ttab-status">
                    <!-- 状态区 (已配置时) -->
                    <div id="tunnel-status-section" style="display:none">
                        <div class="section-header" style="margin-top:0">
                            <div class="section-title"><span class="ms ms-sm" style="color:#60a5fa">link</span> 服务</div>
                            <span id="tunnel-status-info" style="font-size:.78rem;color:var(--t3)"></span>
                        </div>
                        <div id="tunnel-services"></div>
                    </div>

                    <!-- 未配置时的提示 -->
                    <div id="tunnel-setup-hint" style="display:none">
                        <div class="card card-padded" style="text-align:center;padding:32px">
                            <div style="font-size:1.2rem;margin-bottom:8px"><span class="ms ms-xl" style="color:#60a5fa">language</span></div>
                            <div style="color:var(--t2);margin-bottom:12px">尚未配置 Tunnel，请前往「配置」tab 设置</div>
                            <div style="display:flex;gap:8px;justify-content:center">
                                <button class="btn btn-sm btn-primary" onclick="window._selectTunnelMode('public');switchTunnelTab('config')"><span class="ms ms-sm" style="color:#34d399">public</span> 一键启用公共节点</button>
                                <button class="btn btn-sm" onclick="switchTunnelTab('config')"><span class="ms ms-sm" style="color:#fb923c">build</span> 自定义配置</button>
                            </div>
                        </div>
                    </div>

                    <!-- 日志 -->
                    <div class="section-header">
                        <div class="section-title"><span class="ms ms-sm" style="color:#94a3b8">receipt_long</span> Tunnel 日志</div>
                    </div>
                    <div>
                        <div class="log-box" id="tunnel-log-content">加载中...</div>
                    </div>
                </div>

                <!-- Config Tab -->
                <div id="ttab-config" class="hidden">
                    <!-- 模式选择卡片 -->
                    <div id="tunnel-mode-selector" style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px">
                        <div class="card card-padded tunnel-mode-card" id="tunnel-mode-public" onclick="window._selectTunnelMode('public')" style="cursor:pointer;border:2px solid transparent;transition:border-color .2s">
                            <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
                                <span style="font-size:1.3rem"><span class="ms" style="color:#34d399">public</span></span>
                                <span style="font-weight:700;font-size:1rem">公共节点</span>
                                <span style="font-size:.65rem;background:var(--green);color:#000;padding:1px 6px;border-radius:8px;font-weight:600">推荐</span>
                            </div>
                            <p style="color:var(--t2);font-size:.82rem;margin:0 0 10px 0;line-height:1.5">
                                一键启用，无需域名或 CF 账号。通过 ComfyCarry 共享 Tunnel 服务获得公网访问。
                            </p>
                            <div id="tunnel-public-capacity" style="font-size:.75rem;color:var(--t3)">容量加载中...</div>
                        </div>
                        <div class="card card-padded tunnel-mode-card" id="tunnel-mode-custom" onclick="window._selectTunnelMode('custom')" style="cursor:pointer;border:2px solid transparent;transition:border-color .2s">
                            <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
                                <span style="font-size:1.3rem"><span class="ms" style="color:#fb923c">build</span></span>
                                <span style="font-weight:700;font-size:1rem">自定义 Tunnel</span>
                            </div>
                            <p style="color:var(--t2);font-size:.82rem;margin:0 0 10px 0;line-height:1.5">
                                使用自己的 Cloudflare 账号、API Token 和域名，完全自主控制。
                            </p>
                            <div style="font-size:.75rem;color:var(--t3)">需要 CF API Token + 域名</div>
                        </div>
                    </div>

                    <!-- 统一配置区域 (根据模式启用/禁用字段) -->
                    <div id="tunnel-config-details" style="display:none">
                        <div id="tunnel-config-banner" style="font-size:.78rem;color:var(--t3);margin-bottom:16px;padding:8px 12px;background:var(--bg2);border:1px solid var(--bd);border-radius:var(--r)"></div>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">
                            <!-- 传输协议 -->
                            <div class="card card-padded">
                                <div style="display:flex;flex-direction:column;gap:8px">
                                    <div style="display:flex;align-items:center;gap:6px">
                                        <label style="font-weight:600">传输协议</label>
                                        <span class="comfy-param-help-icon" data-tip="cloudflared 传输层协议。QUIC 可能不稳定，推荐 HTTP/2">?</span>
                                    </div>
                                    <select id="tunnel-cfg-protocol" style="width:100%;padding:8px;border-radius:var(--r);border:1px solid var(--bd);background:var(--bg2);color:var(--t1)">
                                        <option value="auto">Auto (默认)</option>
                                        <option value="http2">HTTP/2</option>
                                        <option value="quic">QUIC</option>
                                    </select>
                                </div>
                            </div>
                            <!-- CF API Token -->
                            <div class="card card-padded tunnel-cfg-custom-card">
                                <div style="display:flex;flex-direction:column;gap:8px">
                                    <div style="display:flex;align-items:center;gap:6px">
                                        <label style="font-weight:600">CF API Token</label>
                                        <span class="comfy-param-help-icon" data-tip="需要 Tunnel Edit + DNS Edit 权限">?</span>
                                        <span style="flex:1"></span>
                                        <button class="btn btn-xs" onclick="window._tunnelCfgValidate()" style="font-size:.7rem;padding:2px 8px">验证</button>
                                    </div>
                                    <div class="input-secret">
                                        <input type="password" id="tunnel-cfg-token" placeholder="CF Token">
                                        <button type="button" class="input-secret-toggle" onclick="toggleSecret(this)" title="显示"><span class="ms ms-sm">visibility</span></button>
                                    </div>
                                    <div id="tunnel-cfg-result" style="display:none;font-size:.78rem;margin:0"></div>
                                </div>
                            </div>
                        </div>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">
                            <!-- 域名 -->
                            <div class="card card-padded tunnel-cfg-custom-card">
                                <div style="display:flex;flex-direction:column;gap:8px">
                                    <div style="display:flex;align-items:center;gap:6px">
                                        <label style="font-weight:600">域名</label>
                                        <span class="comfy-param-help-icon" data-tip="必须已托管在 Cloudflare">?</span>
                                    </div>
                                    <input type="text" id="tunnel-cfg-domain" placeholder="mydomain.com">
                                </div>
                            </div>
                            <!-- 子域名前缀 -->
                            <div class="card card-padded tunnel-cfg-custom-card">
                                <div style="display:flex;flex-direction:column;gap:8px">
                                    <div style="display:flex;align-items:center;gap:6px">
                                        <label style="font-weight:600">子域名前缀</label>
                                        <span class="comfy-param-help-icon" data-tip="留空则随机生成">?</span>
                                    </div>
                                    <input type="text" id="tunnel-cfg-subdomain" placeholder="cc-a1b2c3d4">
                                </div>
                            </div>
                        </div>
                        <!-- 底部操作栏 -->
                        <div style="display:flex;gap:8px;align-items:center;justify-content:flex-end;margin-top:16px;padding:12px 0;border-top:1px solid var(--bd)">
                            <button class="btn btn-primary" id="tunnel-cfg-submit" onclick="window._tunnelSave()">保存</button>
                            <button class="btn btn-sm btn-danger" id="tunnel-disable-btn" onclick="window._tunnelDisable()" style="display:none">销毁 Tunnel</button>
                        </div>
                    </div><!-- /tunnel-config-details -->
                </div>
            </div>
        </div>

        <!-- 添加自定义服务弹窗 -->
        <div id="tunnel-addsvc-modal" class="modal-overlay" onclick="if(event.target===this){this.classList.remove('active')}">
            <div class="modal-box" style="width:clamp(400px,30vw,520px)">
                <h3><span class="ms ms-sm" style="color:#34d399">add</span> 添加自定义服务</h3>
                <div class="form-group">
                    <label>服务名称</label>
                    <input type="text" id="tunnel-addsvc-name" placeholder="如 MyApp">
                </div>
                <div class="form-group">
                    <label>本地端口</label>
                    <input type="number" id="tunnel-addsvc-port" placeholder="如 3000">
                </div>
                <div class="form-group">
                    <label>子域名后缀</label>
                    <input type="text" id="tunnel-addsvc-suffix" placeholder="如 app → subdomain-app.domain.com">
                    <div style="font-size:.72rem;color:var(--t3);margin-top:4px">生成域名: <code id="tunnel-addsvc-preview">...</code></div>
                </div>
                <div class="form-group">
                    <label>协议</label>
                    <select id="tunnel-addsvc-proto" style="width:100%;padding:8px;border-radius:var(--r);border:1px solid var(--bd);background:var(--bg2);color:var(--t1)">
                        <option value="http">HTTP</option>
                        <option value="https">HTTPS</option>
                        <option value="tcp">TCP</option>
                        <option value="ssh">SSH</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button class="btn btn-sm" onclick="document.getElementById('tunnel-addsvc-modal').classList.remove('active')">取消</button>
                    <button class="btn btn-sm btn-primary" onclick="window._tunnelAddServiceSubmit()">添加</button>
                </div>
            </div>
        </div>

        <!-- ========== ComfyUI Management Page ========== -->
        <div id="page-comfyui" class="page hidden">
            <div class="page-header">
                <div class="page-title-group">
                    <h2><span class="ms" style="color:#22d3ee">terminal</span> ComfyUI</h2>
                    <span id="comfyui-header-badge" class="page-status-badge"></span>
                </div>
                <div class="top-toolbar">
                    <span id="comfyui-header-controls"></span>
                    <button class="btn" onclick="openIEModal()" title="导入/导出配置"><span class="ms ms-sm" style="color:#94a3b8">tune</span> 配置</button>
                </div>
            </div>
            <div class="page-body">
                <!-- Sub-tabs -->
                <div class="tabs">
                    <div class="tab active" data-comfy-tab="console" onclick="switchComfyTab('console')"><span class="ms ms-sm" style="color:#22d3ee">terminal</span> 控制台</div>
                    <div class="tab" data-comfy-tab="queue" onclick="switchComfyTab('queue')"><span class="ms ms-sm" style="color:#fb923c">queue</span> 任务队列</div>
                    <div class="tab" data-comfy-tab="history" onclick="switchComfyTab('history')"><span class="ms ms-sm" style="color:#94a3b8">history</span> 生成历史</div>
                </div>

                <!-- Console sub-page (original content) -->
                <div id="comfy-tab-console">
                    <!-- 状态信息 -->
                    <div id="comfyui-status-cards" class="stat-grid">
                        <div class="loading"><div class="spinner"></div><div>加载中...</div></div>
                    </div>

                    <!-- 实时执行状态 -->
                    <div id="comfyui-exec-bar" class="hidden" style="margin-top:12px"></div>

                    <!-- 启动参数 -->
                    <div class="section-header">
                        <div class="section-title"><span class="ms ms-sm" style="color:#94a3b8">settings</span> 启动参数</div>
                        <div class="section-actions">
                            <span id="comfyui-params-status" style="font-size:.78rem;color:var(--t3)"></span>
                        </div>
                    </div>
                    <div style="margin-bottom:8px">
                        <input type="text" id="comfyui-args-raw" placeholder="main.py --listen 0.0.0.0 --port 8188 ..." style="font-family:'IBM Plex Mono',monospace;font-size:.78rem;width:100%">
                    </div>
                    <div id="comfyui-params-form" class="comfy-params-form">加载中...</div>

                    <!-- 日志 -->
                    <div class="section-header">
                        <div class="section-title"><span class="ms ms-sm" style="color:#94a3b8">receipt_long</span> ComfyUI 日志</div>
                    </div>
                    <div class="log-box" id="comfyui-log-content">加载中...</div>
                </div>

                <!-- Queue sub-page -->
                <div id="comfy-tab-queue" class="hidden">
                    <!-- 队列摘要 -->
                    <div style="margin-bottom:16px">
                        <span id="queue-summary" style="font-size:.82rem;color:var(--t3)"></span>
                    </div>

                    <!-- 正在执行 -->
                    <div class="section-header" style="margin-top:0">
                        <div class="section-title"><span class="ms ms-sm" style="color:#34d399">play_arrow</span> 正在执行</div>
                        <div class="section-actions">
                            <button class="btn btn-sm btn-danger" onclick="comfyInterrupt()">中断</button>
                        </div>
                    </div>
                    <div id="queue-running" style="margin-bottom:20px">
                        <div style="font-size:.85rem;color:var(--t3);padding:8px 0">无</div>
                    </div>

                    <!-- 等待队列 -->
                    <div class="section-header" style="margin-top:0">
                        <div class="section-title"><span class="ms ms-sm" style="color:var(--amber)">hourglass_top</span> 等待队列</div>
                        <div class="section-actions">
                            <button class="btn btn-sm" onclick="comfyClearQueue()">清空</button>
                        </div>
                    </div>
                    <div id="queue-pending" style="margin-bottom:20px">
                        <div style="font-size:.85rem;color:var(--t3);padding:8px 0">无</div>
                    </div>
                </div>

                <!-- History sub-page -->
                <div id="comfy-tab-history" class="hidden">
                    <div class="toolbar" style="margin-bottom:14px">
                        <span id="history-total" style="font-size:.82rem;color:var(--t3)"></span>
                        <div class="toolbar-spacer"></div>
                        <select id="history-sort-select" onchange="setHistorySort(this.value)" style="width:auto;min-width:100px">
                            <option value="desc" selected>新→旧</option>
                            <option value="asc">旧→新</option>
                        </select>
                        <select id="history-size-select" onchange="setHistorySize(this.value)" style="width:auto;min-width:100px">
                            <option value="sm">紧凑</option>
                            <option value="md" selected>标准</option>
                            <option value="lg">大图</option>
                        </select>
                    </div>
                    <div id="queue-history">
                        <div class="loading"><div class="spinner"></div><div>加载中...</div></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========== Plugins Page ========== -->
        <div id="page-plugins" class="page hidden">
            <div class="page-header">
                <h2><span class="ms" style="color:#a78bfa">extension</span> 插件管理</h2>
                <div class="top-toolbar">
                    <button class="btn" onclick="openIEModal()" title="导入/导出配置"><span class="ms ms-sm" style="color:#94a3b8">tune</span> 配置</button>
                </div>
            </div>
            <div class="page-body">
                <div class="tabs">
                    <div class="tab active" data-ptab="installed" onclick="switchPluginTab('installed')"><span class="ms ms-sm" style="color:#a78bfa">inventory_2</span> 已安装</div>
                    <div class="tab" data-ptab="browse" onclick="switchPluginTab('browse')"><span class="ms ms-sm" style="color:#60a5fa">search</span> 浏览</div>
                    <div class="tab" data-ptab="git" onclick="switchPluginTab('git')"><span class="ms ms-sm" style="color:#60a5fa">link</span> Git 安装</div>
                    <span id="plugin-queue-indicator" class="hidden" style="font-size:.78rem;color:var(--amber);margin-left:auto"><span class="ms ms-sm" style="color:var(--amber)">hourglass_top</span> 队列处理中...</span>
                </div>
                <!-- Installed Plugins Tab -->
                <div id="ptab-installed">
                    <div class="toolbar">
                        <input type="text" id="plugin-installed-filter" placeholder="筛选已安装插件..." oninput="filterInstalledPlugins()" style="flex:1;max-width:400px">
                        <select id="plugin-installed-status" onchange="filterInstalledPlugins()" style="width:auto;min-width:120px">
                            <option value="all">全部状态</option>
                            <option value="enabled">已启用</option>
                            <option value="disabled">已禁用</option>
                            <option value="update">有更新</option>
                        </select>
                        <div class="toolbar-spacer"></div>
                        <button class="btn btn-sm" onclick="loadPluginsPage()">刷新</button>
                        <button class="btn btn-sm" onclick="window._checkPluginUpdates()" title="强制 ComfyUI-Manager 重新检查所有插件更新 (耗时较长)">检查更新</button>
                        <button class="btn btn-sm btn-primary" onclick="updateAllPlugins()">全部更新</button>
                    </div>
                    <div id="plugin-installed-stats" style="font-size:.82rem;color:var(--t2);margin-bottom:12px"></div>
                    <div id="plugin-installed-list"></div>
                </div>
                <!-- Browse/Search Plugins Tab -->
                <div id="ptab-browse" class="hidden">
                    <div class="toolbar">
                        <input type="text" id="plugin-search-input" placeholder="搜索插件名称或描述..." onkeydown="if(event.key==='Enter')searchPlugins()" style="flex:1;max-width:500px">
                        <button class="btn btn-sm btn-primary" onclick="searchPlugins()">搜索</button>
                        <div class="toolbar-spacer"></div>
                        <select id="plugin-browse-sort" onchange="searchPlugins()" style="width:auto;min-width:120px">
                            <option value="stars">按热度</option>
                            <option value="update">最近更新</option>
                            <option value="name">按名称</option>
                        </select>
                    </div>
                    <div id="plugin-browse-stats" style="font-size:.82rem;color:var(--t2);margin-bottom:12px"></div>
                    <div id="plugin-browse-list"></div>
                    <div id="plugin-browse-more" style="text-align:center;margin-top:16px" class="hidden">
                        <button class="btn btn-sm" onclick="loadMoreBrowsePlugins()">加载更多...</button>
                    </div>
                </div>
                <!-- Git Install Tab -->
                <div id="ptab-git" class="hidden">
                    <div class="card card-padded">
                        <h3 style="margin-bottom:12px;font-size:clamp(0.95rem,1.1vw,1.15rem)"><span class="ms ms-sm" style="color:#60a5fa">link</span> 通过 Git URL 安装插件</h3>
                        <p style="font-size:.82rem;color:var(--t2);margin-bottom:12px">输入插件的 GitHub 仓库地址，直接克隆并安装</p>
                        <div style="display:flex;gap:8px;margin-bottom:12px">
                            <input type="text" id="plugin-git-url" placeholder="https://github.com/author/ComfyUI-Plugin" style="flex:1">
                            <button class="btn btn-primary" onclick="installPluginFromGit()" id="plugin-git-btn" style="padding:8px 20px">安装</button>
                        </div>
                        <div id="plugin-git-status"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========== Cloud Sync Page ========== -->
        <div id="page-sync" class="page hidden">
            <div class="page-header">
                <div class="page-title-group">
                    <h2><span class="ms" style="color:#34d399">cloud_sync</span> Sync</h2>
                    <span id="sync-header-badge" class="page-status-badge"></span>
                </div>
                <div class="top-toolbar">
                    <span id="sync-header-controls"></span>
                    <button class="btn" onclick="openIEModal()" title="导入/导出配置"><span class="ms ms-sm" style="color:#94a3b8">tune</span> 配置</button>
                </div>
            </div>
            <div class="page-body">
                <!-- Sub-tabs -->
                <div class="tabs">
                    <div class="tab active" data-stab="remotes" onclick="switchSyncTab('remotes')"><span class="ms ms-sm" style="color:#60a5fa">storage</span> 存储 & 日志</div>
                    <div class="tab" data-stab="rules" onclick="switchSyncTab('rules')"><span class="ms ms-sm" style="color:#34d399">sync</span> 同步规则</div>
                    <div class="tab" data-stab="config" onclick="switchSyncTab('config')"><span class="ms ms-sm" style="color:#94a3b8">settings</span> 配置</div>
                </div>

                <!-- Storage + Logs Tab -->
                <div id="stab-remotes">
                    <div id="sync-remotes-grid" class="sync-remotes-grid">
                        <div class="loading"><div class="spinner"></div><div>加载中...</div></div>
                    </div>

                    <!-- Inline Logs -->
                    <div class="section-header">
                        <div class="section-title"><span class="ms ms-sm" style="color:#94a3b8">receipt_long</span> 同步日志</div>
                    </div>
                    <div>
                        <div id="sync-log-content" class="sync-log-box">加载中...</div>
                    </div>
                </div>

                <!-- Rules Tab -->
                <div id="stab-rules" class="hidden">
                    <div id="sync-rules-list"></div>
                </div>

                <!-- Config Tab -->
                <div id="stab-config" class="hidden">
                    <!-- 同步设置: 两张卡片并排 -->
                    <div class="section-header" style="margin-top:0">
                        <div class="section-title"><span class="ms ms-sm" style="color:#fb923c">timer</span> 同步设置</div>
                    </div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px">
                        <div class="card card-padded">
                            <div style="display:flex;align-items:center;justify-content:space-between;gap:16px">
                                <div style="flex:1">
                                    <label style="font-weight:600;display:block;margin-bottom:4px">文件稳定延迟</label>
                                    <p style="color:var(--t2);font-size:.78rem;margin:0;line-height:1.4">推送文件时跳过修改时间不足此秒数的文件，防止复制不完整文件</p>
                                </div>
                                <div style="display:flex;align-items:center;gap:6px;flex-shrink:0">
                                    <input type="number" id="cfg-min-age" min="0" max="300" value="30" style="width:72px;text-align:center">
                                    <span style="color:var(--t3);font-size:.78rem">秒</span>
                                </div>
                            </div>
                        </div>
                        <div class="card card-padded">
                            <div style="display:flex;align-items:center;justify-content:space-between;gap:16px">
                                <div style="flex:1">
                                    <label style="font-weight:600;display:block;margin-bottom:4px">检查间隔</label>
                                    <p style="color:var(--t2);font-size:.78rem;margin:0;line-height:1.4">Worker 每隔多少秒检查一次文件变化并执行同步</p>
                                </div>
                                <div style="display:flex;align-items:center;gap:6px;flex-shrink:0">
                                    <input type="number" id="cfg-watch-interval" min="5" max="3600" value="60" style="width:72px;text-align:center">
                                    <span style="color:var(--t3);font-size:.78rem">秒</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Rclone 配置编辑 -->
                    <div class="section-header">
                        <div class="section-title"><span class="ms ms-sm" style="color:#94a3b8">description</span> Rclone 配置</div>
                    </div>
                    <textarea id="rclone-config-editor" class="rclone-config-editor" spellcheck="false" placeholder="加载中..."></textarea>

                    <!-- 底部操作栏 -->
                    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:16px;padding:12px 0">
                        <label class="btn" style="cursor:pointer">
                            <span class="ms ms-sm" style="color:#60a5fa">upload</span> 上传本地文件
                            <input type="file" accept=".conf,.txt" onchange="uploadRcloneFile(event)" style="display:none">
                        </label>
                        <button class="btn btn-primary" onclick="saveSyncConfigAll()">保存</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========== SSH Page ========== -->
        <div id="page-ssh" class="page hidden">
            <div class="page-header">
                <div class="page-title-group">
                    <h2><span class="ms" style="color:#fbbf24">key</span> SSH</h2>
                    <span id="ssh-header-badge" class="page-status-badge"></span>
                </div>
                <div class="top-toolbar">
                    <span id="ssh-header-controls"></span>
                    <button class="btn" onclick="openIEModal()" title="导入/导出配置"><span class="ms ms-sm" style="color:#94a3b8">tune</span> 配置</button>
                </div>
            </div>
            <div class="page-body">
                <!-- Sub-tabs -->
                <div class="tabs">
                    <div class="tab active" data-sshtab="status" onclick="window.switchSSHTab('status')"><span class="ms ms-sm" style="color:#60a5fa">link</span> 服务 & 日志</div>
                    <div class="tab" data-sshtab="config" onclick="window.switchSSHTab('config')"><span class="ms ms-sm" style="color:#94a3b8">settings</span> 密钥 & 密码</div>
                </div>

                <!-- Status Tab -->
                <div id="sshtab-status">
                    <!-- 状态卡片 -->
                    <div id="ssh-status-cards" class="stat-grid">
                        <div class="loading"><div class="spinner"></div><div>加载中...</div></div>
                    </div>

                    <!-- SSH 连接命令 -->
                    <div class="section-header" style="margin-top:0">
                        <div class="section-title"><span class="ms ms-sm" style="color:#60a5fa">content_paste</span> 连接命令</div>
                    </div>
                    <div class="card" style="padding:12px 14px">
                        <div id="ssh-connect-cmd">
                            <div style="color:var(--t3);font-size:.85rem">加载中...</div>
                        </div>
                    </div>

                    <!-- 日志 -->
                    <div class="section-header">
                        <div class="section-title"><span class="ms ms-sm" style="color:#94a3b8">receipt_long</span> SSH 日志</div>
                    </div>
                    <div>
                        <div class="log-box" id="ssh-log-content">加载中...</div>
                    </div>
                </div>

                <!-- Config Tab -->
                <div id="sshtab-config" class="hidden">
                    <div class="ssh-auth-grid">
                        <!-- 公钥管理 -->
                        <div>
                            <div class="section-header" style="margin-top:0">
                                <div class="section-title"><span class="ms ms-sm" style="color:#fbbf24">lock</span> 授权公钥</div>
                            </div>
                            <div id="ssh-keys-list">
                                <div style="color:var(--t3);font-size:.85rem;padding:12px 0">加载中...</div>
                            </div>
                        </div>

                        <!-- Root 密码 -->
                        <div>
                            <div class="section-header" style="margin-top:0">
                                <div class="section-title"><span class="ms ms-sm" style="color:#fbbf24">lock</span> Root 密码</div>
                            </div>
                            <div class="card" style="padding:14px">
                                <div style="display:flex;flex-direction:column;gap:10px">
                                    <div class="input-secret">
                                        <input type="password" id="ssh-pw-new" placeholder="新密码"
                                               style="font-size:.85rem;background:var(--bg);border:1px solid var(--bd);border-radius:6px;padding:8px 12px;color:var(--t1)">
                                        <button type="button" class="input-secret-toggle" onclick="toggleSecret(this)" title="显示"><span class="ms ms-sm">visibility</span></button>
                                    </div>
                                    <div class="input-secret">
                                        <input type="password" id="ssh-pw-confirm" placeholder="确认密码"
                                               style="font-size:.85rem;background:var(--bg);border:1px solid var(--bd);border-radius:6px;padding:8px 12px;color:var(--t1)">
                                        <button type="button" class="input-secret-toggle" onclick="toggleSecret(this)" title="显示"><span class="ms ms-sm">visibility</span></button>
                                    </div>
                                    <div style="display:flex;align-items:center;justify-content:space-between">
                                        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;user-select:none">
                                            <input type="checkbox" id="ssh-pw-sync" onchange="window._toggleSSHPwSync()" style="width:15px;height:15px">
                                            <span style="font-size:.82rem">使用 ComfyCarry 密码</span>
                                        </label>
                                        <button class="btn btn-sm btn-primary" id="ssh-pw-submit-btn" onclick="window.setSSHPassword()">设置密码</button>
                                    </div>
                                    <span class="comfy-param-help-icon" data-tip="设置后将自动启用密码认证、PermitRootLogin 并重启 sshd">?</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========== Settings Page ========== -->
        <div id="page-settings" class="page hidden">
            <div class="page-header">
                <h2><span class="ms" style="color:#94a3b8">settings</span> 设置</h2>
                <div class="top-toolbar">
                    <button class="btn" onclick="restartDashboard()"><span class="ms ms-sm" style="color:#34d399">refresh</span> 重启</button>
                    <button class="btn" onclick="openIEModal()" title="导入/导出配置"><span class="ms ms-sm" style="color:#94a3b8">tune</span> 配置</button>
                </div>
            </div>
            <div class="page-body">
                <div class="settings-grid">
                    <!-- 左列: 配置卡片 -->
                    <div class="settings-col">
                        <!-- 密码设置 -->
                        <div class="card card-padded">
                            <h3><span class="ms ms-sm" style="color:#fbbf24">lock</span> ComfyCarry 密码</h3>
                            <form onsubmit="event.preventDefault();changePassword()" autocomplete="off">
                            <div class="form-group" style="margin-bottom:10px">
                                <label>当前密码</label>
                                <div class="input-secret">
                                    <input type="password" id="settings-pw-current" placeholder="输入当前密码" autocomplete="current-password">
                                    <button type="button" class="input-secret-toggle" onclick="toggleSecret(this)" title="显示"><span class="ms ms-sm">visibility</span></button>
                                </div>
                            </div>
                            <div class="form-group" style="margin-bottom:10px">
                                <label>新密码</label>
                                <div class="input-secret">
                                    <input type="password" id="settings-pw-new" placeholder="输入新密码 (至少 4 个字符)" autocomplete="new-password">
                                    <button type="button" class="input-secret-toggle" onclick="toggleSecret(this)" title="显示"><span class="ms ms-sm">visibility</span></button>
                                </div>
                            </div>
                            <div class="form-group" style="margin-bottom:12px">
                                <label>确认新密码</label>
                                <div class="input-secret">
                                    <input type="password" id="settings-pw-confirm" placeholder="再次输入新密码" autocomplete="new-password">
                                    <button type="button" class="input-secret-toggle" onclick="toggleSecret(this)" title="显示"><span class="ms ms-sm">visibility</span></button>
                                </div>
                            </div>
                            <div style="display:flex;justify-content:flex-end"><button type="submit" class="btn btn-sm btn-primary">更新密码</button></div>
                            </form>
                        </div>

                        <!-- CivitAI API Key -->
                        <div class="card card-padded">
                            <h3><span class="ms ms-sm" style="color:#f472b6">palette</span> CivitAI API Key</h3>
                            <div class="form-group" style="margin-bottom:12px">
                                <label>API Key 从 <a href="https://civitai.com/user/account" target="_blank" style="color:var(--ac)">CivitAI 账户设置</a> 中生成</label>
                                <div class="input-secret">
                                    <input type="password" id="settings-civitai-key" placeholder="输入 CivitAI API Key...">
                                    <button type="button" class="input-secret-toggle" onclick="toggleSecret(this)" title="显示"><span class="ms ms-sm">visibility</span></button>
                                </div>
                            </div>
                            <div style="display:flex;gap:8px;justify-content:flex-end">
                                <button class="btn btn-sm btn-primary" onclick="saveSettingsCivitaiKey()">保存</button>
                                <button class="btn btn-sm btn-danger" onclick="clearSettingsCivitaiKey()" title="清除"><span class="ms ms-sm">delete</span></button>
                            </div>
                        </div>

                        <!-- ComfyCarry API Key -->
                        <div class="card card-padded">
                            <h3><span class="ms ms-sm" style="color:#fbbf24">key</span> ComfyCarry API Key <span class="comfy-param-help-icon" data-tip="用于外部脚本或应用通过 X-API-Key / Bearer 方式访问 API">?</span></h3>
                            <div class="input-secret" style="margin-bottom:12px">
                                <input type="password" id="settings-api-key" readonly style="font-family:monospace;font-size:.82rem;letter-spacing:.5px">
                                <button type="button" class="input-secret-toggle" onclick="toggleSecret(this)" title="显示"><span class="ms ms-sm">visibility</span></button>
                                <button type="button" class="input-secret-copy" onclick="copySecret(this)" title="复制"><span class="ms ms-sm">content_copy</span></button>
                            </div>
                            <div style="display:flex;justify-content:flex-end"><button class="btn btn-sm btn-danger" onclick="regenerateApiKey()">重新生成</button></div>
                        </div>



                        <!-- 重新初始化 -->
                        <div class="card card-padded" style="border:1px solid rgba(255,80,80,0.25)">
                            <h3 style="color:var(--red)"><span class="ms ms-sm" style="color:var(--amber)">warning</span> 重新初始化 <span class="comfy-param-help-icon" data-tip="删除 ComfyUI 并重新进入部署向导。系统依赖和 PyTorch 保留">?</span></h3>
                            <div style="display:flex;align-items:center;justify-content:space-between">
                                <label style="font-size:.82rem;color:var(--t2);display:flex;align-items:center;gap:6px;cursor:pointer">
                                    <input type="checkbox" id="reinit-keep-models" checked style="width:15px;height:15px;accent-color:var(--ac)">
                                    <span>保留模型文件</span>
                                </label>
                                <button class="btn btn-sm btn-danger" onclick="reinitialize()">重新初始化</button>
                            </div>
                        </div>
                    </div>

                    <!-- 右列: ComfyCarry 日志 (Debug 模式) -->
                    <div class="card card-padded" id="settings-log-card" style="height:100%;min-height:400px;max-height:calc(100vh - 160px)">
                        <h3 style="margin-bottom:12px"><span class="ms ms-sm" style="color:#94a3b8">receipt_long</span> ComfyCarry 日志</h3>
                        <div class="log-box" id="log-content" style="max-height:calc(100% - 50px);height:calc(100% - 50px)">加载中...</div>
                    </div>
                </div>
            </div>
        </div>

    </div><!-- /content -->

    <!-- Metadata Modal -->
    <div class="modal-overlay" id="meta-modal" onclick="if(event.target===this)closeMetaModal()">
        <div class="modal-box meta-modal-box">
            <div class="meta-header">
                <h3 id="meta-title">模型详情</h3>
                <button class="btn btn-sm" onclick="closeMetaModal()" style="margin-left:auto"><span class="ms ms-sm" style="color:var(--red)">close</span></button>
            </div>
            <div id="meta-body"></div>
        </div>
    </div>

    <!-- Version Picker Modal -->
    <div class="modal-overlay" id="version-picker-modal" onclick="if(event.target===this)closeVersionPicker()">
        <div class="modal-box" style="width:480px">
            <h3 id="vp-title">选择版本</h3>
            <div id="vp-body"></div>
        </div>
    </div>

    <!-- Image Modal -->
    <div class="modal-overlay" id="img-modal" onclick="this.classList.remove('active')"><img id="modal-img" src=""
            style="max-width:90vw;max-height:90vh;border-radius:var(--r);object-fit:contain"></div>

    <!-- Plugin Version Modal -->
    <div class="modal-overlay" id="plugin-version-modal" onclick="if(event.target===this)closePluginVersionModal()">
        <div class="modal-box" style="width:500px">
            <div style="display:flex;align-items:center;margin-bottom:16px">
                <h3 id="pv-title" style="margin-bottom:0">选择插件版本</h3>
                <button class="btn btn-sm" onclick="closePluginVersionModal()" style="margin-left:auto"><span class="ms ms-sm" style="color:var(--red)">close</span></button>
            </div>
            <div id="pv-body"></div>
        </div>
    </div>

    <!-- Import/Export Modal -->
    <div class="modal-overlay" id="ie-modal" onclick="if(event.target===this)closeIEModal()">
        <div class="ie-modal-box">
            <div style="display:flex;align-items:center;margin-bottom:16px">
                <h3 style="margin-bottom:0"><span class="ms ms-sm" style="color:#a78bfa">package_2</span> 导入/导出配置</h3>
                <button class="btn btn-sm" onclick="closeIEModal()" style="margin-left:auto"><span class="ms ms-sm" style="color:var(--red)">close</span></button>
            </div>
            <div class="ie-section">
                <h4><span class="ms ms-sm" style="color:#60a5fa">upload</span> 导出配置</h4>
                <p>导出当前 ComfyCarry 的密码、CivitAI 密钥、同步偏好等配置为 JSON 文件</p>
                <button class="btn btn-sm btn-primary" onclick="exportConfig()">导出配置文件</button>
            </div>
            <div class="ie-section">
                <h4><span class="ms ms-sm" style="color:#60a5fa">download</span> 导入配置</h4>
                <p>从之前导出的 JSON 文件恢复配置</p>
                <label class="btn btn-sm btn-primary" style="cursor:pointer;display:inline-block">
                    选择文件导入
                    <input type="file" accept=".json" onchange="importConfig(event)" style="display:none">
                </label>
            </div>
        </div>
    </div>

    <!-- Add Remote Modal -->
    <div class="modal-overlay" id="add-remote-modal" onclick="if(event.target===this)closeSyncModal('add-remote-modal')">
        <div class="modal-box" style="width:520px">
            <div style="display:flex;align-items:center;margin-bottom:16px">
                <h3 id="add-remote-title" style="margin-bottom:0">添加存储服务</h3>
                <button class="btn btn-sm" onclick="closeSyncModal('add-remote-modal')" style="margin-left:auto"><span class="ms ms-sm" style="color:var(--red)">close</span></button>
            </div>
            <div id="add-remote-body"></div>
            <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:16px">
                <button class="btn btn-sm" onclick="closeSyncModal('add-remote-modal')">取消</button>
                <button class="btn btn-sm btn-primary" onclick="submitAddRemote()">创建</button>
            </div>
        </div>
    </div>

    <!-- Add Rule Modal -->
    <div class="modal-overlay" id="add-rule-modal" onclick="if(event.target===this)closeSyncModal('add-rule-modal')">
        <div class="modal-box" style="width:600px">
            <div style="display:flex;align-items:center;margin-bottom:16px">
                <h3 id="add-rule-title" style="margin-bottom:0">添加同步规则</h3>
                <button class="btn btn-sm" onclick="closeSyncModal('add-rule-modal')" style="margin-left:auto"><span class="ms ms-sm" style="color:var(--red)">close</span></button>
            </div>
            <div id="add-rule-body"></div>
            <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:16px">
                <button class="btn btn-sm" onclick="closeSyncModal('add-rule-modal')">取消</button>
                <button class="btn btn-sm btn-primary" onclick="submitAddRule()">保存</button>
            </div>
        </div>
    </div>

    <!-- Remote Browse Modal (tree-style directory picker) -->
    <div class="modal-overlay" id="remote-browse-modal" onclick="if(event.target===this)closeSyncModal('remote-browse-modal')" style="z-index:1002">
        <div class="modal-box" style="width:480px;max-height:70vh;display:flex;flex-direction:column">
            <div style="display:flex;align-items:center;margin-bottom:12px">
                <h3 style="margin-bottom:0" id="browse-modal-title"><span class="ms ms-sm" style="color:#fbbf24">folder_open</span> 浏览目录</h3>
                <button class="btn btn-sm" onclick="closeSyncModal('remote-browse-modal')" style="margin-left:auto"><span class="ms ms-sm" style="color:var(--red)">close</span></button>
            </div>
            <div id="browse-breadcrumb" style="font-size:.78rem;color:var(--t2);margin-bottom:8px;word-break:break-all"></div>
            <div id="browse-tree" style="flex:1;overflow-y:auto;min-height:200px;max-height:45vh;border:1px solid var(--bd);border-radius:8px;padding:4px"></div>
            <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
                <button class="btn btn-sm" onclick="closeSyncModal('remote-browse-modal')">取消</button>
                <button class="btn btn-sm btn-primary" onclick="window._browseSelect()">选择当前目录</button>
            </div>
        </div>
    </div>

    <!-- Scroll-to-top FAB -->
    <button class="scroll-top-fab" id="scroll-top-fab" onclick="document.querySelector('.content').scrollTo({top:0,behavior:'smooth'})" title="返回顶部">↑</button>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <!-- Global utility functions -->
    <script>
        function toggleSecret(btn) {
            const input = btn.closest('.input-secret').querySelector('input');
            const hidden = input.type === 'password';
            if (input.dataset.key) {
                // pre-filled readonly field — swap value between key and dots
                if (hidden) {
                    input.type = 'text';
                    input.value = input.dataset.key;
                } else {
                    input.type = 'password';
                    input.value = '\u2022'.repeat(24);
                }
            } else {
                input.type = hidden ? 'text' : 'password';
            }
            btn.querySelector('.ms').textContent = hidden ? 'visibility_off' : 'visibility';
            btn.title = hidden ? '隐藏' : '显示';
        }
        function copySecret(btn) {
            const input = btn.closest('.input-secret').querySelector('input');
            const text = input.dataset.key || input.value;
            navigator.clipboard.writeText(text);
            if (window.showToast) showToast('已复制');
        }
    </script>
    <script type="module" src="/static/js/main.js"></script>
</body>

</html>
