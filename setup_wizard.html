<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ComfyCarry - éƒ¨ç½²å‘å¯¼</title>
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link
        href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&family=IBM+Plex+Sans+SC:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg1: #0a0a0f;
            --bg2: #12121e;
            --bg3: #1a1a28;
            --bg4: #22223a;
            --bd: #2a2a3e;
            --t1: #e8e8f0;
            --t2: #a8a8c0;
            --t3: #68688a;
            --accent: #7c5cfc;
            --accent2: #9078ff;
            --green: #4ade80;
            --red: #f87171;
            --r: 12px;
            --mono: 'IBM Plex Mono', 'Fira Code', monospace;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'IBM Plex Sans', 'IBM Plex Sans SC', -apple-system, sans-serif;
            background: var(--bg1);
            color: var(--t1);
            min-height: 100vh;
            font-size: clamp(15px, 1vw, 18px);
        }

        .wizard-container {
            max-width: 960px;
            margin: 0 auto;
            padding: clamp(24px, 4vw, 60px) clamp(16px, 3vw, 40px);
        }

        .wizard-header {
            text-align: center;
            margin-bottom: clamp(24px, 3vw, 48px);
        }

        .wizard-header h1 {
            font-size: clamp(1.6rem, 2.5vw, 2.4rem);
            font-weight: 700;
            background: linear-gradient(135deg, #7c5cfc, #e879f9);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .wizard-header p {
            color: var(--t3);
            font-size: clamp(0.85rem, 1vw, 1.05rem);
            margin-top: 8px;
        }

        /* Progress bar */
        .progress-bar {
            display: flex;
            gap: 6px;
            margin-bottom: clamp(24px, 3vw, 40px);
        }

        .progress-segment {
            flex: 1;
            height: 5px;
            border-radius: 3px;
            background: var(--bg4);
            transition: background .3s;
        }

        .progress-segment.done {
            background: var(--accent);
        }

        .progress-segment.active {
            background: var(--accent2);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1
            }

            50% {
                opacity: .5
            }
        }

        /* Steps */
        .step {
            display: none;
        }

        .step.active {
            display: block;
        }

        .step-title {
            font-size: clamp(1.1rem, 1.5vw, 1.5rem);
            font-weight: 600;
            margin-bottom: 8px;
        }

        .step-desc {
            color: var(--t2);
            font-size: clamp(0.88rem, 1vw, 1.05rem);
            margin-bottom: 24px;
            line-height: 1.6;
        }

        /* Cards for selection */
        .choice-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 24px;
        }

        .choice-grid.rclone-cards {
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        }

        .choice-grid.rclone-cards .choice-card {
            padding: clamp(12px, 1.5vw, 20px);
        }

        .choice-grid.rclone-cards .choice-card h3 {
            font-size: clamp(.88rem, 1vw, 1.05rem);
            margin-bottom: 4px;
        }

        .choice-grid.rclone-cards .choice-card p {
            font-size: clamp(.75rem, .85vw, .88rem);
        }

        .choice-card {
            background: var(--bg3);
            border: 2px solid var(--bd);
            border-radius: var(--r);
            padding: clamp(16px, 2vw, 28px);
            cursor: pointer;
            transition: all .2s;
            position: relative;
        }

        .choice-card:hover {
            border-color: var(--accent);
        }

        .choice-card.selected {
            border-color: var(--accent);
            background: color-mix(in srgb, var(--accent) 10%, var(--bg3));
        }

        .choice-card h3 {
            font-size: clamp(0.95rem, 1.1vw, 1.15rem);
            margin-bottom: 8px;
        }

        .choice-card p {
            font-size: clamp(0.82rem, 0.95vw, 1rem);
            color: var(--t3);
            line-height: 1.5;
        }

        .choice-card .badge {
            display: inline-block;
            font-size: clamp(0.65rem, 0.7vw, 0.78rem);
            background: var(--accent);
            color: #fff;
            padding: 2px 8px;
            border-radius: 4px;
            margin-left: 6px;
        }

        /* Form inputs */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-size: clamp(0.88rem, 1vw, 1.05rem);
            color: var(--t2);
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: clamp(10px, 1.2vw, 16px) clamp(14px, 1.5vw, 20px);
            background: var(--bg2);
            color: var(--t1);
            border: 1px solid var(--bd);
            border-radius: 10px;
            font-size: clamp(0.9rem, 1vw, 1.05rem);
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            border-color: var(--accent);
            outline: none;
        }

        .form-group textarea {
            min-height: 100px;
            font-family: var(--mono);
            font-size: clamp(0.82rem, 0.9vw, 0.95rem);
            resize: vertical;
        }

        .form-hint {
            font-size: clamp(0.78rem, 0.85vw, 0.92rem);
            color: var(--t3);
            margin-top: 6px;
            line-height: 1.5;
        }

        /* Buttons */
        .btn-row {
            display: flex;
            gap: 14px;
            margin-top: 28px;
        }

        .btn {
            padding: clamp(10px, 1.3vw, 16px) clamp(24px, 2.5vw, 36px);
            border: none;
            border-radius: 10px;
            font-size: clamp(0.92rem, 1vw, 1.1rem);
            cursor: pointer;
            font-weight: 600;
            transition: all .15s;
        }

        .btn-primary {
            background: var(--accent);
            color: #fff;
        }

        .btn-primary:hover {
            background: var(--accent2);
        }

        .btn-secondary {
            background: var(--bg4);
            color: var(--t2);
        }

        .btn-secondary:hover {
            background: var(--bd);
        }

        .btn-lg {
            padding: clamp(14px, 1.5vw, 20px) clamp(32px, 3vw, 48px);
            font-size: clamp(1rem, 1.2vw, 1.2rem);
        }

        .btn:disabled {
            opacity: .5;
            cursor: not-allowed;
        }

        /* Plugin list */
        .plugin-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--bd);
            border-radius: var(--r);
        }

        .plugin-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: clamp(10px, 1.2vw, 16px) clamp(14px, 1.5vw, 20px);
            border-bottom: 1px solid var(--bd);
            font-size: clamp(0.88rem, 1vw, 1.05rem);
        }

        .plugin-item:last-child {
            border-bottom: none;
        }

        .plugin-item input[type="checkbox"] {
            accent-color: var(--accent);
            width: 18px;
            height: 18px;
        }

        .plugin-item .plugin-name {
            flex: 1;
        }

        .plugin-item .plugin-required {
            font-size: clamp(0.7rem, 0.8vw, 0.85rem);
            color: var(--accent);
        }

        /* Radio group for rclone */
        .radio-group {
            display: flex;
            gap: 16px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .radio-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: clamp(0.88rem, 1vw, 1.05rem);
            color: var(--t2);
            cursor: pointer;
        }

        .radio-group input[type="radio"] {
            accent-color: var(--accent);
            width: 16px;
            height: 16px;
        }

        /* Environment info card */
        .env-card {
            background: var(--bg3);
            border: 1px solid var(--bd);
            border-radius: var(--r);
            padding: clamp(14px, 1.5vw, 24px);
            margin-bottom: 20px;
        }

        .env-card .env-row {
            display: flex;
            align-items: baseline;
            gap: 8px;
        }

        .env-card .env-row+.env-row {
            margin-top: 8px;
        }

        .env-card .env-label {
            color: var(--t3);
            font-size: .82rem;
            min-width: 60px;
            white-space: nowrap;
        }

        .env-card .env-value {
            font-weight: 600;
            font-size: clamp(.92rem, 1vw, 1.1rem);
        }

        .env-card .env-divider {
            border: none;
            border-top: 1px solid var(--bd);
            margin: 10px 0;
        }

        .env-card .env-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 4px;
        }

        .env-card .env-tag {
            font-size: .75rem;
            padding: 2px 8px;
            border-radius: 10px;
            background: var(--bg4);
            color: var(--t2);
            border: 1px solid var(--bd);
        }

        .env-card .env-tag.green {
            color: var(--green);
            border-color: var(--green);
        }

        /* Password input wrapper */
        .pw-wrap {
            position: relative;
        }

        .pw-wrap input {
            padding-right: 42px;
        }

        .pw-toggle {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--t3);
            cursor: pointer;
            font-size: 1.1rem;
            padding: 4px;
        }

        .pw-toggle:hover {
            color: var(--t1);
        }

        .pw-mismatch {
            color: var(--red);
            font-size: .82rem;
            margin-top: 4px;
            display: none;
        }

        /* Help tooltip */
        .help-tip {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            border: 1px solid var(--bd);
            font-size: .75rem;
            color: var(--t3);
            cursor: help;
            vertical-align: middle;
            position: relative;
        }

        .help-tip:hover {
            color: var(--accent);
            border-color: var(--accent);
        }

        .help-tip:hover::after {
            content: attr(title);
            position: absolute;
            bottom: 130%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg2);
            color: var(--t1);
            border: 1px solid var(--bd);
            border-radius: 8px;
            padding: 10px 14px;
            font-size: .82rem;
            line-height: 1.5;
            white-space: normal;
            width: 280px;
            z-index: 100;
            pointer-events: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, .3);
        }

        .help-tip:hover::before {
            content: '';
            position: absolute;
            bottom: 120%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: var(--bd);
            z-index: 101;
        }

        /* Deploy progress */
        .deploy-view {
            display: none;
        }

        .deploy-view.active {
            display: block;
        }

        .deploy-content {
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }

        .deploy-content .deploy-steps-list {
            flex: 0 0 260px;
            min-width: 200px;
            position: sticky;
            top: 20px;
        }

        .deploy-content .deploy-log {
            flex: 1;
            min-width: 0;
        }

        .deploy-step-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: clamp(6px, 0.8vw, 10px) 0;
            font-size: clamp(0.9rem, 1vw, 1.08rem);
            color: var(--t3);
        }

        .deploy-step-item.active {
            color: var(--t1);
            font-weight: 500;
        }

        .deploy-step-item.done {
            color: var(--green);
        }

        .deploy-step-item .step-icon {
            width: 24px;
            text-align: center;
        }

        .deploy-log {
            background: var(--bg2);
            border: 1px solid var(--bd);
            border-radius: var(--r);
            padding: clamp(12px, 1.5vw, 20px);
            min-height: clamp(400px, 55vh, 600px);
            max-height: clamp(500px, 70vh, 800px);
            overflow-y: auto;
            font-family: var(--mono);
            font-size: clamp(0.78rem, 0.85vw, 0.92rem);
            line-height: 1.9;
        }

        .log-line {
            white-space: pre-wrap;
            word-break: break-all;
        }

        .log-line.info {
            color: var(--t2);
        }

        .log-line.output {
            color: var(--t3);
        }

        .log-line.warn {
            color: #f59e0b;
        }

        .log-line.error {
            color: var(--red);
        }

        .log-line .log-time {
            color: var(--t3);
            margin-right: 10px;
            font-size: clamp(0.72rem, 0.78vw, 0.85rem);
        }

        /* Summary section */
        .summary-card {
            background: var(--bg3);
            border: 1px solid var(--bd);
            border-radius: var(--r);
            padding: clamp(16px, 1.8vw, 24px);
            margin-bottom: 14px;
        }

        .summary-card h4 {
            font-size: clamp(0.92rem, 1vw, 1.1rem);
            margin-bottom: 10px;
            color: var(--accent);
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            font-size: clamp(0.88rem, 1vw, 1.05rem);
            padding: 4px 0;
        }

        .summary-row .label {
            color: var(--t3);
        }

        .summary-row .value {
            color: var(--t1);
        }

        /* Env hint styling */
        .env-hint {
            background: color-mix(in srgb, var(--green) 8%, var(--bg3));
            border: 1px solid color-mix(in srgb, var(--green) 25%, var(--bd));
            border-radius: 8px;
            padding: 10px 14px;
            margin-bottom: 16px;
            font-size: clamp(0.82rem, 0.9vw, 0.95rem);
            color: var(--green);
            line-height: 1.5;
        }

        .env-hint code {
            background: rgba(255, 255, 255, .08);
            padding: 1px 6px;
            border-radius: 4px;
            font-family: var(--mono);
            font-size: 0.9em;
        }

        /* Import upload area */
        .import-upload-box {
            background: var(--bg3);
            border: 2px dashed var(--bd);
            border-radius: var(--r);
            padding: clamp(20px, 2.5vw, 32px);
            text-align: center;
            transition: border-color .2s;
        }

        .import-upload-box:hover {
            border-color: var(--accent);
        }

        .import-upload-box p {
            color: var(--t2);
            margin-bottom: 12px;
            font-size: clamp(0.85rem, 0.95vw, 1rem);
        }

        .import-upload-box code {
            background: rgba(255, 255, 255, .08);
            padding: 1px 6px;
            border-radius: 4px;
            font-family: var(--mono);
            font-size: 0.9em;
        }

        .import-result {
            margin-top: 12px;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: clamp(0.82rem, 0.92vw, 0.95rem);
            line-height: 1.6;
        }

        /* Wizard remote chips */
        .wz-remote-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: var(--bg3);
            border: 1px solid var(--bd);
            border-radius: 8px;
            padding: 6px 14px;
            font-size: .85rem;
            margin: 4px;
        }

        .wz-remote-chip .wz-rtype {
            color: var(--t3);
            font-size: .75rem;
        }

        /* Wizard sync rule panel â€” scrollable cards */
        .wz-rule-panel {
            margin-bottom: 16px;
        }

        .wz-rule-panel h4 {
            font-size: .95rem;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .wz-rule-panel .wz-rule-hint {
            font-size: .78rem;
            color: var(--t3);
            margin-bottom: 10px;
        }

        .wz-rule-row {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            padding-bottom: 10px;
            scrollbar-width: thin;
            scrollbar-color: var(--bd-f) transparent;
            cursor: grab;
        }

        .wz-rule-row:active {
            cursor: grabbing;
        }

        .wz-rule-row::-webkit-scrollbar {
            height: 6px;
        }

        .wz-rule-row::-webkit-scrollbar-track {
            background: transparent;
            border-radius: 3px;
        }

        .wz-rule-row::-webkit-scrollbar-thumb {
            background: var(--bd-f);
            border-radius: 3px;
        }

        .wz-rule-row::-webkit-scrollbar-thumb:hover {
            background: var(--accent);
        }

        .wz-rule-card {
            min-width: 200px;
            max-width: 240px;
            flex-shrink: 0;
            position: relative;
            background: var(--bg3);
            border: 2px solid var(--bd);
            border-radius: var(--r);
            padding: 14px;
            transition: all .2s;
            user-select: none;
        }

        .wz-rule-card:hover {
            border-color: var(--accent);
        }

        .wz-rule-card.selected {
            border-color: var(--accent);
            background: color-mix(in srgb, var(--accent) 10%, var(--bg3));
        }

        .wz-rule-check {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 20px;
            height: 20px;
            border: 2px solid var(--t3);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all .2s;
            font-size: 12px;
            color: transparent;
            background: var(--bg2);
        }

        .wz-rule-check:hover {
            border-color: var(--accent);
        }

        .wz-rule-card.selected .wz-rule-check {
            background: var(--accent);
            border-color: var(--accent);
            color: #fff;
        }

        .wz-rule-card .rule-name {
            font-weight: 600;
            font-size: .88rem;
            margin-bottom: 6px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding-right: 24px;
        }

        .wz-rule-card .rule-method {
            font-size: .72rem;
            color: var(--t3);
            margin-bottom: 8px;
        }

        .wz-rule-card .rule-field {
            margin-bottom: 6px;
        }

        .wz-rule-card .rule-field label {
            font-size: .72rem;
            color: var(--t3);
            display: block;
            margin-bottom: 2px;
        }

        .wz-rule-card .rule-field input,
        .wz-rule-card .rule-field select {
            width: 100%;
            padding: 4px 8px;
            background: var(--bg2);
            color: var(--t1);
            border: 1px solid var(--bd);
            border-radius: 6px;
            font-size: .80rem;
        }

        .wz-rule-card .rule-local {
            font-size: .70rem;
            color: var(--t3);
            margin-top: 6px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Add remote inline form */
        .wz-add-remote-form {
            background: var(--bg3);
            border: 1px solid var(--bd);
            border-radius: var(--r);
            padding: 16px;
            margin-top: 10px;
        }

        .wz-add-remote-form .form-group {
            margin-bottom: 10px;
        }

        .wz-add-remote-form label {
            font-size: .82rem;
            color: var(--t2);
            display: block;
            margin-bottom: 3px;
        }

        .wz-add-remote-form select,
        .wz-add-remote-form input[type="text"],
        .wz-add-remote-form input[type="password"],
        .wz-add-remote-form textarea {
            width: 100%;
            padding: 8px 12px;
            background: var(--bg2);
            color: var(--t1);
            border: 1px solid var(--bd);
            border-radius: 8px;
            font-size: .85rem;
            font-family: inherit;
        }

        .wz-add-remote-form select:focus,
        .wz-add-remote-form input:focus,
        .wz-add-remote-form textarea:focus {
            border-color: var(--accent);
            outline: none;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .choice-grid {
                grid-template-columns: 1fr !important;
            }

            .radio-group {
                flex-direction: column;
                gap: 10px;
            }

            .deploy-content {
                flex-direction: column;
            }

            .deploy-content .deploy-steps-list {
                flex: none;
                position: static;
            }
        }

        @media (max-width: 600px) {
            .choice-grid {
                grid-template-columns: 1fr !important;
            }
        }
    </style>
</head>

<body>
    <div class="wizard-container">
        <div class="wizard-header">
            <h1>ğŸš€ ComfyCarry éƒ¨ç½²å‘å¯¼</h1>
            <p><a href="https://github.com/vvb7456/ComfyCarry" target="_blank"
                    style="color:var(--accent);text-decoration:none">GitHub</a> Â· RunPod / Vast.ai ä¸Šçš„ ComfyUI ä¸€ç«™å¼ç®¡ç†</p>
        </div>

        <div class="progress-bar" id="progressBar"></div>

        <!-- Step 0: éƒ¨ç½²æ–¹å¼é€‰æ‹© -->
        <div class="step active" id="step-0">
            <div class="step-title">é€‰æ‹©éƒ¨ç½²æ–¹å¼</div>
            <div class="step-desc" id="step-0-desc">æ­£åœ¨æ£€æµ‹ç¯å¢ƒ...</div>
            <div id="gpu-info-display"></div>
            <div class="choice-grid" id="step0-cards" style="opacity:.4;pointer-events:none">
                <div class="choice-card" onclick="selectMode('fresh')" id="choice-fresh">
                    <h3>ğŸš€ å…¨æ–°éƒ¨ç½²</h3>
                    <p>é…ç½®å¯†ç ã€Tunnelã€äº‘å­˜å‚¨ã€æ’ä»¶ç­‰å‚æ•°ï¼Œç„¶åä¸€é”®éƒ¨ç½² ComfyUI å·¥ä½œç¯å¢ƒ</p>
                    <p style="color:var(--t3);font-size:.72rem;margin-top:6px" id="fresh-time"></p>
                </div>
                <div class="choice-card" onclick="selectMode('import')" id="choice-import">
                    <h3>ğŸ“¦ æ¢å¤è®¾ç½®</h3>
                    <p>ä»ä¹‹å‰å¯¼å‡ºçš„é…ç½®æ–‡ä»¶æ¢å¤æ‰€æœ‰è®¾ç½®ï¼Œå¿«é€Ÿé‡å»ºå·¥ä½œç¯å¢ƒ</p>
                    <p style="color:var(--t3);font-size:.72rem;margin-top:6px">â± è·³è¿‡æ‰‹åŠ¨é…ç½®</p>
                </div>
            </div>
            <!-- å¯¼å…¥æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ (é€‰æ‹©æ¢å¤è®¾ç½®æ—¶æ˜¾ç¤º) -->
            <div id="import-upload-area" style="display:none;margin-bottom:24px">
                <div class="import-upload-box">
                    <p>ä¸Šä¼ ä¹‹å‰å¯¼å‡ºçš„ <code>comfyui-config.json</code> æ–‡ä»¶</p>
                    <label class="btn btn-primary" style="cursor:pointer;display:inline-block">
                        ğŸ“‚ é€‰æ‹©æ–‡ä»¶
                        <input type="file" accept=".json" onchange="handleImportFile(event)" style="display:none">
                    </label>
                </div>
                <div id="import-result" class="import-result" style="display:none"></div>
            </div>
            <div class="btn-row">
                <button class="btn btn-primary" onclick="nextStep()" id="btn-next-0" disabled>ä¸‹ä¸€æ­¥</button>
            </div>
        </div>

        <!-- Step 1: ComfyCarry å¯†ç  -->
        <div class="step" id="step-1">
            <div class="step-title">ğŸ” è®¾ç½® ComfyCarry å¯†ç </div>
            <div class="step-desc">ä¿æŠ¤ä½ çš„ ComfyCarry æ§åˆ¶å°</div>
            <div id="password-env-hint" style="display:none" class="env-hint"></div>
            <div class="form-group">
                <label>è®¿é—®å¯†ç </label>
                <div class="pw-wrap">
                    <input type="password" id="input-password" placeholder="è¾“å…¥ ComfyCarry è®¿é—®å¯†ç ...">
                    <button type="button" class="pw-toggle" onclick="togglePw('input-password', this)"
                        title="æ˜¾ç¤º/éšè—å¯†ç ">ğŸ‘</button>
                </div>
            </div>
            <div class="form-group">
                <label>ç¡®è®¤å¯†ç </label>
                <div class="pw-wrap">
                    <input type="password" id="input-password-confirm" placeholder="å†æ¬¡è¾“å…¥å¯†ç ...">
                    <button type="button" class="pw-toggle" onclick="togglePw('input-password-confirm', this)"
                        title="æ˜¾ç¤º/éšè—å¯†ç ">ğŸ‘</button>
                </div>
                <div class="pw-mismatch" id="pw-mismatch-hint">âš ï¸ ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´</div>
                <div class="form-hint">éƒ¨ç½²å®Œæˆåé€šè¿‡æ­¤å¯†ç ç™»å½• ComfyCarry</div>
            </div>
            <div class="btn-row">
                <button class="btn btn-secondary" onclick="prevStep()">ä¸Šä¸€æ­¥</button>
                <button class="btn btn-primary" id="btn-next-1" onclick="nextStep()" disabled>ä¸‹ä¸€æ­¥</button>
            </div>
        </div>

        <!-- Step 2: Cloudflare Tunnel -->
        <div class="step" id="step-2">
            <div class="step-title">ğŸŒ Cloudflare Tunnel</div>
            <div class="step-desc">é…ç½® Cloudflare Tunnel è·å¾—ç¨³å®šçš„å…¬ç½‘è®¿é—®ï¼ˆComfyUI / SSH / JupyterLabï¼‰<span class="help-tip"
                    title="é€šè¿‡ Cloudflare API è‡ªåŠ¨åˆ›å»º Tunnelã€é…ç½® DNS å’Œ Ingressã€‚éœ€è¦ä¸€ä¸ªæ‹¥æœ‰ Tunnel Edit + DNS Edit æƒé™çš„ API Tokenã€‚">?</span>
            </div>
            <div id="cf-env-hint" style="display:none" class="env-hint"></div>
            <div class="form-group">
                <label>CF API Token</label>
                <input type="password" id="input-cf-token"
                    placeholder="Cloudflare API Token (éœ€ Tunnel Edit + DNS Edit æƒé™)" oninput="updateNextBtnText()">
                <div class="form-hint">åœ¨ <a href="https://dash.cloudflare.com/profile/api-tokens" target="_blank"
                        style="color:var(--accent)">Cloudflare API Tokens</a> åˆ›å»ºï¼Œç•™ç©ºåˆ™è·³è¿‡</div>
            </div>
            <div class="form-group">
                <label>åŸŸå</label>
                <input type="text" id="input-cf-domain" placeholder="mydomain.com (å·²æ‰˜ç®¡åœ¨ Cloudflare çš„åŸŸå)"
                    oninput="updateNextBtnText()">
            </div>
            <div class="form-group">
                <label>å­åŸŸåå‰ç¼€ <span style="color:var(--t3);font-size:.82rem">(å¯é€‰)</span></label>
                <input type="text" id="input-cf-subdomain" placeholder="ç•™ç©ºåˆ™éšæœºç”Ÿæˆ (å¦‚ cc-a1b2c3d4)">
            </div>
            <div style="display:flex;gap:12px;margin-bottom:12px;align-items:center">
                <button class="btn btn-secondary" onclick="validateCfToken()"
                    style="padding:8px 16px;font-size:.88rem;flex-shrink:0">ğŸ” éªŒè¯ Token</button>
                <span id="cf-validate-inline" style="font-size:.85rem;display:none"></span>
            </div>
            <div class="btn-row">
                <button class="btn btn-secondary" onclick="prevStep()">ä¸Šä¸€æ­¥</button>
                <button class="btn btn-primary" id="btn-next-2" onclick="nextStep()">è·³è¿‡</button>
            </div>
        </div>

        <!-- Step 3: äº‘å­˜å‚¨ (Remotes) -->
        <div class="step" id="step-3">
            <div class="step-title">â˜ï¸ äº‘å­˜å‚¨é…ç½®</div>
            <div class="step-desc">è¿æ¥äº‘ç«¯å­˜å‚¨ï¼Œå®ç°å·¥ä½œåŒºè‡ªåŠ¨åŒæ­¥ <span class="help-tip"
                    title="Rclone æ˜¯å¼€æºäº‘å­˜å‚¨åŒæ­¥å·¥å…·ï¼Œæ”¯æŒ OneDrive / Google Drive / S3 / R2 ç­‰ã€‚åœ¨æœ¬åœ°ç”µè„‘å®‰è£… Rclone åï¼Œè¿è¡Œ rclone config åˆ›å»º Remoteï¼Œé…ç½®æ–‡ä»¶ä½äº ~/.config/rclone/rclone.confï¼Œä¸Šä¼ è¯¥æ–‡ä»¶å³å¯å¯¼å…¥ã€‚">?</span>
            </div>

            <div
                style="margin:12px 0;padding:10px 14px;background:var(--bg2);border:1px solid var(--bd);border-radius:8px;font-size:.85rem;color:var(--t2)">
                ğŸ’¡ è¿˜æ²¡æœ‰ rclone é…ç½®ï¼Ÿ<a href="/api/setup/rclone-bundle"
                    style="color:var(--ac);text-decoration:underline;font-weight:600">ä¸‹è½½é…ç½®åŠ©æ‰‹ (Windows)</a> â€” è§£å‹ååŒå‡» bat
                è„šæœ¬ï¼Œè·Ÿéšå¼•å¯¼å®Œæˆç½‘ç›˜æˆæƒï¼Œé…ç½®å®Œæˆåå›åˆ°è¿™é‡Œä¸Šä¼  rclone.conf æ–‡ä»¶å³å¯ã€‚
            </div>

            <div id="rclone-env-hint" style="display:none" class="env-hint"></div>

            <!-- Rclone method cards -->
            <div class="choice-grid rclone-cards" id="rclone-method-cards">
                <div class="choice-card" data-rclone="base64_env" id="rclone-card-env" style="display:none"
                    onclick="selectRcloneMethod('base64_env')">
                    <h3>ğŸ”‘ ç¯å¢ƒå˜é‡</h3>
                    <p>ä½¿ç”¨å·²è®¾ç½®çš„ RCLONE_CONF_BASE64</p>
                </div>
                <div class="choice-card" data-rclone="file" onclick="selectRcloneMethod('file')">
                    <h3>ğŸ“‚ ä¸Šä¼ æ–‡ä»¶</h3>
                    <p>ä¸Šä¼ æœ¬åœ° rclone.conf æ–‡ä»¶</p>
                </div>

                <div class="choice-card" data-rclone="manual" onclick="selectRcloneMethod('manual')">
                    <h3>ğŸ”§ æ‰‹åŠ¨åˆ›å»º</h3>
                    <p>äº¤äº’å¼åˆ›å»ºæ–°çš„ Remote</p>
                </div>
            </div>

            <!-- Rclone input areas (shown based on selection) -->
            <div id="rclone-input-area" style="display:none;margin-bottom:20px">
                <div id="rclone-file-input" style="display:none" class="form-group">
                    <label
                        style="cursor:pointer;display:inline-block;background:var(--bg4);padding:8px 18px;border-radius:8px;font-size:.88rem">
                        ğŸ“‚ é€‰æ‹© rclone.conf æ–‡ä»¶
                        <input type="file" accept=".conf,.txt" onchange="handleRcloneFile(event)" style="display:none">
                    </label>
                    <span id="rclone-file-status" style="margin-left:10px;font-size:.82rem;color:var(--t3)"></span>
                </div>

                <div id="rclone-manual-input" style="display:none" class="wz-add-remote-form">
                    <div class="form-group">
                        <label>Remote åç§°</label>
                        <input type="text" id="wz-remote-name" placeholder="ä¾‹å¦‚ myr2" style="width:100%">
                    </div>
                    <div class="form-group">
                        <label>ç±»å‹</label>
                        <select id="wz-remote-type" onchange="renderWizardRemoteFields()" style="width:100%">
                            <option value="">é€‰æ‹©ç±»å‹...</option>
                        </select>
                    </div>
                    <div id="wz-remote-fields"></div>
                    <div style="display:flex;gap:8px;margin-top:10px">
                        <button class="btn btn-primary" onclick="submitWizardRemote()"
                            style="font-size:.85rem;padding:6px 16px">æ·»åŠ  Remote</button>
                    </div>
                </div>
            </div>

            <!-- Detected remotes preview -->
            <div id="wizard-remotes-section" style="display:none;margin-bottom:20px">
                <label style="font-size:.92rem;font-weight:600;margin-bottom:8px;display:block">ğŸ“¡ å·²æ£€æµ‹åˆ°çš„ Remote</label>
                <div id="wizard-remotes-list" style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px"></div>
            </div>

            <!-- Manually added remotes -->
            <div id="wizard-manual-remotes" style="display:none;margin-bottom:20px">
                <label style="font-size:.92rem;font-weight:600;margin-bottom:8px;display:block">ğŸ”§ æ‰‹åŠ¨æ·»åŠ çš„ Remote</label>
                <div id="wizard-manual-remotes-list" style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px">
                </div>
            </div>

            <div class="btn-row">
                <button class="btn btn-secondary" onclick="prevStep()">ä¸Šä¸€æ­¥</button>
                <button class="btn btn-primary" id="btn-next-3" onclick="nextStep()">è·³è¿‡</button>
            </div>
        </div>

        <!-- Step 4: åŒæ­¥è§„åˆ™ -->
        <div class="step" id="step-4">
            <div class="step-title">ğŸ”„ åŒæ­¥è§„åˆ™é…ç½®</div>
            <div class="step-desc">é€‰æ‹©éœ€è¦åŒæ­¥çš„å†…å®¹ï¼Œéƒ¨ç½²åå¯åœ¨ ComfyCarryã€Œäº‘åŒæ­¥ã€é¡µé¢è‡ªç”±å¢åˆ æ”¹ã€‚</div>

            <!-- Default remote selector -->
            <div style="margin-bottom:18px">
                <label style="font-size:.88rem;font-weight:500;color:var(--t2);margin-bottom:6px;display:block">é»˜è®¤
                    Remote</label>
                <select id="wz-default-remote"
                    style="min-width:160px;padding:8px 12px;background:var(--bg2);color:var(--t1);border:1px solid var(--bd);border-radius:8px;font-size:.88rem"
                    onchange="updateWizardRuleRemotes()"></select>
                <div class="form-hint">æ›´æ”¹åè‡ªåŠ¨åº”ç”¨åˆ°æ‰€æœ‰è§„åˆ™ï¼Œä¹Ÿå¯å•ç‹¬ä¸ºæ¯æ¡è§„åˆ™é€‰æ‹©ä¸åŒ Remote</div>
            </div>

            <!-- Pull rules -->
            <div class="wz-rule-panel">
                <h4>ğŸ“¥ éƒ¨ç½²æ‹‰å– <span class="help-tip"
                        title="éƒ¨ç½²æ—¶ä»äº‘ç«¯ä¸‹è½½å¯¹åº”ç›®å½•çš„æ–‡ä»¶åˆ°æœ¬åœ° ComfyUIï¼Œäº‘ç«¯æ–‡ä»¶ä¸ä¼šè¢«åˆ é™¤ã€‚é€‚åˆæ¨¡å‹ã€LoRAã€å·¥ä½œæµç­‰éœ€è¦å¤ç”¨çš„èµ„æºã€‚">?</span></h4>
                <div class="wz-rule-row" id="wz-pull-rules"></div>
            </div>

            <!-- Push rules -->
            <div class="wz-rule-panel">
                <h4>ğŸ“¤ è‡ªåŠ¨æ¨é€ <span class="help-tip" title="è¿è¡ŒæœŸé—´æŒç»­ç›‘æ§æœ¬åœ°ç›®å½•å˜åŒ–ï¼Œè‡ªåŠ¨å°†æ–°å¢/ä¿®æ”¹çš„æ–‡ä»¶æ¨é€åˆ°äº‘ç«¯ã€‚é€‚åˆç”Ÿæˆå›¾ã€å·¥ä½œæµç­‰éœ€è¦å¤‡ä»½çš„å†…å®¹ã€‚">?</span>
                </h4>
                <div class="wz-rule-row" id="wz-push-rules"></div>
            </div>

            <div id="wz-rule-count" style="font-size:.78rem;color:var(--t3);margin-bottom:8px">å·²é€‰è§„åˆ™ï¼š0 Â· éƒ¨ç½²åå¯åœ¨ ComfyCarry
                äº‘åŒæ­¥é¡µä¿®æ”¹</div>

            <div class="btn-row">
                <button class="btn btn-secondary" onclick="prevStep()">ä¸Šä¸€æ­¥</button>
                <button class="btn btn-primary" id="btn-next-4" onclick="nextStep()">è·³è¿‡</button>
            </div>
        </div>

        <!-- Step 5: CivitAI -->
        <div class="step" id="step-5">
            <div class="step-title">ğŸ¨ CivitAI API Key</div>
            <div class="step-desc">é…ç½® CivitAI API Key ä»¥åœ¨ ComfyCarry ä¸­æœç´¢å’Œä¸‹è½½æ¨¡å‹</div>
            <div id="civitai-env-hint" style="display:none" class="env-hint"></div>
            <div class="form-group">
                <label>API Key</label>
                <input type="text" id="input-civitai-token" placeholder="ä½ çš„ CivitAI API Key (å¯é€‰)"
                    oninput="updateNextBtnText()">
                <div class="form-hint">å¯åœ¨ <a href="https://civitai.com/user/account" target="_blank"
                        style="color:var(--accent)">CivitAI è´¦æˆ·è®¾ç½®</a> è·å–ï¼Œä¹Ÿå¯è·³è¿‡ååœ¨ ComfyCarry è®¾ç½®</div>
            </div>
            <div class="btn-row">
                <button class="btn btn-secondary" onclick="prevStep()">ä¸Šä¸€æ­¥</button>
                <button class="btn btn-primary" id="btn-next-5" onclick="nextStep()">è·³è¿‡</button>
            </div>
        </div>

        <!-- Step 6: æ’ä»¶é€‰æ‹© -->
        <div class="step" id="step-6">
            <div class="step-title">ğŸ§© è‡ªå®šä¹‰èŠ‚ç‚¹æ’ä»¶</div>
            <div class="step-desc" id="plugin-step-desc">é€‰æ‹©è¦å®‰è£…çš„ ComfyUI æ’ä»¶ (å¸¦ * æ ‡è®°çš„ä¸ºå¿…é€‰)</div>
            <div class="plugin-list" id="plugin-list"></div>
            <div class="form-group" style="margin-top:12px">
                <label>é¢å¤–æ’ä»¶ URL (æ¯è¡Œä¸€ä¸ª)</label>
                <textarea id="input-extra-plugins" placeholder="https://github.com/user/ComfyUI-CustomNode"
                    style="min-height:60px"></textarea>
            </div>
            <div class="btn-row">
                <button class="btn btn-secondary" onclick="prevStep()">ä¸Šä¸€æ­¥</button>
                <button class="btn btn-primary" onclick="nextStep()">ä¸‹ä¸€æ­¥</button>
            </div>
        </div>

        <!-- Step 7: åŠ é€Ÿç»„ä»¶ (FA2/SA2) -->
        <div class="step" id="step-7">
            <div class="step-title">âš¡ Attention åŠ é€Ÿ</div>
            <div class="step-desc" id="attn-step-desc">é€‰æ‹©è¦å®‰è£…çš„ Attention åŠ é€Ÿç»„ä»¶ <span class="help-tip"
                    title="FlashAttention-2 å’Œ SageAttention-2 å¯åŠ é€Ÿ Transformer è®¡ç®—ã€‚FA2 å…¼å®¹æ€§æ›´å¥½ï¼Œæ¨èå®‰è£…ã€‚SA2 æ˜¯æ–°è¾ƒæ–¹æ¡ˆï¼Œéƒ¨åˆ†æ¨¡å‹å¯å¤ç”¨ã€‚ä¸¤è€…åŒæ—¶å®‰è£…æ—¶ä¼˜å…ˆä½¿ç”¨ FA2ã€‚">?</span>
            </div>

            <div class="choice-grid" id="attn-cards" style="grid-template-columns: repeat(2, 1fr);">
                <div class="choice-card" id="attn-card-fa2" data-attn="fa2" onclick="toggleAttnCard('fa2')">
                    <h3>ğŸ”¥ FlashAttention-2</h3>
                    <p>é«˜æ€§èƒ½ Attention å®ç°ï¼Œå¹¿æ³›æ”¯æŒ</p>
                    <div style="font-size:.72rem;color:var(--t3);margin-top:6px">å¯åŠ¨å‚æ•°: --use-flash-attention</div>
                </div>
                <div class="choice-card" id="attn-card-sa2" data-attn="sa2" onclick="toggleAttnCard('sa2')">
                    <h3>ğŸŒ¿ SageAttention-2</h3>
                    <p>æ–°ä¸€ä»£ Attention æ–¹æ¡ˆï¼Œéƒ¨åˆ†åœºæ™¯æ›´å¿«</p>
                    <div style="font-size:.72rem;color:var(--t3);margin-top:6px">å¯åŠ¨å‚æ•°: --use-sage-attention</div>
                </div>
            </div>
            <div id="attn-hint" style="font-size:.78rem;color:var(--t3);margin-top:8px"></div>

            <div class="btn-row">
                <button class="btn btn-secondary" onclick="prevStep()">ä¸Šä¸€æ­¥</button>
                <button class="btn btn-primary" id="btn-next-7" onclick="nextStep()">è·³è¿‡</button>
            </div>
        </div>

        <!-- Step 8: ç¡®è®¤éƒ¨ç½² -->
        <div class="step" id="step-8">
            <div class="step-title">ğŸ“‹ ç¡®è®¤éƒ¨ç½²é…ç½®</div>
            <div class="step-desc">æ£€æŸ¥ä»¥ä¸‹é…ç½®ï¼Œç¡®è®¤åå¼€å§‹éƒ¨ç½²</div>
            <div id="deploy-summary"></div>
            <div class="btn-row">
                <button class="btn btn-secondary" onclick="prevStep()">è¿”å›ä¿®æ”¹</button>
                <button class="btn btn-primary btn-lg" onclick="startDeploy()" id="btn-deploy">ğŸš€ å¼€å§‹éƒ¨ç½²</button>
            </div>
        </div>

        <!-- Deploy Progress View -->
        <div class="deploy-view" id="deploy-view">
            <div class="step-title" id="deploy-title">âš™ï¸ æ­£åœ¨éƒ¨ç½²...</div>
            <div class="step-desc" id="deploy-elapsed">å·²ç”¨æ—¶: 0 ç§’</div>
            <div class="deploy-content">
                <div class="deploy-steps-list" id="deploy-steps-list"></div>
                <div class="deploy-log" id="deploy-log"></div>
            </div>
            <!-- é”™è¯¯è¯¦æƒ… (éƒ¨ç½²å¤±è´¥æ—¶æ˜¾ç¤º) -->
            <div id="deploy-error-banner"
                style="display:none;margin-top:12px;padding:12px 16px;background:rgba(255,80,80,0.12);border:1px solid var(--red);border-radius:8px;color:var(--red);font-size:14px;word-break:break-word;">
            </div>
            <!-- æˆåŠŸæŒ‰é’® -->
            <div class="btn-row" id="deploy-done-row" style="display:none;margin-top:16px">
                <button class="btn btn-secondary" id="deploy-done-retry" style="display:none" onclick="retryDeploy()">ğŸ”„
                    é‡è¯•éƒ¨ç½²</button>
                <button class="btn btn-primary btn-lg" onclick="location.reload()">ğŸ‰ è¿›å…¥ ComfyCarry</button>
            </div>
            <!-- å¤±è´¥æŒ‰é’® -->
            <div class="btn-row" id="deploy-fail-row" style="display:none;margin-top:16px">
                <button class="btn btn-secondary" onclick="backToWizard()">â¬… è¿”å›ä¿®æ”¹é…ç½®</button>
                <button class="btn btn-primary btn-lg" onclick="retryDeploy()">ğŸ”„ é‡è¯•éƒ¨ç½²</button>
            </div>
        </div>
    </div>

    <script>
        const TOTAL_STEPS = 9;
        let currentStep = 0;
        let wizardConfig = {
            image_type: 'prebuilt',
            password: '',
            cf_api_token: '',
            cf_domain: '',
            cf_subdomain: '',
            rclone_config_method: 'skip',
            rclone_config_value: '',
            civitai_token: '',
            plugins: [],
            install_fa2: false,
            install_sa2: false,
            download_aura_model: true,
            wizard_sync_rules: [],   // [{template_id, remote, remote_path}]
            wizard_remotes: [],       // [{name, type, params}]
        };
        let pluginData = [];
        let envVars = {};
        let detectedImageType = '';
        let prebuiltInfo = null;
        let importedConfig = null;
        let _syncTemplates = [];
        let _remoteTypeDefs = {};
        let _detectedRemotes = [];   // ä» rclone config ä¸­è§£æå‡ºçš„ remotes

        // â”€â”€ Init â”€â”€
        async function init() {
            try {
                const r = await fetch('/api/setup/state');
                const state = await r.json();
                envVars = state.env_vars || {};
                detectedImageType = state.detected_image_type || '';
                prebuiltInfo = state.prebuilt_info || null;
                _syncTemplates = state.sync_templates || [];
                _remoteTypeDefs = state.remote_type_defs || {};

                // â”€â”€ Mock æ¨¡å¼ (URL ?mock=xxx è¦†ç›–æ£€æµ‹ç»“æœï¼Œä»…ç”¨äºè°ƒè¯•) â”€â”€
                const mockParam = new URLSearchParams(location.search).get('mock');
                let mockGpu = state.gpu_info;
                if (mockParam) {
                    console.log('[Wizard] Mock mode:', mockParam);
                    if (mockParam === 'prebuilt') { detectedImageType = 'prebuilt'; prebuiltInfo = { version: '3.0', torch: '2.9.1+cu130', cuda_toolkit: '13.0', fa2: true, build_date: '2026-02-20T00:00:00Z' }; }
                    else if (mockParam === 'unsupported') { detectedImageType = 'unsupported'; prebuiltInfo = null; mockGpu = null; }
                    else if (mockParam === 'unsupported-gpu') { detectedImageType = 'prebuilt'; mockGpu = { name: 'Tesla V100-SXM2-16GB', cuda_cap: '7.0', vram_gb: 16 }; }
                    else if (mockParam === 'no-gpu') { detectedImageType = 'prebuilt'; mockGpu = null; }
                }
                const gpuInfo = mockGpu;

                // â”€â”€ ç¯å¢ƒä¿¡æ¯å¡ç‰‡ (GPU + é•œåƒ) â”€â”€
                const envEl = document.getElementById('gpu-info-display');
                let cardHtml = '';
                let noGpu = false;
                let gpuTooOld = false;

                // GPU è¡Œ
                if (gpuInfo && gpuInfo.name) {
                    const g = gpuInfo;
                    const smArch = g.cuda_cap ? `sm_${g.cuda_cap.replace('.', '')}` : '';
                    const capMajor = g.cuda_cap ? parseInt(g.cuda_cap.split('.')[0], 10) : 0;
                    gpuTooOld = capMajor > 0 && capMajor < 8;
                    const archColor = gpuTooOld ? 'color:var(--red)' : '';
                    cardHtml += `<div class="env-row">
                <span class="env-label">GPU</span>
                <span class="env-value">ğŸ–¥ï¸ ${esc(g.name)}</span>
                <span class="env-label" style="margin-left:auto;${archColor}">${smArch} Â· ${g.vram_gb} GB VRAM</span>
            </div>`;
                } else {
                    noGpu = true;
                    cardHtml += `<div class="env-row">
                <span class="env-label">GPU</span>
                <span class="env-value" style="color:var(--red)">æœªæ£€æµ‹åˆ° CUDA GPU</span>
            </div>`;
                }

                // GPU ä¸å¯ç”¨ â†’ å¼ºåˆ¶ä¸æ”¯æŒ
                if (gpuTooOld) detectedImageType = 'unsupported-gpu';
                else if (noGpu) detectedImageType = 'no-gpu';

                // é•œåƒè¡Œ
                if (detectedImageType === 'prebuilt') {
                    const ver = (prebuiltInfo && prebuiltInfo.version && prebuiltInfo.version !== 'unknown') ? ` v${prebuiltInfo.version}` : '';
                    cardHtml += `<hr class="env-divider">`;
                    cardHtml += `<div class="env-row">
                <span class="env-label">é•œåƒ</span>
                <span class="env-value" style="color:var(--green)">âš¡ é¢„æ„å»ºé•œåƒ${ver}</span>
            </div>`;
                    if (prebuiltInfo) {
                        const tags = [];
                        if (prebuiltInfo.torch) tags.push(`PyTorch ${prebuiltInfo.torch}`);
                        if (prebuiltInfo.cuda_toolkit) tags.push(`CUDA ${prebuiltInfo.cuda_toolkit}`);
                        if (prebuiltInfo.fa2) tags.push({ text: 'FA2 âœ“', green: true });
                        if (prebuiltInfo.build_date) tags.push(prebuiltInfo.build_date.slice(0, 10));
                        if (tags.length) {
                            cardHtml += `<div class="env-tags" style="margin-left:68px">`;
                            for (const t of tags) {
                                if (typeof t === 'object') cardHtml += `<span class="env-tag green">${t.text}</span>`;
                                else cardHtml += `<span class="env-tag">${esc(t)}</span>`;
                            }
                            cardHtml += `</div>`;
                        }
                    }
                }

                // æ¸²æŸ“å¡ç‰‡ (æ­£å¸¸è·¯å¾„)
                const isUnsupported = detectedImageType === 'unsupported-gpu' || detectedImageType === 'no-gpu' || detectedImageType === 'unsupported';

                if (!isUnsupported && cardHtml) {
                    envEl.innerHTML = `<div class="env-card">${cardHtml}</div>`;
                }

                // Load plugin list
                pluginData = state.plugins_available || [];
                const selectedUrls = state.plugins || pluginData.map(p => p.url);

                // è‡ªåŠ¨è®¾å®š image_type
                wizardConfig.image_type = isUnsupported ? 'unsupported' : 'prebuilt';

                // step-0-desc: æ£€æµ‹ç»“æœ
                const descEl = document.getElementById('step-0-desc');
                const timeEl = document.getElementById('fresh-time');
                if (!isUnsupported) {
                    descEl.textContent = 'âœ… ç¯å¢ƒæ£€æµ‹é€šè¿‡';
                    descEl.style.color = 'var(--green)';
                    timeEl.textContent = 'â± é¢„è®¡ 2-5 åˆ†é’Ÿ';
                } else {
                    descEl.innerHTML = 'âŒ ç¯å¢ƒæ£€æµ‹å¤±è´¥';
                    descEl.style.color = 'var(--red)';
                    timeEl.textContent = '';
                    if (detectedImageType === 'unsupported-gpu') {
                        // GPU ç®—åŠ›è¿‡ä½ â€” ä¿ç•™ GPU è¡Œ + è¿½åŠ è­¦å‘Š
                        cardHtml += `<hr class="env-divider">`;
                        cardHtml += `<div style="color:var(--red);font-size:.88rem;line-height:1.6">
                    âš ï¸ <b>GPU ç®—åŠ›ä¸è¶³</b> â€” FlashAttention 2 éœ€è¦ Ampere (sm_80) åŠä»¥ä¸Šæ¶æ„ã€‚<br>
                    è¯·é€‰æ‹©é…å¤‡ RTX 30xx / A100 / RTX 40xx åŠä»¥ä¸Š GPU çš„å®ä¾‹ã€‚
                </div>`;
                        envEl.innerHTML = `<div class="env-card" style="border-color:var(--red)">${cardHtml}</div>`;
                    } else if (detectedImageType === 'no-gpu') {
                        cardHtml += `<hr class="env-divider">`;
                        cardHtml += `<div style="color:var(--red);font-size:.88rem;line-height:1.6">
                    âš ï¸ <b>æœªæ£€æµ‹åˆ° CUDA GPU</b> â€” ComfyUI éœ€è¦ NVIDIA GPU è¿è¡Œã€‚<br>
                    è¯·åœ¨ GPU å®ä¾‹ä¸Šéƒ¨ç½²ï¼Œæˆ–æ£€æŸ¥ CUDA é©±åŠ¨æ˜¯å¦æ­£ç¡®å®‰è£…ã€‚
                </div>`;
                        envEl.innerHTML = `<div class="env-card" style="border-color:var(--red)">${cardHtml}</div>`;
                    } else {
                        envEl.innerHTML = `<div class="env-card" style="border-color:var(--red)">
                    <div style="color:var(--red);font-weight:600;margin-bottom:8px">âš ï¸ ä¸æ”¯æŒçš„è¿è¡Œç¯å¢ƒ</div>
                    <div style="color:var(--t3);font-size:.88rem;line-height:1.6">
                        å½“å‰ç¯å¢ƒç¼ºå°‘å¿…è¦çš„è¿è¡Œæ—¶ç»„ä»¶ã€‚è¯·ä½¿ç”¨ ComfyCarry é¢„æ„å»ºé•œåƒåˆ›å»ºå®ä¾‹ï¼š<br>
                        <code style="color:var(--accent)">ghcr.io/vvb7456/comfyui-runpod:v3.0</code> ï¼ˆé¢„è£… ComfyUI + åŠ é€Ÿç»„ä»¶ï¼‰
                    </div>
                </div>`;
                    }
                    document.querySelectorAll('#step-0 .choice-card').forEach(c => {
                        c.style.opacity = '0.4';
                        c.style.pointerEvents = 'none';
                    });
                }

                // è§£é” Step 0 å¡ç‰‡ (æ£€æµ‹å®Œæˆ)
                if (!isUnsupported) {
                    const cards0 = document.getElementById('step0-cards');
                    cards0.style.opacity = ''; cards0.style.pointerEvents = '';
                }

                renderPluginList(pluginData, selectedUrls);

                // Populate add-remote type selector
                const sel = document.getElementById('wz-remote-type');
                for (const [k, v] of Object.entries(_remoteTypeDefs)) {
                    const opt = document.createElement('option');
                    opt.value = k;
                    opt.textContent = `${v.icon} ${v.label}${v.oauth ? ' (éœ€ OAuth)' : ''}`;
                    sel.appendChild(opt);
                }

                // Restore state if partially filled
                if (state.image_type) wizardConfig.image_type = state.image_type;
                if (state.deploy_started && !state.deploy_completed) {
                    showDeployView();
                    connectSSE();
                } else if (state.deploy_error) {
                    showStep(TOTAL_STEPS - 1);
                    renderSummary();
                    const summaryEl = document.getElementById('deploy-summary');
                    summaryEl.innerHTML = `
                <div style="padding:12px 16px;background:rgba(255,80,80,0.12);border:1px solid var(--red);border-radius:8px;color:var(--red);margin-bottom:16px;">
                    <strong>âš ï¸ ä¸Šæ¬¡éƒ¨ç½²æœªå®Œæˆ:</strong> ${esc(state.deploy_error)}<br>
                    <small>ç‚¹å‡»ã€Œé‡è¯•éƒ¨ç½²ã€å°†è‡ªåŠ¨è·³è¿‡å·²å®Œæˆçš„æ­¥éª¤ã€‚</small>
                </div>` + summaryEl.innerHTML;
                }

                // â”€â”€ ç¯å¢ƒå˜é‡é¢„å¡«å…… â”€â”€
                if (envVars.password) {
                    document.getElementById('input-password').value = envVars.password;
                    document.getElementById('input-password-confirm').value = envVars.password;
                    wizardConfig.password = envVars.password;
                    const hint = document.getElementById('password-env-hint');
                    hint.style.display = 'block';
                    hint.innerHTML = 'âœ… å·²ä»ç¯å¢ƒå˜é‡ <code>DASHBOARD_PASSWORD</code> æ£€æµ‹åˆ°å¯†ç ï¼Œå¯ç›´æ¥ä½¿ç”¨æˆ–ä¿®æ”¹';
                }
                // å¯†ç è¾“å…¥ç›‘å¬ â€” ä¸¤ä¸ªæ¡†éƒ½æœ‰å†…å®¹ä¸”ä¸€è‡´æ—¶æ‰å…è®¸ä¸‹ä¸€æ­¥
                const _pwInputs = ['input-password', 'input-password-confirm'];
                _pwInputs.forEach(id => document.getElementById(id).addEventListener('input', () => {
                    const pw = document.getElementById('input-password').value;
                    const pw2 = document.getElementById('input-password-confirm').value;
                    const btn = document.getElementById('btn-next-1');
                    btn.disabled = !(pw && pw2 && pw === pw2);
                    document.getElementById('pw-mismatch-hint').style.display =
                        (pw && pw2 && pw !== pw2) ? 'block' : 'none';
                }));
                // ç¯å¢ƒå˜é‡é¢„å¡«æ—¶ç›´æ¥å¯ç”¨
                if (envVars.password) document.getElementById('btn-next-1').disabled = false;
                if (envVars.cf_api_token) {
                    document.getElementById('input-cf-token').value = envVars.cf_api_token;
                    wizardConfig.cf_api_token = envVars.cf_api_token;
                    if (envVars.cf_domain) {
                        document.getElementById('input-cf-domain').value = envVars.cf_domain;
                        wizardConfig.cf_domain = envVars.cf_domain;
                    }
                    if (envVars.cf_subdomain) {
                        document.getElementById('input-cf-subdomain').value = envVars.cf_subdomain;
                        wizardConfig.cf_subdomain = envVars.cf_subdomain;
                    }
                    const hint = document.getElementById('cf-env-hint');
                    hint.style.display = 'block';
                    hint.innerHTML = 'âœ… å·²ä»ç¯å¢ƒå˜é‡æ£€æµ‹åˆ° CF é…ç½®';
                }
                if (envVars.rclone_has_env) {
                    document.getElementById('rclone-card-env').style.display = '';
                    const hint = document.getElementById('rclone-env-hint');
                    hint.style.display = 'block';
                    hint.innerHTML = 'âœ… å·²ä»ç¯å¢ƒå˜é‡ <code>RCLONE_CONF_BASE64</code> æ£€æµ‹åˆ°é…ç½®';
                    wizardConfig.rclone_config_method = 'base64_env';
                    selectRcloneMethod('base64_env');
                }
                if (envVars.civitai_token) {
                    document.getElementById('input-civitai-token').value = envVars.civitai_token;
                    wizardConfig.civitai_token = envVars.civitai_token;
                    const hint = document.getElementById('civitai-env-hint');
                    hint.style.display = 'block';
                    hint.innerHTML = 'âœ… å·²ä»ç¯å¢ƒå˜é‡ <code>CIVITAI_TOKEN</code> æ£€æµ‹åˆ° API Key';
                }

                // â”€â”€ ä»å·²ä¿å­˜çš„ state ä¸­æ¢å¤å­—æ®µ â”€â”€
                if (state.password && !document.getElementById('input-password').value) {
                    document.getElementById('input-password').value = state.password;
                    document.getElementById('input-password-confirm').value = state.password;
                    wizardConfig.password = state.password;
                    document.getElementById('btn-next-1').disabled = false;
                }
                if (state.cf_api_token && !document.getElementById('input-cf-token').value) {
                    document.getElementById('input-cf-token').value = state.cf_api_token;
                    wizardConfig.cf_api_token = state.cf_api_token;
                }
                if (state.cf_domain && !document.getElementById('input-cf-domain').value) {
                    document.getElementById('input-cf-domain').value = state.cf_domain;
                    wizardConfig.cf_domain = state.cf_domain;
                }
                if (state.cf_subdomain && !document.getElementById('input-cf-subdomain').value) {
                    document.getElementById('input-cf-subdomain').value = state.cf_subdomain;
                    wizardConfig.cf_subdomain = state.cf_subdomain;
                }
                if (state.civitai_token && !document.getElementById('input-civitai-token').value) {
                    document.getElementById('input-civitai-token').value = state.civitai_token;
                    wizardConfig.civitai_token = state.civitai_token;
                }
                if (state.rclone_config_method && state.rclone_config_method !== 'skip') {
                    const method = state.rclone_config_method;
                    selectRcloneMethod(method);
                    wizardConfig.rclone_config_method = method;
                    if (state.rclone_config_value) {
                        wizardConfig.rclone_config_value = state.rclone_config_value;
                        if (method === 'base64') document.getElementById('input-rclone-base64').value = state.rclone_config_value;
                    }
                }
                if (state.plugins) wizardConfig.plugins = state.plugins;
                if (state.wizard_remotes) wizardConfig.wizard_remotes = state.wizard_remotes;
                if (state.wizard_sync_rules) wizardConfig.wizard_sync_rules = state.wizard_sync_rules;
                if (state.install_fa2 !== undefined) wizardConfig.install_fa2 = state.install_fa2;
                if (state.install_sa2 !== undefined) wizardConfig.install_sa2 = state.install_sa2;
                if (state.download_aura_model !== undefined) wizardConfig.download_aura_model = state.download_aura_model;

                // æ¢å¤æ‰‹åŠ¨æ·»åŠ çš„ remotes æ˜¾ç¤º
                renderWizardManualRemotes();

                updateProgressBar();
            } catch (e) {
                console.error('init error:', e);
            }
        }

        function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

        function togglePw(inputId, btn) {
            const inp = document.getElementById(inputId);
            if (inp.type === 'password') { inp.type = 'text'; btn.textContent = 'ğŸ™ˆ'; }
            else { inp.type = 'password'; btn.textContent = 'ğŸ‘'; }
        }

        // â”€â”€ Navigation â”€â”€
        function updateProgressBar() {
            const bar = document.getElementById('progressBar');
            bar.innerHTML = '';
            for (let i = 0; i < TOTAL_STEPS; i++) {
                const seg = document.createElement('div');
                seg.className = 'progress-segment' + (i < currentStep ? ' done' : i === currentStep ? ' active' : '');
                bar.appendChild(seg);
            }
        }

        function showStep(n) {
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            const el = document.getElementById(`step-${n}`);
            if (el) el.classList.add('active');
            currentStep = n;
            updateProgressBar();
            // è¿›å…¥ Step 4 æ—¶åˆå§‹åŒ–åŒæ­¥è§„åˆ™ UI
            if (n === 4) initSyncRulesStep();
            if (n === 7) initAttnStep();
            updateNextBtnText();
        }

        /* åŠ¨æ€æŒ‰é’®æ–‡æœ¬ï¼šå¯é€‰æ­¥éª¤æ— å†…å®¹æ—¶æ˜¾ç¤º "è·³è¿‡"ï¼Œæœ‰å†…å®¹æ—¶æ˜¾ç¤º "ä¸‹ä¸€æ­¥" */
        function updateNextBtnText() {
            const map = {
                2: () => !!(document.getElementById('input-cf-token').value.trim() && document.getElementById('input-cf-domain').value.trim()),
                3: () => !!_selectedRcloneMethod,
                4: () => document.querySelectorAll('.wz-rule-card.selected').length > 0,
                5: () => !!document.getElementById('input-civitai-token').value.trim(),
                7: () => document.querySelectorAll('#attn-cards .choice-card.selected').length > 0,
            };
            for (const [step, hasContent] of Object.entries(map)) {
                const btn = document.getElementById(`btn-next-${step}`);
                if (btn) btn.textContent = hasContent() ? 'ä¸‹ä¸€æ­¥' : 'è·³è¿‡';
            }
        }

        async function validateCfToken() {
            const token = document.getElementById('input-cf-token').value.trim();
            const domain = document.getElementById('input-cf-domain').value.trim();
            const el = document.getElementById('cf-validate-inline');
            if (!token || !domain) {
                el.style.display = 'inline';
                el.style.color = 'var(--red)';
                el.innerHTML = 'âŒ è¯·å¡«å†™ API Token å’ŒåŸŸå';
                return;
            }
            el.style.display = 'inline';
            el.style.color = 'var(--t2)';
            el.innerHTML = 'â³ éªŒè¯ä¸­...';
            try {
                const r = await fetch('/api/tunnel/validate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ api_token: token, domain: domain })
                });
                const d = await r.json();
                if (d.ok) {
                    el.style.color = 'var(--green)';
                    el.innerHTML = `âœ… ${esc(d.message)} Â· è´¦æˆ·: ${esc(d.account_name)}`;
                } else {
                    el.style.color = 'var(--red)';
                    el.innerHTML = `âŒ ${esc(d.message || d.error || 'éªŒè¯å¤±è´¥')}`;
                }
            } catch (e) {
                el.style.color = 'var(--red)';
                el.innerHTML = 'âŒ éªŒè¯è¯·æ±‚å¤±è´¥: ' + esc(e.message);
            }
        }

        function nextStep() {
            saveCurrentStep();

            // Step 1: å¯†ç æ£€æŸ¥ (ç©ºå¯†ç  / ä¸ä¸€è‡´)
            if (currentStep === 1) {
                const pw = document.getElementById('input-password').value;
                const pw2 = document.getElementById('input-password-confirm').value;
                const hint = document.getElementById('pw-mismatch-hint');
                if (!pw || !pw2) return;
                if (pw !== pw2) {
                    hint.style.display = 'block';
                    document.getElementById('input-password-confirm').focus();
                    return;
                }
                hint.style.display = 'none';
            }

            // Step 3: Rclone é…ç½®å®Œæ•´æ€§æ£€æŸ¥ (æ— é€‰æ‹© = è·³è¿‡)
            if (currentStep === 3) {
                const m = _selectedRcloneMethod;
                if (m === 'file' && !wizardConfig.rclone_config_value) {
                    alert('è¯·å…ˆä¸Šä¼  rclone.conf æ–‡ä»¶');
                    return;
                }
                if (m === 'manual' && wizardConfig.wizard_remotes.length === 0) {
                    alert('è¯·å…ˆæ·»åŠ è‡³å°‘ä¸€ä¸ª Remote');
                    return;
                }
            }

            // æ¢å¤æ¨¡å¼: ä» step 0 ç›´æ¥è·³åˆ°ç¡®è®¤éƒ¨ç½²
            if (currentStep === 0 && importedConfig) {
                showStep(TOTAL_STEPS - 1);
                // æ¢å¤æ¨¡å¼ä¸‹å¼‚æ­¥æ£€æµ‹ rclone remotes (DOM radio æœªé€‰ä¸­ï¼Œæ‰‹åŠ¨è°ƒ API)
                if (wizardConfig.rclone_config_value) {
                    fetch('/api/setup/preview_remotes', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ method: wizardConfig.rclone_config_method || 'base64', value: wizardConfig.rclone_config_value })
                    }).then(r => r.json()).then(d => {
                        _detectedRemotes = d.remotes || [];
                        renderSummary();
                    }).catch(() => renderSummary());
                } else {
                    renderSummary();
                }
                return;
            }
            // Step 3 (rclone) æ— é…ç½® â†’ è·³è¿‡ Step 4 (sync rules)
            if (currentStep === 3 && !_selectedRcloneMethod && wizardConfig.wizard_remotes.length === 0) {
                showStep(5);
                return;
            }
            if (currentStep < TOTAL_STEPS - 1) {
                showStep(currentStep + 1);
                if (currentStep === TOTAL_STEPS - 1) renderSummary();
            }
        }

        function prevStep() {
            if (currentStep === TOTAL_STEPS - 1 && importedConfig) {
                showStep(0);
                return;
            }
            // Step 5 â†’ å¦‚æœ rclone æ— é…ç½®ä¸”æ— æ‰‹åŠ¨ remoteï¼Œè·³å› Step 3
            if (currentStep === 5 && !_selectedRcloneMethod && wizardConfig.wizard_remotes.length === 0) {
                showStep(3);
                return;
            }
            if (currentStep > 0) showStep(currentStep - 1);
        }

        function saveCurrentStep() {
            switch (currentStep) {
                case 1:
                    wizardConfig.password = document.getElementById('input-password').value;
                    break;
                case 2:
                    wizardConfig.cf_api_token = document.getElementById('input-cf-token').value.trim();
                    wizardConfig.cf_domain = document.getElementById('input-cf-domain').value.trim();
                    wizardConfig.cf_subdomain = document.getElementById('input-cf-subdomain').value.trim();
                    break;
                case 3: {
                    const method = _selectedRcloneMethod || 'skip';
                    wizardConfig._rclone_display_method = method;
                    if (method === 'file') {
                        wizardConfig.rclone_config_method = 'base64';
                    } else if (method === 'manual') {
                        wizardConfig.rclone_config_method = 'skip';
                    } else {
                        wizardConfig.rclone_config_method = method;
                        if (method === 'url') wizardConfig.rclone_config_value = document.getElementById('input-rclone-url').value.trim();
                        else if (method === 'base64') wizardConfig.rclone_config_value = document.getElementById('input-rclone-base64').value.trim();
                        else if (method === 'base64_env') wizardConfig.rclone_config_value = '';
                        else wizardConfig.rclone_config_value = '';
                    }
                    break;
                }
                case 4: {
                    // æ”¶é›†å·²é€‰ä¸­çš„åŒæ­¥è§„åˆ™ (å¡ç‰‡ .selected)
                    const rules = [];
                    document.querySelectorAll('.wz-rule-card.selected').forEach(card => {
                        const tplId = card.dataset.tplId;
                        if (!tplId) return;
                        const remoteSel = card.querySelector('.wz-rule-remote');
                        const pathInput = card.querySelector('.wz-rule-path');
                        rules.push({
                            template_id: tplId,
                            remote: remoteSel?.value || '',
                            remote_path: pathInput?.value || '',
                        });
                    });
                    wizardConfig.wizard_sync_rules = rules;
                    break;
                }
                case 5:
                    wizardConfig.civitai_token = document.getElementById('input-civitai-token').value.trim();
                    break;
                case 6:
                    wizardConfig.plugins = getSelectedPlugins();
                    const auraCb = document.getElementById('aura-model-dl');
                    if (auraCb) wizardConfig.download_aura_model = auraCb.checked;
                    break;
                case 7: {
                    wizardConfig.install_fa2 = document.getElementById('attn-card-fa2').classList.contains('selected');
                    wizardConfig.install_sa2 = document.getElementById('attn-card-sa2').classList.contains('selected');
                    break;
                }
            }
            // Persist to backend
            fetch('/api/setup/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ...wizardConfig, current_step: currentStep })
            }).catch(() => { });
        }

        // â”€â”€ Mode Selection â”€â”€
        function selectMode(mode) {
            document.querySelectorAll('.choice-card').forEach(c => c.classList.remove('selected'));
            if (mode === 'import') {
                document.getElementById('choice-import').classList.add('selected');
                document.getElementById('import-upload-area').style.display = 'block';
                document.getElementById('btn-next-0').disabled = true;
                importedConfig = null;
                return;
            }
            document.getElementById('import-upload-area').style.display = 'none';
            document.getElementById('import-result').style.display = 'none';
            importedConfig = null;
            document.getElementById('choice-fresh').classList.add('selected');
            document.getElementById('btn-next-0').disabled = false;
        }

        // â”€â”€ Rclone Config â”€â”€
        let _selectedRcloneMethod = '';

        function selectRcloneMethod(method) {
            // å†æ¬¡ç‚¹å‡»å·²é€‰ä¸­çš„å¡ç‰‡ â†’ åé€‰ï¼ˆå›åˆ°æœªé€‰çŠ¶æ€ï¼‰
            if (_selectedRcloneMethod === method) {
                _selectedRcloneMethod = '';
                document.querySelectorAll('#rclone-method-cards .choice-card').forEach(c => c.classList.remove('selected'));
                document.getElementById('rclone-input-area').style.display = 'none';
                updateNextBtnText();
                return;
            }
            _selectedRcloneMethod = method;
            // æ›´æ–°å¡ç‰‡é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('#rclone-method-cards .choice-card').forEach(c => {
                c.classList.toggle('selected', c.dataset.rclone === method);
            });
            // åˆ‡æ¢ input åŒºåŸŸ
            const area = document.getElementById('rclone-input-area');
            const needsInput = ['file', 'manual'].includes(method);
            area.style.display = needsInput ? 'block' : 'none';
            document.getElementById('rclone-file-input').style.display = method === 'file' ? 'block' : 'none';
            document.getElementById('rclone-manual-input').style.display = method === 'manual' ? 'block' : 'none';
            // è§¦å‘ remote æ£€æµ‹
            if (method !== 'skip' && method !== 'manual') {
                clearTimeout(window._rcloneDetectTimer);
                window._rcloneDetectTimer = setTimeout(() => detectRemotes(), 300);
            } else if (method === 'skip') {
                document.getElementById('wizard-remotes-section').style.display = 'none';
                _detectedRemotes = [];
            }
            updateNextBtnText();
        }

        function handleRcloneFile(event) {
            const file = event.target.files?.[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = () => {
                wizardConfig.rclone_config_value = btoa(reader.result);
                document.getElementById('rclone-file-status').textContent = `âœ… ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
                detectRemotes();
            };
            reader.readAsText(file);
        }

        async function detectRemotes() {
            const method = _selectedRcloneMethod || 'skip';
            let value = '';
            if (method === 'file' || method === 'base64') {
                value = wizardConfig.rclone_config_value || document.getElementById('input-rclone-base64')?.value?.trim() || '';
            } else if (method === 'url') {
                value = document.getElementById('input-rclone-url')?.value?.trim() || '';
            }
            if (method === 'skip') return;
            try {
                const r = await fetch('/api/setup/preview_remotes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ method, value })
                });
                const d = await r.json();
                _detectedRemotes = d.remotes || [];
                const section = document.getElementById('wizard-remotes-section');
                const list = document.getElementById('wizard-remotes-list');
                if (_detectedRemotes.length > 0) {
                    section.style.display = 'block';
                    list.innerHTML = _detectedRemotes.map(r =>
                        `<span class="wz-remote-chip">${esc(r.name)} <span class="wz-rtype">${esc(r.type)}</span></span>`
                    ).join('');
                } else if (method === 'url') {
                    section.style.display = 'block';
                    list.innerHTML = '<span style="font-size:.82rem;color:var(--t3)">URL é…ç½®å°†åœ¨éƒ¨ç½²æ—¶ä¸‹è½½ï¼ŒRemote ååœ¨ä¸‹ä¸€æ­¥å¯æ‰‹åŠ¨è¾“å…¥</span>';
                } else if (method === 'base64_env') {
                    section.style.display = 'block';
                    list.innerHTML = '<span style="font-size:.82rem;color:var(--t3)">å°†ä»ç¯å¢ƒå˜é‡è¯»å–ï¼ŒRemote ååœ¨éƒ¨ç½²æ—¶è‡ªåŠ¨æ£€æµ‹</span>';
                } else {
                    section.style.display = 'none';
                }
            } catch (e) {
                console.error('detectRemotes error:', e);
            }
        }

        // â”€â”€ Add Remote (Wizard) â”€â”€
        function toggleWizardAddRemote() {
            // Legacy: æ‰‹åŠ¨åˆ›å»ºå·²æ•´åˆåˆ° rclone-manual-input å¡ç‰‡ä¸­ï¼Œæ­¤å‡½æ•°ä¿ç•™å…¼å®¹
            const form = document.getElementById('wizard-add-remote-form') || document.getElementById('rclone-manual-input');
            if (form) form.style.display = form.style.display === 'none' ? 'block' : 'none';
        }

        function renderWizardRemoteFields() {
            const type = document.getElementById('wz-remote-type').value;
            const container = document.getElementById('wz-remote-fields');
            if (!type || !_remoteTypeDefs[type]) { container.innerHTML = ''; return; }
            const def = _remoteTypeDefs[type];
            let html = '';
            if (def.oauth) {
                html += `<div style="background:var(--bg2);border:1px solid var(--bd);border-radius:8px;padding:10px;margin-bottom:10px;font-size:.8rem;color:var(--t2)">
            <b>OAuth æˆæƒæ­¥éª¤:</b><br>
            1. åœ¨æœ¬åœ°ç”µè„‘å®‰è£… <a href="https://rclone.org/downloads/" target="_blank" style="color:var(--accent)">rclone</a><br>
            2. è¿è¡Œ: <code style="background:var(--bg3);padding:2px 6px;border-radius:4px">rclone authorize "${type}"</code><br>
            3. å°†ç»ˆç«¯è¾“å‡ºçš„ token JSON ç²˜è´´åˆ°ä¸‹æ–¹</div>`;
            }
            for (const f of def.fields) {
                const val = f.default || '';
                const req = f.required ? ' <span style="color:var(--red)">*</span>' : '';
                html += `<div class="form-group"><label>${f.label}${req}</label>`;
                if (f.type === 'select') {
                    html += `<select id="wz-rf-${f.key}" style="width:100%">${(f.options || []).map(o =>
                        `<option value="${o}"${o === val ? ' selected' : ''}>${o}</option>`).join('')}</select>`;
                } else if (f.type === 'textarea') {
                    html += `<textarea id="wz-rf-${f.key}" style="width:100%;min-height:80px;font-family:monospace;font-size:.78rem" placeholder="${f.placeholder || ''}"></textarea>`;
                    if (f.help) html += `<div style="font-size:.72rem;color:var(--t3);margin-top:2px">${f.help}</div>`;
                } else {
                    html += `<input type="${f.type === 'password' ? 'password' : 'text'}" id="wz-rf-${f.key}" value="${esc(val)}" placeholder="${f.placeholder || ''}" style="width:100%">`;
                }
                html += '</div>';
            }
            container.innerHTML = html;
        }

        function submitWizardRemote() {
            const name = document.getElementById('wz-remote-name').value.trim();
            const type = document.getElementById('wz-remote-type').value;
            if (!name || !type) { alert('è¯·å¡«å†™åç§°å’Œç±»å‹'); return; }
            if (!/^[a-zA-Z0-9_-]+$/.test(name)) { alert('åç§°åªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿å’ŒçŸ­æ¨ªçº¿'); return; }
            // æ£€æŸ¥é‡å¤
            const allNames = [..._detectedRemotes.map(r => r.name), ...wizardConfig.wizard_remotes.map(r => r.name)];
            if (allNames.includes(name)) { alert(`Remote "${name}" å·²å­˜åœ¨`); return; }
            const def = _remoteTypeDefs[type];
            if (!def) return;
            const params = {};
            for (const f of def.fields) {
                const el = document.getElementById('wz-rf-' + f.key);
                if (el) params[f.key] = el.value.trim();
                if (f.required && !params[f.key]) { alert(`è¯·å¡«å†™ ${f.label}`); return; }
            }
            wizardConfig.wizard_remotes.push({ name, type, params });
            renderWizardManualRemotes();
            // Reset form
            document.getElementById('wz-remote-name').value = '';
            document.getElementById('wz-remote-type').value = '';
            document.getElementById('wz-remote-fields').innerHTML = '';
            toggleWizardAddRemote();
            // æ·»åŠ åæ˜¾ç¤ºæç¤º
            const status = document.createElement('div');
            status.className = 'form-hint';
            status.style.color = 'var(--green)';
            status.textContent = `âœ… Remote "${name}" å·²æ·»åŠ `;
            document.getElementById('rclone-manual-input').appendChild(status);
            setTimeout(() => status.remove(), 3000);
        }

        function removeWizardRemote(name) {
            wizardConfig.wizard_remotes = wizardConfig.wizard_remotes.filter(r => r.name !== name);
            renderWizardManualRemotes();
        }

        function renderWizardManualRemotes() {
            const section = document.getElementById('wizard-manual-remotes');
            const list = document.getElementById('wizard-manual-remotes-list');
            if (wizardConfig.wizard_remotes.length > 0) {
                section.style.display = 'block';
                list.innerHTML = wizardConfig.wizard_remotes.map(r => {
                    const def = _remoteTypeDefs[r.type] || {};
                    return `<span class="wz-remote-chip">${def.icon || 'ğŸ’¾'} ${esc(r.name)} <span class="wz-rtype">${esc(def.label || r.type)}</span>
                <button onclick="removeWizardRemote('${esc(r.name)}')" style="background:none;border:none;color:var(--red);cursor:pointer;font-size:.8rem;margin-left:4px" title="ç§»é™¤">âœ•</button></span>`;
                }).join('');
            } else {
                section.style.display = 'none';
            }
        }

        // â”€â”€ Sync Rules Step (Step 4) â”€â”€
        function getAllRemoteNames() {
            const names = new Set();
            _detectedRemotes.forEach(r => names.add(r.name));
            wizardConfig.wizard_remotes.forEach(r => names.add(r.name));
            return [...names];
        }

        function initSyncRulesStep() {
            const remotes = getAllRemoteNames();
            const defaultRemoteSel = document.getElementById('wz-default-remote');
            const currentDefault = defaultRemoteSel.value;
            defaultRemoteSel.innerHTML = remotes.length === 0
                ? '<option value="">ï¼ˆæ— å¯ç”¨ Remoteï¼‰</option>'
                : remotes.map(n => `<option value="${esc(n)}">${esc(n)}</option>`).join('');
            if (currentDefault && remotes.includes(currentDefault)) {
                defaultRemoteSel.value = currentDefault;
            }

            // Pull templates
            const pullTpls = _syncTemplates.filter(t => t.direction === 'pull');
            const pushTpls = _syncTemplates.filter(t => t.direction === 'push');

            const savedRules = wizardConfig.wizard_sync_rules || [];
            const savedMap = {};
            savedRules.forEach(r => { savedMap[r.template_id] = r; });

            const defaultRemote = defaultRemoteSel.value || remotes[0] || '';

            document.getElementById('wz-pull-rules').innerHTML = pullTpls.map(t => renderRuleItem(t, savedMap[t.id], defaultRemote, remotes)).join('');
            document.getElementById('wz-push-rules').innerHTML = pushTpls.map(t => renderRuleItem(t, savedMap[t.id], defaultRemote, remotes)).join('');

            // Enable drag-to-scroll on rule rows
            document.querySelectorAll('.wz-rule-row').forEach(initDragScroll);
            updateRuleCount();
        }

        function renderRuleItem(tpl, saved, defaultRemote, remotes) {
            const isSelected = saved ? true : false;
            const remote = saved?.remote || defaultRemote;
            const remotePath = saved?.remote_path || tpl.remote_path || '';
            const methodTag = tpl.method === 'move' ? 'ç§»åŠ¨' : 'ä¿ç•™æœ¬åœ°';
            const triggerTag = tpl.trigger === 'deploy' ? 'éƒ¨ç½²æ‰§è¡Œ' : tpl.trigger === 'watch' ? 'æŒç»­ç›‘æ§' : 'æ‰‹åŠ¨';
            const remoteOpts = remotes.length === 0
                ? `<input type="text" class="wz-rule-remote" value="${esc(remote)}" placeholder="remote" onclick="event.stopPropagation()">`
                : `<select class="wz-rule-remote" onclick="event.stopPropagation()">${remotes.map(n => `<option value="${esc(n)}"${n === remote ? ' selected' : ''}>${esc(n)}</option>`).join('')}</select>`;
            // ç®€çŸ­åç§° (å»æ‰ emoji å‰ç¼€)
            const shortName = tpl.name.replace(/^[â¬‡ï¸â¬†ï¸ğŸ“¥ğŸ“¤]\s*/, '');

            return `<div class="wz-rule-card${isSelected ? ' selected' : ''}" data-tpl-id="${esc(tpl.id)}">
        <div class="wz-rule-check" onclick="toggleRuleCard(this.parentElement)">âœ“</div>
        <div class="rule-name">${esc(shortName)}</div>
        <div class="rule-method">${triggerTag} Â· ${methodTag}</div>
        <div class="rule-field">
            <label>Remote</label>
            ${remoteOpts}
        </div>
        <div class="rule-field">
            <label>äº‘ç«¯è·¯å¾„</label>
            <input type="text" class="wz-rule-path" value="${esc(remotePath)}" placeholder="è¿œç«¯è·¯å¾„" onclick="event.stopPropagation()">
        </div>
        <div class="rule-local" title="${esc(tpl.local_path)}">ğŸ“‚ ${esc(tpl.local_path)}</div>
    </div>`;
        }

        function toggleRuleCard(card) {
            card.classList.toggle('selected');
            updateNextBtnText();
            updateRuleCount();
        }

        function updateRuleCount() {
            const n = document.querySelectorAll('.wz-rule-card.selected').length;
            const el = document.getElementById('wz-rule-count');
            if (el) el.textContent = `å·²é€‰è§„åˆ™ï¼š${n} Â· éƒ¨ç½²åå¯åœ¨ ComfyCarry äº‘åŒæ­¥é¡µä¿®æ”¹`;
        }

        function initDragScroll(el) {
            let isDown = false, startX, scrollLeft;
            el.addEventListener('mousedown', e => {
                if (e.target.closest('input,select,button')) return;
                isDown = true; startX = e.pageX - el.offsetLeft; scrollLeft = el.scrollLeft;
                el.style.cursor = 'grabbing'; e.preventDefault();
            });
            el.addEventListener('mouseleave', () => { isDown = false; el.style.cursor = 'grab'; });
            el.addEventListener('mouseup', () => { isDown = false; el.style.cursor = 'grab'; });
            el.addEventListener('mousemove', e => {
                if (!isDown) return;
                const x = e.pageX - el.offsetLeft;
                el.scrollLeft = scrollLeft - (x - startX);
            });
        }

        function updateWizardRuleRemotes() {
            const defaultRemote = document.getElementById('wz-default-remote').value;
            document.querySelectorAll('.wz-rule-card .wz-rule-remote').forEach(el => {
                if (el.tagName === 'SELECT') el.value = defaultRemote;
                else el.value = defaultRemote;
            });
        }

        // â”€â”€ Plugins â”€â”€
        function renderPluginList(plugins, selectedUrls) {
            const list = document.getElementById('plugin-list');
            const desc = document.getElementById('plugin-step-desc');
            const sorted = [...plugins].sort((a, b) => (b.required ? 1 : 0) - (a.required ? 1 : 0));
            desc.textContent = 'âš¡ é¢„æ„å»ºé•œåƒå·²åŒ…å«ä»¥ä¸‹æ’ä»¶';
            const auraUrl = 'https://github.com/GreenLandisaLie/AuraSR-ComfyUI';
            list.innerHTML = sorted.map((p, i) => {
                const isAura = p.url === auraUrl;
                return `<div class="plugin-item">
            <input type="checkbox" id="plugin-${i}" checked disabled data-url="${esc(p.url)}">
            <span class="plugin-name">${esc(p.name)} <span class="plugin-required">é¢„è£…</span></span>
            ${isAura ? `<label style="margin-left:auto;font-size:.82rem;color:var(--t2);display:flex;align-items:center;gap:4px;cursor:pointer">
                <input type="checkbox" id="aura-model-dl" ${wizardConfig.download_aura_model ? 'checked' : ''} style="width:14px;height:14px">
                ä¸‹è½½æ¨¡å‹ (~234MB)
            </label>` : ''}
        </div>`;
            }).join('');
        }

        function getSelectedPlugins() {
            const urls = [];
            document.querySelectorAll('#plugin-list input[type="checkbox"]').forEach(cb => {
                if (cb.checked) urls.push(cb.dataset.url);
            });
            const extra = document.getElementById('input-extra-plugins').value.trim();
            if (extra) {
                extra.split('\n').forEach(u => {
                    u = u.trim();
                    if (u && u.startsWith('http')) urls.push(u);
                });
            }
            return urls;
        }

        // â”€â”€ Attention Acceleration â”€â”€
        function initAttnStep() {
            const fa2Card = document.getElementById('attn-card-fa2');
            const sa2Card = document.getElementById('attn-card-sa2');

            // é¢„æ„å»ºé•œåƒ: FA2 å·²é¢„è£… â†’ é»˜è®¤é€‰ä¸­ + ä¸å¯å–æ¶ˆ
            fa2Card.classList.add('selected');
            fa2Card.style.opacity = '0.7';
            fa2Card.style.pointerEvents = 'none';
            fa2Card.querySelector('p').textContent = 'å·²é¢„è£…åœ¨é•œåƒä¸­';
            document.getElementById('attn-step-desc').textContent = 'âš¡ FA2 å·²é¢„è£…ï¼Œå¯é€‰æ‹©é¢å¤–å®‰è£… SA2';

            if (wizardConfig.install_sa2) sa2Card.classList.add('selected');

            updateAttnHint();
            updateNextBtnText();
        }

        function toggleAttnCard(type) {
            const card = document.getElementById(`attn-card-${type}`);
            // é¢„æ„å»ºä¸‹ FA2 ä¸å¯å–æ¶ˆ
            if (type === 'fa2') return;  // FA2 å·²é¢„è£…ï¼Œä¸å¯å–æ¶ˆ
            card.classList.toggle('selected');
            updateAttnHint();
            updateNextBtnText();
        }

        function updateAttnHint() {
            const fa2 = document.getElementById('attn-card-fa2').classList.contains('selected');
            const sa2 = document.getElementById('attn-card-sa2').classList.contains('selected');
            const el = document.getElementById('attn-hint');
            if (fa2 && sa2) {
                el.textContent = 'ğŸ’¡ ä¸¤è€…åŒæ—¶å®‰è£…æ—¶ï¼ŒComfyUI å°†ä¼˜å…ˆä½¿ç”¨ FlashAttention-2';
            } else if (fa2) {
                el.textContent = 'ğŸ”¥ ComfyUI å°†ä½¿ç”¨ --use-flash-attention å¯åŠ¨';
            } else if (sa2) {
                el.textContent = 'ğŸŒ¿ ComfyUI å°†ä½¿ç”¨ --use-sage-attention å¯åŠ¨';
            } else {
                el.textContent = 'è·³è¿‡å ComfyUI å°†ä½¿ç”¨é»˜è®¤ PyTorch SDPA';
            }
        }

        // â”€â”€ Summary â”€â”€
        function renderSummary() {
            saveCurrentStep();
            const c = wizardConfig;
            const pluginCount = (c.plugins || []).length;
            // å¯¼å…¥çš„è§„åˆ™ç›´æ¥å†™å…¥æ–‡ä»¶, ä¸åœ¨ wizard_sync_rules ä¸­
            const wizardRuleCount = (c.wizard_sync_rules || []).length;
            const importedRuleCount = (c._imported_sync_rules && importedConfig?.sync_rules?.length) || 0;
            const ruleCount = wizardRuleCount || importedRuleCount;
            const remoteCount = _detectedRemotes.length + (c.wizard_remotes || []).length;
            let importNote = '';
            if (importedConfig) {
                importNote = `
        <div class="summary-card" style="border-color:var(--accent)">
            <h4>ğŸ“¦ ä»é…ç½®æ–‡ä»¶æ¢å¤</h4>
            <div class="summary-row"><span class="label">å¯¼å‡ºæ—¶é—´</span><span class="value">${esc(importedConfig._exported_at || 'æœªçŸ¥')}</span></div>
        </div>`;
            }
            // Sync rules summary
            const tplMap = {};
            _syncTemplates.forEach(t => { tplMap[t.id] = t; });
            let ruleNames = (c.wizard_sync_rules || []).map(r => tplMap[r.template_id]?.name || r.template_id).join(', ');
            if (!ruleNames && importedRuleCount > 0) {
                ruleNames = (importedConfig.sync_rules || []).map(r => r.name || r.id || '').filter(Boolean).join(', ');
            }
            const dm = c._rclone_display_method || c.rclone_config_method;

            const html = importNote + `
        <div class="summary-card">
            <h4>éƒ¨ç½²æ–¹å¼</h4>
            <div class="summary-row"><span class="label">é•œåƒç±»å‹</span><span class="value">âš¡ é¢„æ„å»ºé•œåƒ</span></div>
        </div>
        <div class="summary-card">
            <h4>ç½‘ç»œä¸å®‰å…¨</h4>
            <div class="summary-row"><span class="label">ComfyCarry å¯†ç </span><span class="value">${c.password ? 'å·²è®¾ç½®' : 'æœªè®¾ç½®'}</span></div>
            <div class="summary-row"><span class="label">Cloudflare Tunnel</span><span class="value">${c.cf_api_token ? 'âœ… ' + (c.cf_subdomain || 'auto') + '.' + c.cf_domain : 'â­ è·³è¿‡'}</span></div>
        </div>
        <div class="summary-card">
            <h4>äº‘å­˜å‚¨ä¸åŒæ­¥</h4>
            <div class="summary-row"><span class="label">Rclone é…ç½®</span><span class="value">${!dm || dm === 'skip' ? 'â­ è·³è¿‡' : dm === 'file' ? 'ğŸ“‚ æ–‡ä»¶ä¸Šä¼ ' : dm === 'manual' ? 'ğŸ”§ æ‰‹åŠ¨åˆ›å»º' : dm === 'base64_env' ? 'ğŸ”‘ ç¯å¢ƒå˜é‡' : 'ğŸ“‹ Base64'}</span></div>
            <div class="summary-row"><span class="label">Remote æ•°é‡</span><span class="value">${remoteCount} ä¸ª${c.wizard_remotes.length ? ' (å« ' + c.wizard_remotes.length + ' ä¸ªæ‰‹åŠ¨åˆ›å»º)' : ''}</span></div>
            <div class="summary-row"><span class="label">åŒæ­¥è§„åˆ™</span><span class="value">${ruleCount > 0 ? ruleCount + ' æ¡' : 'æ— '}</span></div>
            ${ruleNames ? `<div class="summary-row"><span class="label">è§„åˆ™è¯¦æƒ…</span><span class="value" style="font-size:.82rem">${esc(ruleNames)}</span></div>` : ''}
        </div>
        <div class="summary-card">
            <h4>æ¨¡å‹ä¸æ’ä»¶</h4>
            <div class="summary-row"><span class="label">CivitAI API Key</span><span class="value">${c.civitai_token ? 'âœ… å·²é…ç½®' : 'â­ è·³è¿‡'}</span></div>
            <div class="summary-row"><span class="label">æ’ä»¶æ•°é‡</span><span class="value">${pluginCount} ä¸ª</span></div>
            <div class="summary-row"><span class="label">AuraSR æ¨¡å‹</span><span class="value">${c.download_aura_model ? 'âœ… ä¸‹è½½' : 'â­ è·³è¿‡'}</span></div>
        </div>
        <div class="summary-card">
            <h4>Attention åŠ é€Ÿ</h4>
            <div class="summary-row"><span class="label">FlashAttention-2</span><span class="value">${c.install_fa2 ? 'âœ… å®‰è£…' : 'â­ è·³è¿‡'}</span></div>
            <div class="summary-row"><span class="label">SageAttention-2</span><span class="value">${c.install_sa2 ? 'âœ… å®‰è£…' : 'â­ è·³è¿‡'}</span></div>
        </div>`;
            document.getElementById('deploy-summary').innerHTML = html;
        }

        // â”€â”€ Deploy â”€â”€
        async function startDeploy() {
            saveCurrentStep();
            document.getElementById('btn-deploy').disabled = true;
            try {
                const r = await fetch('/api/setup/deploy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(wizardConfig)
                });
                const d = await r.json();
                if (!d.ok) { alert('éƒ¨ç½²å¯åŠ¨å¤±è´¥: ' + (d.error || '')); return; }
            } catch (e) { alert('è¯·æ±‚å¤±è´¥: ' + e.message); return; }
            showDeployView();
            connectSSE();
        }

        function showDeployView() {
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            document.getElementById('deploy-view').classList.add('active');
            document.getElementById('progressBar').style.display = 'none';
            document.querySelector('.wizard-container').style.maxWidth = '1400px';
            startElapsedTimer();
        }

        let elapsedTimer = null;
        let deployStartTime = Date.now();

        function startElapsedTimer() {
            if (elapsedTimer) clearInterval(elapsedTimer);
            deployStartTime = Date.now();
            elapsedTimer = setInterval(() => {
                const s = Math.floor((Date.now() - deployStartTime) / 1000);
                const m = Math.floor(s / 60);
                const sec = s % 60;
                document.getElementById('deploy-elapsed').textContent = `å·²ç”¨æ—¶: ${m > 0 ? m + ' åˆ† ' : ''}${sec} ç§’`;
            }, 1000);
        }

        let completedSteps = [];
        let sseCompleted = false;

        function connectSSE() {
            sseCompleted = false;
            const evtSource = new EventSource('/api/setup/log_stream');
            const logEl = document.getElementById('deploy-log');
            const stepsEl = document.getElementById('deploy-steps-list');
            // é‡è¿æ—¶æ¸…ç©ºå·²æœ‰å†…å®¹ï¼Œé¿å…é‡å¤æ˜¾ç¤º
            stepsEl.innerHTML = '';
            logEl.innerHTML = '';
            completedSteps = [];

            evtSource.onmessage = (event) => {
                const data = JSON.parse(event.data);

                if (data.type === 'step') {
                    if (completedSteps.length > 0) {
                        const prev = stepsEl.querySelector('.deploy-step-item.active');
                        if (prev) { prev.classList.remove('active'); prev.classList.add('done'); prev.querySelector('.step-icon').textContent = 'âœ…'; }
                    }
                    completedSteps.push(data.name);
                    const item = document.createElement('div');
                    item.className = 'deploy-step-item active';
                    item.innerHTML = `<span class="step-icon">â³</span>${esc(data.name)}`;
                    stepsEl.appendChild(item);
                    return;
                }

                if (data.type === 'done') {
                    sseCompleted = true;
                    evtSource.close();
                    if (elapsedTimer) clearInterval(elapsedTimer);
                    const lastActive = stepsEl.querySelector('.deploy-step-item.active');
                    if (lastActive) {
                        lastActive.classList.remove('active');
                        if (data.success) {
                            lastActive.classList.add('done');
                            lastActive.querySelector('.step-icon').textContent = 'âœ…';
                        } else {
                            lastActive.style.color = 'var(--red)';
                            lastActive.querySelector('.step-icon').textContent = 'âŒ';
                        }
                    }
                    if (data.success) {
                        document.getElementById('deploy-title').textContent = 'âœ… éƒ¨ç½²å®Œæˆ';
                        const doneEl = document.createElement('div');
                        doneEl.className = 'log-line info';
                        doneEl.style.color = 'var(--green)';
                        doneEl.style.fontWeight = '600';
                        doneEl.textContent = 'ğŸ‰ éƒ¨ç½²å®Œæˆï¼';
                        logEl.appendChild(doneEl);
                        // æ˜¾ç¤º attention å®‰è£…è­¦å‘Š (å¦‚æœ‰)
                        if (data.attn_warnings && data.attn_warnings.length > 0) {
                            const names = data.attn_warnings.join(' / ');
                            const warnEl = document.createElement('div');
                            warnEl.className = 'log-line warn';
                            warnEl.style.color = 'var(--amber)';
                            warnEl.innerHTML = `âš ï¸ ${esc(names)} å®‰è£…å¤±è´¥ï¼Œå·²å›é€€åˆ° PyTorch SDPAã€‚å¯ç‚¹å‡»ã€Œé‡è¯•éƒ¨ç½²ã€æˆ–ç¨ååœ¨ ComfyUI é¡µé¢çš„å¯åŠ¨å‚æ•°ä¸­é‡æ–°é€‰æ‹©ã€‚`;
                            logEl.appendChild(warnEl);
                            document.getElementById('deploy-done-retry').style.display = '';
                        }
                        document.getElementById('deploy-done-row').style.display = 'flex';
                    } else {
                        document.getElementById('deploy-title').textContent = 'âŒ éƒ¨ç½²å¤±è´¥';
                        const errEl = document.createElement('div');
                        errEl.className = 'log-line error';
                        errEl.textContent = 'âŒ ' + (data.msg || 'éƒ¨ç½²å¤±è´¥');
                        logEl.appendChild(errEl);
                        const banner = document.getElementById('deploy-error-banner');
                        banner.style.display = 'block';
                        banner.innerHTML = `<strong>é”™è¯¯:</strong> ${esc(data.msg || 'éƒ¨ç½²è¿›ç¨‹å¼‚å¸¸ç»ˆæ­¢')}<br><small>å·²å®Œæˆçš„æ­¥éª¤ä¼šåœ¨é‡è¯•æ—¶è‡ªåŠ¨è·³è¿‡ï¼ŒèŠ‚çœæ—¶é—´ã€‚</small>`;
                        document.getElementById('deploy-fail-row').style.display = 'flex';
                    }
                    logEl.scrollTop = logEl.scrollHeight;
                    return;
                }

                if (data.type === 'log') {
                    const line = document.createElement('div');
                    line.className = `log-line ${data.level || 'info'}`;
                    const timeSpan = data.time ? `<span class="log-time">${esc(data.time)}</span>` : '';
                    line.innerHTML = `${timeSpan}${esc(data.msg)}`;
                    logEl.appendChild(line);
                    if (logEl.scrollHeight - logEl.scrollTop - logEl.clientHeight < 100) {
                        logEl.scrollTop = logEl.scrollHeight;
                    }
                }
            };

            evtSource.onerror = () => {
                evtSource.close();
                if (!sseCompleted) {
                    setTimeout(() => { connectSSE(); }, 3000);
                }
            };
        }

        function retryDeploy() {
            document.getElementById('deploy-steps-list').innerHTML = '';
            document.getElementById('deploy-log').innerHTML = '';
            document.getElementById('deploy-error-banner').style.display = 'none';
            document.getElementById('deploy-fail-row').style.display = 'none';
            document.getElementById('deploy-done-row').style.display = 'none';
            document.getElementById('deploy-done-retry').style.display = 'none';
            document.getElementById('deploy-title').textContent = 'âš™ï¸ æ­£åœ¨éƒ¨ç½²... (æ™ºèƒ½é‡è¯•)';
            completedSteps = [];
            sseCompleted = false;
            startDeploy();
        }

        function backToWizard() {
            document.getElementById('deploy-view').classList.remove('active');
            document.getElementById('progressBar').style.display = '';
            document.querySelector('.wizard-container').style.maxWidth = '';
            showStep(TOTAL_STEPS - 1);
            renderSummary();
        }

        async function handleImportFile(event) {
            const file = event.target.files?.[0];
            if (!file) return;
            event.target.value = '';
            try {
                const text = await file.text();
                const config = JSON.parse(text);

                if (!config._version) {
                    showImportResult('âŒ æ— æ•ˆçš„é…ç½®æ–‡ä»¶æ ¼å¼', true);
                    return;
                }

                // é•œåƒç±»å‹æ£€æŸ¥ (ä»…å…¼å®¹é¢„æ„å»ºé•œåƒ)

                const r = await fetch('/api/settings/import-config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: text
                });
                const d = await r.json();
                if (!d.ok) {
                    showImportResult('âŒ å¯¼å…¥å¤±è´¥: ' + esc(d.error || 'æœªçŸ¥é”™è¯¯'), true);
                    return;
                }

                importedConfig = config;
                wizardConfig.image_type = 'prebuilt';
                if (config.password) wizardConfig.password = config.password;
                if (config.cf_api_token) wizardConfig.cf_api_token = config.cf_api_token;
                if (config.cf_domain) wizardConfig.cf_domain = config.cf_domain;
                if (config.cf_subdomain) wizardConfig.cf_subdomain = config.cf_subdomain;
                if (config.civitai_token) wizardConfig.civitai_token = config.civitai_token;
                if (config.rclone_config_base64) {
                    wizardConfig.rclone_config_method = 'base64';
                    wizardConfig.rclone_config_value = config.rclone_config_base64;
                }
                if (config.extra_plugins !== undefined || config.disabled_default_plugins !== undefined) {
                    const defaultUrls = pluginData.map(p => p.url);
                    const disabled = new Set(config.disabled_default_plugins || []);
                    const plugins = defaultUrls.filter(u => !disabled.has(u));
                    plugins.push(...(config.extra_plugins || []));
                    wizardConfig.plugins = plugins;
                }
                if (config.sync_rules && config.sync_rules.length > 0) {
                    wizardConfig._imported_sync_rules = true;
                }
                if (config.install_fa2 !== undefined) wizardConfig.install_fa2 = config.install_fa2;
                if (config.install_sa2 !== undefined) wizardConfig.install_sa2 = config.install_sa2;
                if (config.download_aura_model !== undefined) wizardConfig.download_aura_model = config.download_aura_model;

                showImportResult(
                    `âœ… å¯¼å…¥æˆåŠŸï¼å·²æ¢å¤ ${d.applied?.length || 0} é¡¹é…ç½®ã€‚<br><small>ç‚¹å‡»ã€Œä¸‹ä¸€æ­¥ã€æŸ¥çœ‹é…ç½®æ‘˜è¦å¹¶å¼€å§‹éƒ¨ç½²ã€‚</small>`,
                    false
                );
                document.getElementById('btn-next-0').disabled = false;

            } catch (e) {
                showImportResult('âŒ æ–‡ä»¶è§£æå¤±è´¥: ' + e.message, true);
            }
        }

        function showImportResult(html, isError) {
            const el = document.getElementById('import-result');
            el.style.display = 'block';
            el.innerHTML = html;
            el.style.background = isError ? 'rgba(255,80,80,0.12)' : 'rgba(74,222,128,0.12)';
            el.style.border = `1px solid ${isError ? 'var(--red)' : 'var(--green)'}`;
            el.style.color = isError ? 'var(--red)' : 'var(--green)';
        }

        // --- Detect remotes on text input change (debounced) ---
        document.addEventListener('input', (e) => {
            if (e.target.id === 'input-rclone-base64' || e.target.id === 'input-rclone-url') {
                clearTimeout(window._rcloneDetectTimer);
                window._rcloneDetectTimer = setTimeout(() => detectRemotes(), 800);
            }
        });

        // â”€â”€ Start â”€â”€
        init();
    </script>
</body>

</html>