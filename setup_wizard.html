<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ComfyUI éƒ¨ç½²å‘å¯¼</title>
<style>
:root {
    --bg1: #0a0a0f; --bg2: #12121e; --bg3: #1a1a28; --bg4: #22223a;
    --bd: #2a2a3e; --t1: #e8e8f0; --t2: #a8a8c0; --t3: #68688a;
    --accent: #7c5cfc; --accent2: #9078ff; --green: #4ade80; --red: #f87171;
    --r: 10px; --mono: 'JetBrains Mono', 'Fira Code', monospace;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'Inter', -apple-system, sans-serif; background: var(--bg1); color: var(--t1); min-height: 100vh; }

.wizard-container {
    max-width: 720px; margin: 0 auto; padding: 40px 20px;
}
.wizard-header {
    text-align: center; margin-bottom: 32px;
}
.wizard-header h1 {
    font-size: 1.8rem; font-weight: 700;
    background: linear-gradient(135deg, #7c5cfc, #e879f9);
    -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;
}
.wizard-header p { color: var(--t3); font-size: .85rem; margin-top: 6px; }

/* Progress bar */
.progress-bar { display: flex; gap: 4px; margin-bottom: 32px; }
.progress-segment {
    flex: 1; height: 4px; border-radius: 2px; background: var(--bg4);
    transition: background .3s;
}
.progress-segment.done { background: var(--accent); }
.progress-segment.active { background: var(--accent2); animation: pulse 1.5s infinite; }
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.5} }

/* Steps */
.step { display: none; }
.step.active { display: block; }
.step-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 6px; }
.step-desc { color: var(--t2); font-size: .85rem; margin-bottom: 20px; }

/* Cards for selection */
.choice-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
.choice-card {
    background: var(--bg3); border: 2px solid var(--bd); border-radius: var(--r);
    padding: 16px; cursor: pointer; transition: all .2s;
}
.choice-card:hover { border-color: var(--accent); }
.choice-card.selected { border-color: var(--accent); background: color-mix(in srgb, var(--accent) 10%, var(--bg3)); }
.choice-card h3 { font-size: .95rem; margin-bottom: 4px; }
.choice-card p { font-size: .78rem; color: var(--t3); }
.choice-card .badge { display: inline-block; font-size: .65rem; background: var(--accent); color: #fff; padding: 1px 6px; border-radius: 4px; margin-left: 6px; }

/* Form inputs */
.form-group { margin-bottom: 16px; }
.form-group label { display: block; font-size: .82rem; color: var(--t2); margin-bottom: 6px; font-weight: 500; }
.form-group input, .form-group textarea {
    width: 100%; padding: 10px 14px; background: var(--bg2); color: var(--t1);
    border: 1px solid var(--bd); border-radius: 8px; font-size: .88rem;
    font-family: inherit;
}
.form-group input:focus, .form-group textarea:focus { border-color: var(--accent); outline: none; }
.form-group textarea { min-height: 80px; font-family: var(--mono); font-size: .78rem; resize: vertical; }
.form-hint { font-size: .72rem; color: var(--t3); margin-top: 4px; }

/* Buttons */
.btn-row { display: flex; gap: 12px; margin-top: 24px; }
.btn {
    padding: 10px 24px; border: none; border-radius: 8px; font-size: .88rem;
    cursor: pointer; font-weight: 600; transition: all .15s;
}
.btn-primary { background: var(--accent); color: #fff; }
.btn-primary:hover { background: var(--accent2); }
.btn-secondary { background: var(--bg4); color: var(--t2); }
.btn-secondary:hover { background: var(--bd); }
.btn-lg { padding: 14px 32px; font-size: 1rem; }
.btn:disabled { opacity: .5; cursor: not-allowed; }

/* Plugin list */
.plugin-list { max-height: 320px; overflow-y: auto; border: 1px solid var(--bd); border-radius: var(--r); }
.plugin-item {
    display: flex; align-items: center; gap: 10px; padding: 8px 14px;
    border-bottom: 1px solid var(--bd); font-size: .82rem;
}
.plugin-item:last-child { border-bottom: none; }
.plugin-item input[type="checkbox"] { accent-color: var(--accent); width: 16px; height: 16px; }
.plugin-item .plugin-name { flex: 1; }
.plugin-item .plugin-required { font-size: .65rem; color: var(--accent); }

/* Radio group for rclone */
.radio-group { display: flex; gap: 12px; margin-bottom: 12px; }
.radio-group label {
    display: flex; align-items: center; gap: 6px; font-size: .85rem;
    color: var(--t2); cursor: pointer;
}
.radio-group input[type="radio"] { accent-color: var(--accent); }

/* GPU info card */
.gpu-card {
    background: var(--bg3); border: 1px solid var(--bd); border-radius: var(--r);
    padding: 14px; margin-bottom: 16px; font-size: .85rem;
}
.gpu-card .gpu-name { font-weight: 600; font-size: 1rem; }
.gpu-card .gpu-detail { color: var(--t3); font-size: .78rem; margin-top: 4px; }

/* Deploy progress */
.deploy-view { display: none; }
.deploy-view.active { display: block; }
.deploy-steps-list { margin-bottom: 16px; }
.deploy-step-item {
    display: flex; align-items: center; gap: 8px; padding: 6px 0;
    font-size: .85rem; color: var(--t3);
}
.deploy-step-item.active { color: var(--t1); font-weight: 500; }
.deploy-step-item.done { color: var(--green); }
.deploy-step-item .step-icon { width: 20px; text-align: center; }

.deploy-log {
    background: var(--bg2); border: 1px solid var(--bd); border-radius: var(--r);
    padding: 12px; min-height: 300px; max-height: 500px; overflow-y: auto;
    font-family: var(--mono); font-size: .75rem; line-height: 1.8;
}
.log-line { white-space: pre-wrap; word-break: break-all; }
.log-line.info { color: var(--t2); }
.log-line.output { color: var(--t3); }
.log-line.warn { color: #f59e0b; }
.log-line.error { color: var(--red); }
.log-line .log-time { color: var(--t3); margin-right: 8px; font-size: .68rem; }

/* Summary section */
.summary-card {
    background: var(--bg3); border: 1px solid var(--bd); border-radius: var(--r);
    padding: 16px; margin-bottom: 12px;
}
.summary-card h4 { font-size: .88rem; margin-bottom: 8px; color: var(--accent); }
.summary-row { display: flex; justify-content: space-between; font-size: .82rem; padding: 3px 0; }
.summary-row .label { color: var(--t3); }
.summary-row .value { color: var(--t1); }
</style>
</head>
<body>
<div class="wizard-container">
    <div class="wizard-header">
        <h1>ğŸš€ ComfyUI éƒ¨ç½²å‘å¯¼</h1>
        <p>æŒ‰æ­¥éª¤é…ç½®ï¼Œä¸€é”®éƒ¨ç½²ä½ çš„ AI ç»˜ç”»å·¥ä½œç«™</p>
    </div>

    <div class="progress-bar" id="progressBar"></div>

    <!-- Step 0: é•œåƒé€‰æ‹© -->
    <div class="step active" id="step-0">
        <div class="step-title">é€‰æ‹©éƒ¨ç½²æ–¹å¼</div>
        <div class="step-desc">æ ¹æ®ä½ ä½¿ç”¨çš„ Docker é•œåƒé€‰æ‹©å¯¹åº”çš„éƒ¨ç½²æ¨¡å¼</div>
        <div id="gpu-info-display"></div>
        <div class="choice-grid">
            <div class="choice-card" onclick="selectImageType('generic')" id="choice-generic">
                <h3>ğŸ”§ é€šç”¨é•œåƒéƒ¨ç½²</h3>
                <p>ä½¿ç”¨ runpod/pytorch ç­‰æ ‡å‡†é•œåƒï¼Œä»é›¶å®‰è£… PyTorchã€åŠ é€Ÿç»„ä»¶ã€ComfyUI å’Œæ’ä»¶</p>
                <p style="color:var(--t3);font-size:.72rem;margin-top:6px">â± é¢„è®¡ 15-30 åˆ†é’Ÿ</p>
            </div>
            <div class="choice-card" onclick="selectImageType('prebuilt')" id="choice-prebuilt">
                <h3>âš¡ é¢„æ„å»ºé•œåƒéƒ¨ç½² <span class="badge">æ¨è</span></h3>
                <p>ä½¿ç”¨å·²é¢„è£… FA3/SA3/ComfyUI çš„è‡ªå®šä¹‰é•œåƒï¼Œåªåšé…ç½®å’ŒåŒæ­¥</p>
                <p style="color:var(--t3);font-size:.72rem;margin-top:6px">â± é¢„è®¡ 2-5 åˆ†é’Ÿ</p>
            </div>
        </div>
        <div class="btn-row">
            <button class="btn btn-primary" onclick="nextStep()" id="btn-next-0" disabled>ä¸‹ä¸€æ­¥</button>
        </div>
    </div>

    <!-- Step 1: Dashboard å¯†ç  -->
    <div class="step" id="step-1">
        <div class="step-title">ğŸ” è®¾ç½® Dashboard å¯†ç </div>
        <div class="step-desc">ä¿æŠ¤ä½ çš„å·¥ä½œç©ºé—´ç®¡ç†å™¨</div>
        <div id="password-env-hint" style="display:none" class="form-hint" style="margin-bottom:12px;color:var(--green)"></div>
        <div class="form-group">
            <label>è®¿é—®å¯†ç </label>
            <input type="password" id="input-password" placeholder="è¾“å…¥ Dashboard è®¿é—®å¯†ç ...">
            <div class="form-hint">éƒ¨ç½²å®Œæˆåé€šè¿‡æ­¤å¯†ç ç™»å½• Dashboard</div>
        </div>
        <div class="btn-row">
            <button class="btn btn-secondary" onclick="prevStep()">ä¸Šä¸€æ­¥</button>
            <button class="btn btn-primary" onclick="nextStep()">ä¸‹ä¸€æ­¥</button>
        </div>
    </div>

    <!-- Step 2: Cloudflare Tunnel -->
    <div class="step" id="step-2">
        <div class="step-title">ğŸŒ Cloudflare Tunnel</div>
        <div class="step-desc">é…ç½® Cloudflare Tunnel ä»¥è·å¾—ç¨³å®šçš„å…¬ç½‘è®¿é—®ï¼ˆæ¨èï¼Œå¾ˆå¤šå®ä¾‹ç«¯å£æ˜ å°„ä¸å¯é ï¼‰</div>
        <div id="cf-env-hint" style="display:none" class="form-hint" style="margin-bottom:12px;color:var(--green)"></div>
        <div class="form-group">
            <label>Tunnel Token</label>
            <input type="text" id="input-cf-token" placeholder="eyJhIjoixxxx... (ä» Cloudflare Zero Trust è·å–)">
            <div class="form-hint">ç•™ç©ºåˆ™è·³è¿‡ Tunnelï¼Œä»…ä½¿ç”¨å®ä¾‹ç«¯å£æ˜ å°„è®¿é—®</div>
        </div>
        <div class="btn-row">
            <button class="btn btn-secondary" onclick="prevStep()">ä¸Šä¸€æ­¥</button>
            <button class="btn btn-primary" onclick="nextStep()">ä¸‹ä¸€æ­¥</button>
        </div>
    </div>

    <!-- Step 3: Rclone é…ç½® -->
    <div class="step" id="step-3">
        <div class="step-title">â˜ï¸ äº‘å­˜å‚¨é…ç½® (Rclone)</div>
        <div class="step-desc">é…ç½® Rclone ä»¥åŒæ­¥å·¥ä½œæµã€LoRA å’Œè¾“å‡ºæ–‡ä»¶åˆ°äº‘ç«¯</div>
        <div id="rclone-env-hint" style="display:none" class="form-hint" style="margin-bottom:12px;color:var(--green)"></div>
        <div class="radio-group">
            <label id="rclone-method-env" style="display:none"><input type="radio" name="rclone-method" value="base64_env" onchange="showRcloneInput('base64_env')"> ä½¿ç”¨ç¯å¢ƒå˜é‡</label>
            <label><input type="radio" name="rclone-method" value="url" onchange="showRcloneInput('url')"> ä» URL å¯¼å…¥</label>
            <label><input type="radio" name="rclone-method" value="base64" onchange="showRcloneInput('base64')"> Base64 ç²˜è´´</label>
            <label><input type="radio" name="rclone-method" value="skip" onchange="showRcloneInput('skip')" checked> è·³è¿‡</label>
        </div>
        <div id="rclone-url-input" style="display:none" class="form-group">
            <label>Rclone é…ç½®æ–‡ä»¶ URL</label>
            <input type="text" id="input-rclone-url" placeholder="https://example.com/rclone.conf">
        </div>
        <div id="rclone-base64-input" style="display:none" class="form-group">
            <label>Base64 ç¼–ç çš„ rclone.conf</label>
            <textarea id="input-rclone-base64" placeholder="ç²˜è´´ RCLONE_CONF_BASE64 çš„å€¼..."></textarea>
        </div>
        <div id="rclone-skip-note" class="form-hint" style="margin-bottom:12px">
            è·³è¿‡åå¯ä»¥åœ¨ Dashboard çš„ã€Œäº‘åŒæ­¥ã€é¡µé¢éšæ—¶é…ç½®
        </div>
        <!-- åŒæ­¥é€‰é¡¹ (ä»…å½“é…ç½®äº† rclone æ—¶æ˜¾ç¤º) -->
        <div id="sync-options-panel" style="display:none;margin-top:16px">
            <label style="font-size:.85rem;font-weight:600;margin-bottom:8px;display:block">éƒ¨ç½²æ—¶åŒæ­¥ä»¥ä¸‹å†…å®¹:</label>
            <div style="display:flex;flex-direction:column;gap:8px">
                <label style="display:flex;align-items:center;gap:8px;font-size:.82rem;color:var(--t2);cursor:pointer">
                    <input type="checkbox" id="sync-workflows" checked style="accent-color:var(--accent)"> å·¥ä½œæµ (workflow)
                </label>
                <label style="display:flex;align-items:center;gap:8px;font-size:.82rem;color:var(--t2);cursor:pointer">
                    <input type="checkbox" id="sync-loras" checked style="accent-color:var(--accent)"> LoRA æ¨¡å‹ (loras)
                </label>
                <label style="display:flex;align-items:center;gap:8px;font-size:.82rem;color:var(--t2);cursor:pointer">
                    <input type="checkbox" id="sync-wildcards" checked style="accent-color:var(--accent)"> åŠ¨æ€æç¤ºè¯ (wildcards)
                </label>
            </div>
        </div>
        <div class="btn-row">
            <button class="btn btn-secondary" onclick="prevStep()">ä¸Šä¸€æ­¥</button>
            <button class="btn btn-primary" onclick="nextStep()">ä¸‹ä¸€æ­¥</button>
        </div>
    </div>

    <!-- Step 4: CivitAI -->
    <div class="step" id="step-4">
        <div class="step-title">ğŸ¨ CivitAI API Key</div>
        <div class="step-desc">é…ç½® CivitAI API Key ä»¥åœ¨ Dashboard ä¸­æœç´¢å’Œä¸‹è½½æ¨¡å‹</div>
        <div id="civitai-env-hint" style="display:none" class="form-hint" style="margin-bottom:12px;color:var(--green)"></div>
        <div class="form-group">
            <label>API Key</label>
            <input type="text" id="input-civitai-token" placeholder="ä½ çš„ CivitAI API Key (å¯é€‰)">
            <div class="form-hint">å¯åœ¨ <a href="https://civitai.com/user/account" target="_blank" style="color:var(--accent)">CivitAI è´¦æˆ·è®¾ç½®</a> è·å–ï¼Œä¹Ÿå¯è·³è¿‡ååœ¨ Dashboard è®¾ç½®</div>
        </div>
        <div class="btn-row">
            <button class="btn btn-secondary" onclick="prevStep()">ä¸Šä¸€æ­¥</button>
            <button class="btn btn-primary" onclick="nextStep()">ä¸‹ä¸€æ­¥</button>
        </div>
    </div>

    <!-- Step 5: æ’ä»¶é€‰æ‹© -->
    <div class="step" id="step-5">
        <div class="step-title">ğŸ§© è‡ªå®šä¹‰èŠ‚ç‚¹æ’ä»¶</div>
        <div class="step-desc">é€‰æ‹©è¦å®‰è£…çš„ ComfyUI æ’ä»¶ (å¸¦ * æ ‡è®°çš„ä¸ºå¿…é€‰)</div>
        <div class="plugin-list" id="plugin-list"></div>
        <div class="form-group" style="margin-top:12px">
            <label>é¢å¤–æ’ä»¶ URL (æ¯è¡Œä¸€ä¸ª)</label>
            <textarea id="input-extra-plugins" placeholder="https://github.com/user/ComfyUI-CustomNode" style="min-height:60px"></textarea>
        </div>
        <div class="btn-row">
            <button class="btn btn-secondary" onclick="prevStep()">ä¸Šä¸€æ­¥</button>
            <button class="btn btn-primary" onclick="nextStep()">ä¸‹ä¸€æ­¥</button>
        </div>
    </div>

    <!-- Step 6: ç¡®è®¤éƒ¨ç½² -->
    <div class="step" id="step-6">
        <div class="step-title">ğŸ“‹ ç¡®è®¤éƒ¨ç½²é…ç½®</div>
        <div class="step-desc">æ£€æŸ¥ä»¥ä¸‹é…ç½®ï¼Œç¡®è®¤åå¼€å§‹éƒ¨ç½²</div>
        <div id="deploy-summary"></div>
        <div class="btn-row">
            <button class="btn btn-secondary" onclick="prevStep()">è¿”å›ä¿®æ”¹</button>
            <button class="btn btn-primary btn-lg" onclick="startDeploy()" id="btn-deploy">ğŸš€ å¼€å§‹éƒ¨ç½²</button>
        </div>
    </div>

    <!-- Deploy Progress View -->
    <div class="deploy-view" id="deploy-view">
        <div class="step-title">âš™ï¸ æ­£åœ¨éƒ¨ç½²...</div>
        <div class="step-desc" id="deploy-elapsed">å·²ç”¨æ—¶: 0 ç§’</div>
        <div class="deploy-steps-list" id="deploy-steps-list"></div>
        <div class="deploy-log" id="deploy-log"></div>
        <div class="btn-row" id="deploy-done-row" style="display:none;margin-top:16px">
            <button class="btn btn-primary btn-lg" onclick="location.reload()">ğŸ‰ è¿›å…¥ Dashboard</button>
        </div>
    </div>
</div>

<script>
const TOTAL_STEPS = 7;
let currentStep = 0;
let wizardConfig = {
    image_type: '',
    password: '',
    cloudflared_token: '',
    rclone_config_method: 'skip',
    rclone_config_value: '',
    civitai_token: '',
    plugins: [],
    sync_options: { workflows: true, loras: true, wildcards: true },
};
let pluginData = [];
let envVars = {};  // ä»ç¯å¢ƒå˜é‡æ£€æµ‹åˆ°çš„é¢„è®¾å€¼

// â”€â”€ Init â”€â”€
async function init() {
    try {
        const r = await fetch('/api/setup/state');
        const state = await r.json();
        envVars = state.env_vars || {};

        // GPU info
        if (state.gpu_info && state.gpu_info.name) {
            const g = state.gpu_info;
            document.getElementById('gpu-info-display').innerHTML = `
                <div class="gpu-card">
                    <div class="gpu-name">ğŸ–¥ï¸ ${esc(g.name)}</div>
                    <div class="gpu-detail">CUDA Capability: ${esc(g.cuda_cap)} | VRAM: ${g.vram_gb} GB</div>
                </div>`;
        }

        // Load plugin list
        pluginData = state.plugins_available || [];
        const selectedUrls = state.plugins || pluginData.map(p => p.url);
        renderPluginList(pluginData, selectedUrls);

        // Restore state if partially filled
        if (state.image_type) {
            wizardConfig.image_type = state.image_type;
            selectImageType(state.image_type, true);
        }
        if (state.deploy_started && !state.deploy_completed) {
            showDeployView();
            connectSSE();
        }

        // â”€â”€ ç¯å¢ƒå˜é‡é¢„å¡«å…… â”€â”€
        // å¯†ç 
        if (envVars.password) {
            document.getElementById('input-password').value = envVars.password;
            wizardConfig.password = envVars.password;
            const hint = document.getElementById('password-env-hint');
            hint.style.display = 'block';
            hint.innerHTML = 'âœ… å·²ä»ç¯å¢ƒå˜é‡ <code>DASHBOARD_PASSWORD</code> æ£€æµ‹åˆ°å¯†ç ï¼Œå¯ç›´æ¥ä½¿ç”¨æˆ–ä¿®æ”¹';
        }
        // CF Tunnel Token
        if (envVars.cloudflared_token) {
            document.getElementById('input-cf-token').value = envVars.cloudflared_token;
            wizardConfig.cloudflared_token = envVars.cloudflared_token;
            const hint = document.getElementById('cf-env-hint');
            hint.style.display = 'block';
            hint.innerHTML = 'âœ… å·²ä»ç¯å¢ƒå˜é‡ <code>CF_TUNNEL_TOKEN</code> æ£€æµ‹åˆ° Tokenï¼ˆTunnel å·²åœ¨è¿è¡Œä¸­ï¼‰';
        }
        // Rclone
        if (envVars.rclone_has_env) {
            document.getElementById('rclone-method-env').style.display = '';
            const hint = document.getElementById('rclone-env-hint');
            hint.style.display = 'block';
            hint.innerHTML = 'âœ… å·²ä»ç¯å¢ƒå˜é‡ <code>RCLONE_CONF_BASE64</code> æ£€æµ‹åˆ°é…ç½®';
            // è‡ªåŠ¨é€‰æ‹©ç¯å¢ƒå˜é‡é€‰é¡¹
            document.querySelector('input[name="rclone-method"][value="base64_env"]').checked = true;
            wizardConfig.rclone_config_method = 'base64_env';
            showRcloneInput('base64_env');
        }
        // CivitAI
        if (envVars.civitai_token) {
            document.getElementById('input-civitai-token').value = envVars.civitai_token;
            wizardConfig.civitai_token = envVars.civitai_token;
            const hint = document.getElementById('civitai-env-hint');
            hint.style.display = 'block';
            hint.innerHTML = 'âœ… å·²ä»ç¯å¢ƒå˜é‡ <code>CIVITAI_TOKEN</code> æ£€æµ‹åˆ° API Key';
        }

        updateProgressBar();
    } catch (e) {
        console.error('init error:', e);
    }
}

function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

// â”€â”€ Navigation â”€â”€
function updateProgressBar() {
    const bar = document.getElementById('progressBar');
    bar.innerHTML = '';
    for (let i = 0; i < TOTAL_STEPS; i++) {
        const seg = document.createElement('div');
        seg.className = 'progress-segment' + (i < currentStep ? ' done' : i === currentStep ? ' active' : '');
        bar.appendChild(seg);
    }
}

function showStep(n) {
    document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
    const el = document.getElementById(`step-${n}`);
    if (el) el.classList.add('active');
    currentStep = n;
    updateProgressBar();
}

function nextStep() {
    saveCurrentStep();
    if (currentStep < TOTAL_STEPS - 1) {
        showStep(currentStep + 1);
        if (currentStep === TOTAL_STEPS - 1) renderSummary();
    }
}

function prevStep() {
    if (currentStep > 0) showStep(currentStep - 1);
}

function saveCurrentStep() {
    switch (currentStep) {
        case 1:
            wizardConfig.password = document.getElementById('input-password').value || 'comfy2025';
            break;
        case 2:
            wizardConfig.cloudflared_token = document.getElementById('input-cf-token').value.trim();
            break;
        case 3:
            const method = document.querySelector('input[name="rclone-method"]:checked')?.value || 'skip';
            wizardConfig.rclone_config_method = method;
            if (method === 'url') wizardConfig.rclone_config_value = document.getElementById('input-rclone-url').value.trim();
            else if (method === 'base64') wizardConfig.rclone_config_value = document.getElementById('input-rclone-base64').value.trim();
            else if (method === 'base64_env') wizardConfig.rclone_config_value = '';  // åç«¯ä»ç¯å¢ƒå˜é‡è¯»å–
            else wizardConfig.rclone_config_value = '';
            // åŒæ­¥é€‰é¡¹
            wizardConfig.sync_options = {
                workflows: document.getElementById('sync-workflows')?.checked ?? true,
                loras: document.getElementById('sync-loras')?.checked ?? true,
                wildcards: document.getElementById('sync-wildcards')?.checked ?? true,
            };
            break;
        case 4:
            wizardConfig.civitai_token = document.getElementById('input-civitai-token').value.trim();
            break;
        case 5:
            wizardConfig.plugins = getSelectedPlugins();
            break;
    }
    // Persist to backend
    fetch('/api/setup/save', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ...wizardConfig, current_step: currentStep })
    }).catch(() => {});
}

// â”€â”€ Image Type Selection â”€â”€
function selectImageType(type, noEnable) {
    wizardConfig.image_type = type;
    document.querySelectorAll('.choice-card').forEach(c => c.classList.remove('selected'));
    document.getElementById(`choice-${type}`).classList.add('selected');
    if (!noEnable) document.getElementById('btn-next-0').disabled = false;
    else document.getElementById('btn-next-0').disabled = false;
}

// â”€â”€ Rclone Input Toggle â”€â”€
function showRcloneInput(method) {
    document.getElementById('rclone-url-input').style.display = method === 'url' ? 'block' : 'none';
    document.getElementById('rclone-base64-input').style.display = method === 'base64' ? 'block' : 'none';
    document.getElementById('rclone-skip-note').style.display = method === 'skip' ? 'block' : 'none';
    // åŒæ­¥é€‰é¡¹: é skip æ—¶æ˜¾ç¤º
    document.getElementById('sync-options-panel').style.display = method !== 'skip' ? 'block' : 'none';
}

// â”€â”€ Plugins â”€â”€
function renderPluginList(plugins, selectedUrls) {
    const list = document.getElementById('plugin-list');
    list.innerHTML = plugins.map((p, i) => {
        const checked = selectedUrls.includes(p.url) || p.required;
        const disabled = p.required ? 'disabled' : '';
        const req = p.required ? '<span class="plugin-required">* å¿…é€‰</span>' : '';
        return `<div class="plugin-item">
            <input type="checkbox" id="plugin-${i}" ${checked ? 'checked' : ''} ${disabled} data-url="${esc(p.url)}">
            <span class="plugin-name">${esc(p.name)} ${req}</span>
        </div>`;
    }).join('');
}

function getSelectedPlugins() {
    const urls = [];
    document.querySelectorAll('#plugin-list input[type="checkbox"]').forEach(cb => {
        if (cb.checked) urls.push(cb.dataset.url);
    });
    // Extra plugins
    const extra = document.getElementById('input-extra-plugins').value.trim();
    if (extra) {
        extra.split('\n').forEach(u => {
            u = u.trim();
            if (u && u.startsWith('http')) urls.push(u);
        });
    }
    return urls;
}

// â”€â”€ Summary â”€â”€
function renderSummary() {
    saveCurrentStep();
    const c = wizardConfig;
    const pluginCount = (c.plugins || []).length;
    const html = `
        <div class="summary-card">
            <h4>éƒ¨ç½²æ–¹å¼</h4>
            <div class="summary-row"><span class="label">é•œåƒç±»å‹</span><span class="value">${c.image_type === 'prebuilt' ? 'âš¡ é¢„æ„å»ºé•œåƒ' : 'ğŸ”§ é€šç”¨é•œåƒ'}</span></div>
        </div>
        <div class="summary-card">
            <h4>ç½‘ç»œä¸å®‰å…¨</h4>
            <div class="summary-row"><span class="label">Dashboard å¯†ç </span><span class="value">${c.password ? 'å·²è®¾ç½®' : 'æœªè®¾ç½®'}</span></div>
            <div class="summary-row"><span class="label">Cloudflare Tunnel</span><span class="value">${c.cloudflared_token ? 'âœ… å·²é…ç½®' : 'â­ è·³è¿‡'}</span></div>
        </div>
        <div class="summary-card">
            <h4>äº‘å­˜å‚¨</h4>
            <div class="summary-row"><span class="label">Rclone é…ç½®</span><span class="value">${c.rclone_config_method === 'skip' ? 'â­ è·³è¿‡' : c.rclone_config_method === 'url' ? 'ğŸ”— ä» URL å¯¼å…¥' : 'ğŸ“‹ Base64 å¯¼å…¥'}</span></div>
        </div>
        <div class="summary-card">
            <h4>æ¨¡å‹ä¸æ’ä»¶</h4>
            <div class="summary-row"><span class="label">CivitAI API Key</span><span class="value">${c.civitai_token ? 'âœ… å·²é…ç½®' : 'â­ è·³è¿‡'}</span></div>
            <div class="summary-row"><span class="label">æ’ä»¶æ•°é‡</span><span class="value">${pluginCount} ä¸ª</span></div>
        </div>`;
    document.getElementById('deploy-summary').innerHTML = html;
}

// â”€â”€ Deploy â”€â”€
async function startDeploy() {
    saveCurrentStep();
    document.getElementById('btn-deploy').disabled = true;

    try {
        const r = await fetch('/api/setup/deploy', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(wizardConfig)
        });
        const d = await r.json();
        if (!d.ok) { alert('éƒ¨ç½²å¯åŠ¨å¤±è´¥: ' + (d.error || '')); return; }
    } catch (e) { alert('è¯·æ±‚å¤±è´¥: ' + e.message); return; }

    showDeployView();
    connectSSE();
}

function showDeployView() {
    document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
    document.getElementById('deploy-view').classList.add('active');
    document.getElementById('progressBar').style.display = 'none';
    startElapsedTimer();
}

let elapsedTimer = null;
let deployStartTime = Date.now();

function startElapsedTimer() {
    deployStartTime = Date.now();
    elapsedTimer = setInterval(() => {
        const s = Math.floor((Date.now() - deployStartTime) / 1000);
        const m = Math.floor(s / 60);
        const sec = s % 60;
        document.getElementById('deploy-elapsed').textContent = `å·²ç”¨æ—¶: ${m > 0 ? m + ' åˆ† ' : ''}${sec} ç§’`;
    }, 1000);
}

let completedSteps = [];

function connectSSE() {
    const evtSource = new EventSource('/api/setup/log_stream');
    const logEl = document.getElementById('deploy-log');
    const stepsEl = document.getElementById('deploy-steps-list');

    evtSource.onmessage = (event) => {
        const data = JSON.parse(event.data);

        if (data.type === 'step') {
            // Mark previous step as done
            if (completedSteps.length > 0) {
                const prev = stepsEl.querySelector('.deploy-step-item.active');
                if (prev) { prev.classList.remove('active'); prev.classList.add('done'); prev.querySelector('.step-icon').textContent = 'âœ…'; }
            }
            completedSteps.push(data.name);
            const item = document.createElement('div');
            item.className = 'deploy-step-item active';
            item.innerHTML = `<span class="step-icon">â³</span>${esc(data.name)}`;
            stepsEl.appendChild(item);
            return;
        }

        if (data.type === 'done') {
            evtSource.close();
            if (elapsedTimer) clearInterval(elapsedTimer);
            // Mark last step done
            const lastActive = stepsEl.querySelector('.deploy-step-item.active');
            if (lastActive) { lastActive.classList.remove('active'); lastActive.classList.add('done'); lastActive.querySelector('.step-icon').textContent = 'âœ…'; }

            if (data.success) {
                const doneEl = document.createElement('div');
                doneEl.className = 'log-line info';
                doneEl.style.color = 'var(--green)';
                doneEl.style.fontWeight = '600';
                doneEl.textContent = 'ğŸ‰ éƒ¨ç½²å®Œæˆï¼';
                logEl.appendChild(doneEl);
            } else {
                const errEl = document.createElement('div');
                errEl.className = 'log-line error';
                errEl.textContent = 'âŒ ' + (data.msg || 'éƒ¨ç½²å¤±è´¥');
                logEl.appendChild(errEl);
            }
            document.getElementById('deploy-done-row').style.display = 'flex';
            logEl.scrollTop = logEl.scrollHeight;
            return;
        }

        if (data.type === 'log') {
            const line = document.createElement('div');
            line.className = `log-line ${data.level || 'info'}`;
            const timeSpan = data.time ? `<span class="log-time">${esc(data.time)}</span>` : '';
            line.innerHTML = `${timeSpan}${esc(data.msg)}`;
            logEl.appendChild(line);
            // Auto scroll
            if (logEl.scrollHeight - logEl.scrollTop - logEl.clientHeight < 100) {
                logEl.scrollTop = logEl.scrollHeight;
            }
        }
    };

    evtSource.onerror = () => {
        // Connection lost â€” might be done
        setTimeout(() => { evtSource.close(); }, 3000);
    };
}

// â”€â”€ Start â”€â”€
init();
</script>
</body>
</html>
