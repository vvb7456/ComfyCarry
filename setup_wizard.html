<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ComfyCarry - éƒ¨ç½²å‘å¯¼</title>
<link rel="icon" href="/favicon.ico" type="image/x-icon">
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&family=IBM+Plex+Sans+SC:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
    --bg1: #0a0a0f; --bg2: #12121e; --bg3: #1a1a28; --bg4: #22223a;
    --bd: #2a2a3e; --t1: #e8e8f0; --t2: #a8a8c0; --t3: #68688a;
    --accent: #7c5cfc; --accent2: #9078ff; --green: #4ade80; --red: #f87171;
    --r: 12px; --mono: 'IBM Plex Mono', 'Fira Code', monospace;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'IBM Plex Sans', 'IBM Plex Sans SC', -apple-system, sans-serif; background: var(--bg1); color: var(--t1); min-height: 100vh; font-size: clamp(15px, 1vw, 18px); }

.wizard-container {
    max-width: 960px; margin: 0 auto; padding: clamp(24px, 4vw, 60px) clamp(16px, 3vw, 40px);
}
.wizard-header {
    text-align: center; margin-bottom: clamp(24px, 3vw, 48px);
}
.wizard-header h1 {
    font-size: clamp(1.6rem, 2.5vw, 2.4rem); font-weight: 700;
    background: linear-gradient(135deg, #7c5cfc, #e879f9);
    -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;
}
.wizard-header p { color: var(--t3); font-size: clamp(0.85rem, 1vw, 1.05rem); margin-top: 8px; }

/* Progress bar */
.progress-bar { display: flex; gap: 6px; margin-bottom: clamp(24px, 3vw, 40px); }
.progress-segment {
    flex: 1; height: 5px; border-radius: 3px; background: var(--bg4);
    transition: background .3s;
}
.progress-segment.done { background: var(--accent); }
.progress-segment.active { background: var(--accent2); animation: pulse 1.5s infinite; }
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.5} }

/* Steps */
.step { display: none; }
.step.active { display: block; }
.step-title { font-size: clamp(1.1rem, 1.5vw, 1.5rem); font-weight: 600; margin-bottom: 8px; }
.step-desc { color: var(--t2); font-size: clamp(0.88rem, 1vw, 1.05rem); margin-bottom: 24px; line-height: 1.6; }

/* Cards for selection */
.choice-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px; }
.choice-card {
    background: var(--bg3); border: 2px solid var(--bd); border-radius: var(--r);
    padding: clamp(16px, 2vw, 28px); cursor: pointer; transition: all .2s;
}
.choice-card:hover { border-color: var(--accent); }
.choice-card.selected { border-color: var(--accent); background: color-mix(in srgb, var(--accent) 10%, var(--bg3)); }
.choice-card h3 { font-size: clamp(0.95rem, 1.1vw, 1.15rem); margin-bottom: 8px; }
.choice-card p { font-size: clamp(0.82rem, 0.95vw, 1rem); color: var(--t3); line-height: 1.5; }
.choice-card .badge { display: inline-block; font-size: clamp(0.65rem, 0.7vw, 0.78rem); background: var(--accent); color: #fff; padding: 2px 8px; border-radius: 4px; margin-left: 6px; }

/* Form inputs */
.form-group { margin-bottom: 20px; }
.form-group label { display: block; font-size: clamp(0.88rem, 1vw, 1.05rem); color: var(--t2); margin-bottom: 8px; font-weight: 500; }
.form-group input, .form-group textarea {
    width: 100%; padding: clamp(10px, 1.2vw, 16px) clamp(14px, 1.5vw, 20px);
    background: var(--bg2); color: var(--t1);
    border: 1px solid var(--bd); border-radius: 10px;
    font-size: clamp(0.9rem, 1vw, 1.05rem);
    font-family: inherit;
}
.form-group input:focus, .form-group textarea:focus { border-color: var(--accent); outline: none; }
.form-group textarea { min-height: 100px; font-family: var(--mono); font-size: clamp(0.82rem, 0.9vw, 0.95rem); resize: vertical; }
.form-hint { font-size: clamp(0.78rem, 0.85vw, 0.92rem); color: var(--t3); margin-top: 6px; line-height: 1.5; }

/* Buttons */
.btn-row { display: flex; gap: 14px; margin-top: 28px; }
.btn {
    padding: clamp(10px, 1.3vw, 16px) clamp(24px, 2.5vw, 36px);
    border: none; border-radius: 10px;
    font-size: clamp(0.92rem, 1vw, 1.1rem);
    cursor: pointer; font-weight: 600; transition: all .15s;
}
.btn-primary { background: var(--accent); color: #fff; }
.btn-primary:hover { background: var(--accent2); }
.btn-secondary { background: var(--bg4); color: var(--t2); }
.btn-secondary:hover { background: var(--bd); }
.btn-lg { padding: clamp(14px, 1.5vw, 20px) clamp(32px, 3vw, 48px); font-size: clamp(1rem, 1.2vw, 1.2rem); }
.btn:disabled { opacity: .5; cursor: not-allowed; }

/* Plugin list */
.plugin-list { max-height: 400px; overflow-y: auto; border: 1px solid var(--bd); border-radius: var(--r); }
.plugin-item {
    display: flex; align-items: center; gap: 12px;
    padding: clamp(10px, 1.2vw, 16px) clamp(14px, 1.5vw, 20px);
    border-bottom: 1px solid var(--bd); font-size: clamp(0.88rem, 1vw, 1.05rem);
}
.plugin-item:last-child { border-bottom: none; }
.plugin-item input[type="checkbox"] { accent-color: var(--accent); width: 18px; height: 18px; }
.plugin-item .plugin-name { flex: 1; }
.plugin-item .plugin-required { font-size: clamp(0.7rem, 0.8vw, 0.85rem); color: var(--accent); }

/* Radio group for rclone */
.radio-group { display: flex; gap: 16px; margin-bottom: 16px; flex-wrap: wrap; }
.radio-group label {
    display: flex; align-items: center; gap: 8px;
    font-size: clamp(0.88rem, 1vw, 1.05rem);
    color: var(--t2); cursor: pointer;
}
.radio-group input[type="radio"] { accent-color: var(--accent); width: 16px; height: 16px; }

/* GPU info card */
.gpu-card {
    background: var(--bg3); border: 1px solid var(--bd); border-radius: var(--r);
    padding: clamp(14px, 1.5vw, 24px); margin-bottom: 20px;
}
.gpu-card .gpu-name { font-weight: 600; font-size: clamp(1rem, 1.2vw, 1.3rem); }
.gpu-card .gpu-detail { color: var(--t3); font-size: clamp(0.82rem, 0.9vw, 1rem); margin-top: 6px; }

/* Deploy progress */
.deploy-view { display: none; }
.deploy-view.active { display: block; }
.deploy-content { display: flex; gap: 20px; align-items: flex-start; }
.deploy-content .deploy-steps-list { flex: 0 0 260px; min-width: 200px; position: sticky; top: 20px; }
.deploy-content .deploy-log { flex: 1; min-width: 0; }
.deploy-step-item {
    display: flex; align-items: center; gap: 10px;
    padding: clamp(6px, 0.8vw, 10px) 0;
    font-size: clamp(0.9rem, 1vw, 1.08rem); color: var(--t3);
}
.deploy-step-item.active { color: var(--t1); font-weight: 500; }
.deploy-step-item.done { color: var(--green); }
.deploy-step-item .step-icon { width: 24px; text-align: center; }

.deploy-log {
    background: var(--bg2); border: 1px solid var(--bd); border-radius: var(--r);
    padding: clamp(12px, 1.5vw, 20px);
    min-height: clamp(400px, 55vh, 600px); max-height: clamp(500px, 70vh, 800px);
    overflow-y: auto;
    font-family: var(--mono); font-size: clamp(0.78rem, 0.85vw, 0.92rem); line-height: 1.9;
}
.log-line { white-space: pre-wrap; word-break: break-all; }
.log-line.info { color: var(--t2); }
.log-line.output { color: var(--t3); }
.log-line.warn { color: #f59e0b; }
.log-line.error { color: var(--red); }
.log-line .log-time { color: var(--t3); margin-right: 10px; font-size: clamp(0.72rem, 0.78vw, 0.85rem); }

/* Summary section */
.summary-card {
    background: var(--bg3); border: 1px solid var(--bd); border-radius: var(--r);
    padding: clamp(16px, 1.8vw, 24px); margin-bottom: 14px;
}
.summary-card h4 { font-size: clamp(0.92rem, 1vw, 1.1rem); margin-bottom: 10px; color: var(--accent); }
.summary-row { display: flex; justify-content: space-between; font-size: clamp(0.88rem, 1vw, 1.05rem); padding: 4px 0; }
.summary-row .label { color: var(--t3); }
.summary-row .value { color: var(--t1); }

/* Env hint styling */
.env-hint {
    background: color-mix(in srgb, var(--green) 8%, var(--bg3));
    border: 1px solid color-mix(in srgb, var(--green) 25%, var(--bd));
    border-radius: 8px; padding: 10px 14px; margin-bottom: 16px;
    font-size: clamp(0.82rem, 0.9vw, 0.95rem); color: var(--green); line-height: 1.5;
}
.env-hint code { background: rgba(255,255,255,.08); padding: 1px 6px; border-radius: 4px; font-family: var(--mono); font-size: 0.9em; }

/* Import upload area */
.import-upload-box {
    background: var(--bg3); border: 2px dashed var(--bd); border-radius: var(--r);
    padding: clamp(20px, 2.5vw, 32px); text-align: center; transition: border-color .2s;
}
.import-upload-box:hover { border-color: var(--accent); }
.import-upload-box p { color: var(--t2); margin-bottom: 12px; font-size: clamp(0.85rem, 0.95vw, 1rem); }
.import-upload-box code { background: rgba(255,255,255,.08); padding: 1px 6px; border-radius: 4px; font-family: var(--mono); font-size: 0.9em; }
.import-result {
    margin-top: 12px; padding: 12px 16px; border-radius: 8px;
    font-size: clamp(0.82rem, 0.92vw, 0.95rem); line-height: 1.6;
}

/* Responsive */
@media (max-width: 768px) {
    .choice-grid { grid-template-columns: 1fr !important; }
    .radio-group { flex-direction: column; gap: 10px; }
    .deploy-content { flex-direction: column; }
    .deploy-content .deploy-steps-list { flex: none; position: static; }
}
@media (max-width: 600px) {
    .choice-grid { grid-template-columns: 1fr !important; }
}
</style>
</head>
<body>
<div class="wizard-container">
    <div class="wizard-header">
        <h1>ğŸš€ ComfyCarry éƒ¨ç½²å‘å¯¼</h1>
        <p><a href="https://github.com/vvb7456/ComfyCarry" target="_blank" style="color:var(--accent);text-decoration:none">GitHub</a> Â· RunPod / Vast.ai ä¸Šçš„ ComfyUI ä¸€ç«™å¼ç®¡ç†</p>
    </div>

    <div class="progress-bar" id="progressBar"></div>

    <!-- Step 0: éƒ¨ç½²æ–¹å¼é€‰æ‹© -->
    <div class="step active" id="step-0">
        <div class="step-title">é€‰æ‹©éƒ¨ç½²æ–¹å¼</div>
        <div class="step-desc" id="step-0-desc">æ­£åœ¨æ£€æµ‹ç¯å¢ƒ...</div>
        <div id="gpu-info-display"></div>
        <!-- æ£€æµ‹åˆ°çš„é•œåƒç±»å‹æç¤º -->
        <div id="image-type-badge" style="display:none;margin-bottom:16px;padding:10px 14px;border-radius:8px;font-size:.88rem"></div>
        <div class="choice-grid">
            <div class="choice-card" onclick="selectMode('fresh')" id="choice-fresh">
                <h3>ğŸš€ å…¨æ–°éƒ¨ç½²</h3>
                <p>é…ç½®å¯†ç ã€Tunnelã€äº‘å­˜å‚¨ã€æ’ä»¶ç­‰å‚æ•°ï¼Œç„¶åä¸€é”®éƒ¨ç½² ComfyUI å·¥ä½œç¯å¢ƒ</p>
                <p style="color:var(--t3);font-size:.72rem;margin-top:6px" id="fresh-time"></p>
            </div>
            <div class="choice-card" onclick="selectMode('import')" id="choice-import">
                <h3>ğŸ“¦ æ¢å¤è®¾ç½®</h3>
                <p>ä»ä¹‹å‰å¯¼å‡ºçš„é…ç½®æ–‡ä»¶æ¢å¤æ‰€æœ‰è®¾ç½®ï¼Œå¿«é€Ÿé‡å»ºå·¥ä½œç¯å¢ƒ</p>
                <p style="color:var(--t3);font-size:.72rem;margin-top:6px">â± è·³è¿‡æ‰‹åŠ¨é…ç½®</p>
            </div>
        </div>
        <!-- å¯¼å…¥æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ (é€‰æ‹©æ¢å¤è®¾ç½®æ—¶æ˜¾ç¤º) -->
        <div id="import-upload-area" style="display:none;margin-bottom:24px">
            <div class="import-upload-box">
                <p>ä¸Šä¼ ä¹‹å‰å¯¼å‡ºçš„ <code>comfyui-config.json</code> æ–‡ä»¶</p>
                <label class="btn btn-primary" style="cursor:pointer;display:inline-block">
                    ğŸ“‚ é€‰æ‹©æ–‡ä»¶
                    <input type="file" accept=".json" onchange="handleImportFile(event)" style="display:none">
                </label>
            </div>
            <div id="import-result" class="import-result" style="display:none"></div>
        </div>
        <div class="btn-row">
            <button class="btn btn-primary" onclick="nextStep()" id="btn-next-0" disabled>ä¸‹ä¸€æ­¥</button>
        </div>
    </div>

    <!-- Step 1: Dashboard å¯†ç  -->
    <div class="step" id="step-1">
        <div class="step-title">ğŸ” è®¾ç½® Dashboard å¯†ç </div>
        <div class="step-desc">ä¿æŠ¤ä½ çš„å·¥ä½œç©ºé—´ç®¡ç†å™¨</div>
        <div id="password-env-hint" style="display:none" class="env-hint"></div>
        <div class="form-group">
            <label>è®¿é—®å¯†ç </label>
            <input type="password" id="input-password" placeholder="è¾“å…¥ Dashboard è®¿é—®å¯†ç ...">
            <div class="form-hint">éƒ¨ç½²å®Œæˆåé€šè¿‡æ­¤å¯†ç ç™»å½• Dashboard</div>
        </div>
        <div class="btn-row">
            <button class="btn btn-secondary" onclick="prevStep()">ä¸Šä¸€æ­¥</button>
            <button class="btn btn-primary" onclick="nextStep()">ä¸‹ä¸€æ­¥</button>
        </div>
    </div>

    <!-- Step 2: Cloudflare Tunnel -->
    <div class="step" id="step-2">
        <div class="step-title">ğŸŒ Cloudflare Tunnel</div>
        <div class="step-desc">é…ç½® Cloudflare Tunnel ä»¥è·å¾—ç¨³å®šçš„å…¬ç½‘è®¿é—®ï¼ˆæ¨èï¼Œå¾ˆå¤šå®ä¾‹ç«¯å£æ˜ å°„ä¸å¯é ï¼‰</div>
        <div id="cf-env-hint" style="display:none" class="env-hint"></div>
        <div class="form-group">
            <label>Tunnel Token</label>
            <input type="text" id="input-cf-token" placeholder="eyJhIjoixxxx... (ä» Cloudflare Zero Trust è·å–)">
            <div class="form-hint">ç•™ç©ºåˆ™è·³è¿‡ Tunnelï¼Œä»…ä½¿ç”¨å®ä¾‹ç«¯å£æ˜ å°„è®¿é—®</div>
        </div>
        <div class="btn-row">
            <button class="btn btn-secondary" onclick="prevStep()">ä¸Šä¸€æ­¥</button>
            <button class="btn btn-primary" onclick="nextStep()">ä¸‹ä¸€æ­¥</button>
        </div>
    </div>

    <!-- Step 3: äº‘å­˜å‚¨ä¸åŒæ­¥ -->
    <div class="step" id="step-3">
        <div class="step-title">â˜ï¸ äº‘å­˜å‚¨ä¸åŒæ­¥</div>
        <div class="step-desc">é…ç½® Rclone è¿æ¥äº‘ç«¯å­˜å‚¨ï¼Œè®¾ç½®éƒ¨ç½²æ‹‰å–å’Œè¾“å‡ºåŒæ­¥è§„åˆ™</div>

        <!-- Section 1: Rclone é…ç½® -->
        <div style="margin-bottom:20px">
            <label style="font-size:.92rem;font-weight:600;margin-bottom:8px;display:block">1ï¸âƒ£ å¯¼å…¥ Rclone é…ç½®</label>
            <div id="rclone-env-hint" style="display:none" class="env-hint"></div>
            <div class="radio-group">
                <label id="rclone-method-env" style="display:none"><input type="radio" name="rclone-method" value="base64_env" onchange="showRcloneInput('base64_env')"> ç¯å¢ƒå˜é‡</label>
                <label><input type="radio" name="rclone-method" value="file" onchange="showRcloneInput('file')"> ä¸Šä¼ æ–‡ä»¶</label>
                <label><input type="radio" name="rclone-method" value="url" onchange="showRcloneInput('url')"> URL å¯¼å…¥</label>
                <label><input type="radio" name="rclone-method" value="base64" onchange="showRcloneInput('base64')"> Base64 ç²˜è´´</label>
                <label><input type="radio" name="rclone-method" value="skip" onchange="showRcloneInput('skip')" checked> è·³è¿‡</label>
            </div>
            <div id="rclone-file-input" style="display:none" class="form-group">
                <label style="cursor:pointer;display:inline-block;background:var(--bg4);padding:8px 18px;border-radius:8px;font-size:.88rem">
                    ğŸ“‚ é€‰æ‹© rclone.conf æ–‡ä»¶
                    <input type="file" accept=".conf,.txt" onchange="handleRcloneFile(event)" style="display:none">
                </label>
                <span id="rclone-file-status" style="margin-left:10px;font-size:.82rem;color:var(--t3)"></span>
            </div>
            <div id="rclone-url-input" style="display:none" class="form-group">
                <label>Rclone é…ç½®æ–‡ä»¶ URL</label>
                <input type="text" id="input-rclone-url" placeholder="https://example.com/rclone.conf">
            </div>
            <div id="rclone-base64-input" style="display:none" class="form-group">
                <label>Base64 ç¼–ç çš„ rclone.conf</label>
                <textarea id="input-rclone-base64" placeholder="ç²˜è´´ RCLONE_CONF_BASE64 çš„å€¼..."></textarea>
            </div>
            <div id="rclone-skip-note" class="form-hint" style="margin-bottom:4px">
                è·³è¿‡åå¯åœ¨ Dashboardã€Œäº‘åŒæ­¥ã€é¡µé¢éšæ—¶é…ç½®
            </div>
        </div>

        <!-- Section 2: éƒ¨ç½²æ‹‰å– (é skip æ—¶æ˜¾ç¤º) -->
        <div id="sync-pull-panel" style="display:none;margin-bottom:20px;padding:16px;background:var(--bg3);border:1px solid var(--bd);border-radius:var(--r)">
            <label style="font-size:.92rem;font-weight:600;margin-bottom:4px;display:block">2ï¸âƒ£ éƒ¨ç½²æ—¶ä»äº‘ç«¯æ‹‰å–</label>
            <div style="font-size:.78rem;color:var(--t3);margin-bottom:10px">é¦–æ¬¡éƒ¨ç½²æ—¶ä½¿ç”¨ç¬¬ä¸€ä¸ªå¯ç”¨ Remote é€šè¿‡ copy æ–¹å¼æ‹‰å–åˆ°æœ¬åœ°</div>
            <div style="display:flex;flex-direction:column;gap:8px">
                <label style="display:flex;align-items:center;gap:8px;font-size:.85rem;color:var(--t2);cursor:pointer">
                    <input type="checkbox" id="sync-pull-workflows" checked style="accent-color:var(--accent)"> å·¥ä½œæµ (<code style="font-size:.78rem">user/default/workflows</code>)
                </label>
                <label style="display:flex;align-items:center;gap:8px;font-size:.85rem;color:var(--t2);cursor:pointer">
                    <input type="checkbox" id="sync-pull-loras" checked style="accent-color:var(--accent)"> LoRA æ¨¡å‹ (<code style="font-size:.78rem">models/loras</code>)
                </label>
                <label style="display:flex;align-items:center;gap:8px;font-size:.85rem;color:var(--t2);cursor:pointer">
                    <input type="checkbox" id="sync-pull-wildcards" checked style="accent-color:var(--accent)"> Wildcards (<code style="font-size:.78rem">custom_nodes/.../wildcards</code>)
                </label>
            </div>
        </div>

        <!-- Section 3: è¾“å‡ºæ¨é€ (é skip æ—¶æ˜¾ç¤º) -->
        <div id="sync-push-panel" style="display:none;margin-bottom:20px;padding:16px;background:var(--bg3);border:1px solid var(--bd);border-radius:var(--r)">
            <label style="font-size:.92rem;font-weight:600;margin-bottom:4px;display:block">3ï¸âƒ£ è¿è¡Œæ—¶è‡ªåŠ¨æ¨é€</label>
            <div style="font-size:.78rem;color:var(--t3);margin-bottom:10px">Worker åœ¨åå°æŒç»­ç›‘æ§ï¼Œè‡ªåŠ¨å°†è¾“å‡ºæ–‡ä»¶æ¨é€åˆ°äº‘ç«¯</div>
            <div style="display:flex;flex-direction:column;gap:10px">
                <label style="display:flex;align-items:center;gap:8px;font-size:.85rem;color:var(--t2);cursor:pointer">
                    <input type="checkbox" id="sync-push-output" style="accent-color:var(--accent)"> è¾“å‡ºå›¾ç‰‡ (<code style="font-size:.78rem">output/</code>)
                </label>
                <div id="sync-push-method-row" style="display:none;margin-left:26px">
                    <label style="font-size:.82rem;color:var(--t3);margin-right:8px">æ¨é€æ–¹å¼:</label>
                    <select id="sync-push-method" style="font-size:.85rem;padding:4px 10px;background:var(--bg2);color:var(--t1);border:1px solid var(--bd);border-radius:6px">
                        <option value="copy">copy â€” å¤åˆ¶åˆ°äº‘ç«¯ (ä¿ç•™æœ¬åœ°æ–‡ä»¶)</option>
                        <option value="move">move â€” ç§»åŠ¨åˆ°äº‘ç«¯ (é‡Šæ”¾æœ¬åœ°ç©ºé—´)</option>
                    </select>
                </div>
            </div>
        </div>

        <div style="font-size:.75rem;color:var(--t3);margin-bottom:8px">ğŸ’¡ ä»¥ä¸Šä»…ä¸ºåˆå§‹è§„åˆ™ï¼Œéƒ¨ç½²åå¯åœ¨ Dashboardã€Œäº‘åŒæ­¥ã€é¡µé¢è‡ªç”±æ·»åŠ ã€ä¿®æ”¹ã€åˆ é™¤ä»»æ„åŒæ­¥è§„åˆ™</div>

        <div class="btn-row">
            <button class="btn btn-secondary" onclick="prevStep()">ä¸Šä¸€æ­¥</button>
            <button class="btn btn-primary" onclick="nextStep()">ä¸‹ä¸€æ­¥</button>
        </div>
    </div>

    <!-- Step 4: CivitAI -->
    <div class="step" id="step-4">
        <div class="step-title">ğŸ¨ CivitAI API Key</div>
        <div class="step-desc">é…ç½® CivitAI API Key ä»¥åœ¨ Dashboard ä¸­æœç´¢å’Œä¸‹è½½æ¨¡å‹</div>
        <div id="civitai-env-hint" style="display:none" class="env-hint"></div>
        <div class="form-group">
            <label>API Key</label>
            <input type="text" id="input-civitai-token" placeholder="ä½ çš„ CivitAI API Key (å¯é€‰)">
            <div class="form-hint">å¯åœ¨ <a href="https://civitai.com/user/account" target="_blank" style="color:var(--accent)">CivitAI è´¦æˆ·è®¾ç½®</a> è·å–ï¼Œä¹Ÿå¯è·³è¿‡ååœ¨ Dashboard è®¾ç½®</div>
        </div>
        <div class="btn-row">
            <button class="btn btn-secondary" onclick="prevStep()">ä¸Šä¸€æ­¥</button>
            <button class="btn btn-primary" onclick="nextStep()">ä¸‹ä¸€æ­¥</button>
        </div>
    </div>

    <!-- Step 5: æ’ä»¶é€‰æ‹© -->
    <div class="step" id="step-5">
        <div class="step-title">ğŸ§© è‡ªå®šä¹‰èŠ‚ç‚¹æ’ä»¶</div>
        <div class="step-desc">é€‰æ‹©è¦å®‰è£…çš„ ComfyUI æ’ä»¶ (å¸¦ * æ ‡è®°çš„ä¸ºå¿…é€‰)</div>
        <div class="plugin-list" id="plugin-list"></div>
        <div class="form-group" style="margin-top:12px">
            <label>é¢å¤–æ’ä»¶ URL (æ¯è¡Œä¸€ä¸ª)</label>
            <textarea id="input-extra-plugins" placeholder="https://github.com/user/ComfyUI-CustomNode" style="min-height:60px"></textarea>
        </div>
        <div class="btn-row">
            <button class="btn btn-secondary" onclick="prevStep()">ä¸Šä¸€æ­¥</button>
            <button class="btn btn-primary" onclick="nextStep()">ä¸‹ä¸€æ­¥</button>
        </div>
    </div>

    <!-- Step 6: ç¡®è®¤éƒ¨ç½² -->
    <div class="step" id="step-6">
        <div class="step-title">ğŸ“‹ ç¡®è®¤éƒ¨ç½²é…ç½®</div>
        <div class="step-desc">æ£€æŸ¥ä»¥ä¸‹é…ç½®ï¼Œç¡®è®¤åå¼€å§‹éƒ¨ç½²</div>
        <div id="deploy-summary"></div>
        <div class="btn-row">
            <button class="btn btn-secondary" onclick="prevStep()">è¿”å›ä¿®æ”¹</button>
            <button class="btn btn-primary btn-lg" onclick="startDeploy()" id="btn-deploy">ğŸš€ å¼€å§‹éƒ¨ç½²</button>
        </div>
    </div>

    <!-- Deploy Progress View -->
    <div class="deploy-view" id="deploy-view">
        <div class="step-title" id="deploy-title">âš™ï¸ æ­£åœ¨éƒ¨ç½²...</div>
        <div class="step-desc" id="deploy-elapsed">å·²ç”¨æ—¶: 0 ç§’</div>
        <div class="deploy-content">
            <div class="deploy-steps-list" id="deploy-steps-list"></div>
            <div class="deploy-log" id="deploy-log"></div>
        </div>
        <!-- é”™è¯¯è¯¦æƒ… (éƒ¨ç½²å¤±è´¥æ—¶æ˜¾ç¤º) -->
        <div id="deploy-error-banner" style="display:none;margin-top:12px;padding:12px 16px;background:rgba(255,80,80,0.12);border:1px solid var(--red);border-radius:8px;color:var(--red);font-size:14px;word-break:break-word;"></div>
        <!-- æˆåŠŸæŒ‰é’® -->
        <div class="btn-row" id="deploy-done-row" style="display:none;margin-top:16px">
            <button class="btn btn-primary btn-lg" onclick="location.reload()">ğŸ‰ è¿›å…¥ Dashboard</button>
        </div>
        <!-- å¤±è´¥æŒ‰é’® -->
        <div class="btn-row" id="deploy-fail-row" style="display:none;margin-top:16px">
            <button class="btn btn-secondary" onclick="backToWizard()">â¬… è¿”å›ä¿®æ”¹é…ç½®</button>
            <button class="btn btn-primary btn-lg" onclick="retryDeploy()">ğŸ”„ é‡è¯•éƒ¨ç½²</button>
        </div>
    </div>
</div>

<script>
const TOTAL_STEPS = 7;
let currentStep = 0;
let wizardConfig = {
    image_type: '',
    password: '',
    cloudflared_token: '',
    rclone_config_method: 'skip',
    rclone_config_value: '',
    civitai_token: '',
    plugins: [],
    sync_pull: { workflows: true, loras: true, wildcards: true },
    sync_push: { output: false },
    sync_push_method: 'copy',
};
let pluginData = [];
let envVars = {};  // ä»ç¯å¢ƒå˜é‡æ£€æµ‹åˆ°çš„é¢„è®¾å€¼
let detectedImageType = '';  // åç«¯æ£€æµ‹çš„é•œåƒç±»å‹
let importedConfig = null;   // å¯¼å…¥çš„é…ç½®å¯¹è±¡ (é null è¡¨ç¤ºæ¢å¤æ¨¡å¼)

// â”€â”€ Init â”€â”€
async function init() {
    try {
        const r = await fetch('/api/setup/state');
        const state = await r.json();
        envVars = state.env_vars || {};
        detectedImageType = state.detected_image_type || '';

        // GPU info
        if (state.gpu_info && state.gpu_info.name) {
            const g = state.gpu_info;
            document.getElementById('gpu-info-display').innerHTML = `
                <div class="gpu-card">
                    <div class="gpu-name">ğŸ–¥ï¸ ${esc(g.name)}</div>
                    <div class="gpu-detail">CUDA Capability: ${esc(g.cuda_cap)} | VRAM: ${g.vram_gb} GB</div>
                </div>`;
        }

        // Load plugin list
        pluginData = state.plugins_available || [];
        const selectedUrls = state.plugins || pluginData.map(p => p.url);

        // è‡ªåŠ¨è®¾å®š image_type (ç”¨æˆ·ä¸å†æ‰‹åŠ¨é€‰)
        wizardConfig.image_type = detectedImageType || 'generic';

        // æ˜¾ç¤ºé•œåƒæ£€æµ‹ç»“æœ
        const badge = document.getElementById('image-type-badge');
        const descEl = document.getElementById('step-0-desc');
        const timeEl = document.getElementById('fresh-time');
        if (detectedImageType === 'prebuilt') {
            badge.style.display = 'block';
            badge.style.background = 'rgba(74,222,128,0.12)';
            badge.style.border = '1px solid var(--green)';
            badge.style.color = 'var(--green)';
            badge.innerHTML = 'âš¡ æ£€æµ‹åˆ°<b>é¢„æ„å»ºé•œåƒ</b> â€” å·²é¢„è£… PyTorch / ComfyUI / åŠ é€Ÿç»„ä»¶';
            timeEl.textContent = 'â± é¢„è®¡ 2-5 åˆ†é’Ÿ';
        } else {
            badge.style.display = 'block';
            badge.style.background = 'rgba(124,92,252,0.12)';
            badge.style.border = '1px solid var(--accent)';
            badge.style.color = 'var(--accent2)';
            badge.innerHTML = 'ğŸ”§ æ£€æµ‹åˆ°<b>é€šç”¨é•œåƒ</b> â€” å°†ä»é›¶å®‰è£… PyTorchã€ComfyUI å’ŒåŠ é€Ÿç»„ä»¶';
            timeEl.textContent = 'â± é¢„è®¡ 15-30 åˆ†é’Ÿ';
        }

        // æ¢å¤æ’ä»¶åˆ—è¡¨æ¸²æŸ“ (åŸºäºæ£€æµ‹åˆ°çš„ image_type)
        renderPluginList(pluginData, selectedUrls);

        // Restore state if partially filled
        if (state.image_type) {
            wizardConfig.image_type = state.image_type;
        }
        if (state.deploy_started && !state.deploy_completed) {
            showDeployView();
            connectSSE();
        } else if (state.deploy_error) {
            // ä¸Šæ¬¡éƒ¨ç½²å¤±è´¥ â€” æ˜¾ç¤ºé”™è¯¯æç¤ºï¼Œå…è®¸é‡è¯•æˆ–ä¿®æ”¹é…ç½®
            showStep(TOTAL_STEPS - 1);  // å›åˆ°ç¡®è®¤é¡µ
            renderSummary();
            const summaryEl = document.getElementById('deploy-summary');
            summaryEl.innerHTML = `
                <div style="padding:12px 16px;background:rgba(255,80,80,0.12);border:1px solid var(--red);border-radius:8px;color:var(--red);margin-bottom:16px;">
                    <strong>âš ï¸ ä¸Šæ¬¡éƒ¨ç½²æœªå®Œæˆ:</strong> ${esc(state.deploy_error)}<br>
                    <small>ç‚¹å‡»ã€Œé‡è¯•éƒ¨ç½²ã€å°†è‡ªåŠ¨è·³è¿‡å·²å®Œæˆçš„æ­¥éª¤ã€‚</small>
                </div>` + summaryEl.innerHTML;
        }

        // â”€â”€ ç¯å¢ƒå˜é‡é¢„å¡«å…… â”€â”€
        // å¯†ç 
        if (envVars.password) {
            document.getElementById('input-password').value = envVars.password;
            wizardConfig.password = envVars.password;
            const hint = document.getElementById('password-env-hint');
            hint.style.display = 'block';
            hint.innerHTML = 'âœ… å·²ä»ç¯å¢ƒå˜é‡ <code>DASHBOARD_PASSWORD</code> æ£€æµ‹åˆ°å¯†ç ï¼Œå¯ç›´æ¥ä½¿ç”¨æˆ–ä¿®æ”¹';
        }
        // CF Tunnel Token
        if (envVars.cloudflared_token) {
            document.getElementById('input-cf-token').value = envVars.cloudflared_token;
            wizardConfig.cloudflared_token = envVars.cloudflared_token;
            const hint = document.getElementById('cf-env-hint');
            hint.style.display = 'block';
            hint.innerHTML = 'âœ… å·²ä»ç¯å¢ƒå˜é‡ <code>CF_TUNNEL_TOKEN</code> æ£€æµ‹åˆ° Tokenï¼ˆTunnel å·²åœ¨è¿è¡Œä¸­ï¼‰';
        }
        // Rclone
        if (envVars.rclone_has_env) {
            document.getElementById('rclone-method-env').style.display = '';
            const hint = document.getElementById('rclone-env-hint');
            hint.style.display = 'block';
            hint.innerHTML = 'âœ… å·²ä»ç¯å¢ƒå˜é‡ <code>RCLONE_CONF_BASE64</code> æ£€æµ‹åˆ°é…ç½®';
            // è‡ªåŠ¨é€‰æ‹©ç¯å¢ƒå˜é‡é€‰é¡¹
            document.querySelector('input[name="rclone-method"][value="base64_env"]').checked = true;
            wizardConfig.rclone_config_method = 'base64_env';
            showRcloneInput('base64_env');
        }
        // CivitAI
        if (envVars.civitai_token) {
            document.getElementById('input-civitai-token').value = envVars.civitai_token;
            wizardConfig.civitai_token = envVars.civitai_token;
            const hint = document.getElementById('civitai-env-hint');
            hint.style.display = 'block';
            hint.innerHTML = 'âœ… å·²ä»ç¯å¢ƒå˜é‡ <code>CIVITAI_TOKEN</code> æ£€æµ‹åˆ° API Key';
        }

        // â”€â”€ ä»å·²ä¿å­˜çš„ state ä¸­æ¢å¤å­—æ®µ (æ”¯æŒå¯¼å…¥é…ç½®åé¢„å¡«å……) â”€â”€
        if (state.password && !document.getElementById('input-password').value) {
            document.getElementById('input-password').value = state.password;
            wizardConfig.password = state.password;
        }
        if (state.cloudflared_token && !document.getElementById('input-cf-token').value) {
            document.getElementById('input-cf-token').value = state.cloudflared_token;
            wizardConfig.cloudflared_token = state.cloudflared_token;
        }
        if (state.civitai_token && !document.getElementById('input-civitai-token').value) {
            document.getElementById('input-civitai-token').value = state.civitai_token;
            wizardConfig.civitai_token = state.civitai_token;
        }
        if (state.rclone_config_method && state.rclone_config_method !== 'skip') {
            const method = state.rclone_config_method;
            const radio = document.querySelector(`input[name="rclone-method"][value="${method}"]`);
            if (radio) { radio.checked = true; showRcloneInput(method); }
            wizardConfig.rclone_config_method = method;
            if (state.rclone_config_value) {
                wizardConfig.rclone_config_value = state.rclone_config_value;
                if (method === 'base64') document.getElementById('input-rclone-base64').value = state.rclone_config_value;
            }
        }
        if (state.plugins) wizardConfig.plugins = state.plugins;

        updateProgressBar();
    } catch (e) {
        console.error('init error:', e);
    }
}

function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

// â”€â”€ Navigation â”€â”€
function updateProgressBar() {
    const bar = document.getElementById('progressBar');
    bar.innerHTML = '';
    for (let i = 0; i < TOTAL_STEPS; i++) {
        const seg = document.createElement('div');
        seg.className = 'progress-segment' + (i < currentStep ? ' done' : i === currentStep ? ' active' : '');
        bar.appendChild(seg);
    }
}

function showStep(n) {
    document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
    const el = document.getElementById(`step-${n}`);
    if (el) el.classList.add('active');
    currentStep = n;
    updateProgressBar();
}

function nextStep() {
    saveCurrentStep();
    // æ¢å¤æ¨¡å¼: ä» step 0 ç›´æ¥è·³åˆ°ç¡®è®¤éƒ¨ç½² (step 6)
    if (currentStep === 0 && importedConfig) {
        showStep(TOTAL_STEPS - 1);
        renderSummary();
        return;
    }
    if (currentStep < TOTAL_STEPS - 1) {
        showStep(currentStep + 1);
        if (currentStep === TOTAL_STEPS - 1) renderSummary();
    }
}

function prevStep() {
    // ç¡®è®¤é¡µè¿”å›: æ¢å¤æ¨¡å¼å›åˆ° step 0, æ­£å¸¸æ¨¡å¼å›å‰ä¸€æ­¥
    if (currentStep === TOTAL_STEPS - 1 && importedConfig) {
        showStep(0);
        return;
    }
    if (currentStep > 0) showStep(currentStep - 1);
}

function saveCurrentStep() {
    switch (currentStep) {
        case 1:
            wizardConfig.password = document.getElementById('input-password').value || 'comfy2025';
            break;
        case 2:
            wizardConfig.cloudflared_token = document.getElementById('input-cf-token').value.trim();
            break;
        case 3:
            const method = document.querySelector('input[name="rclone-method"]:checked')?.value || 'skip';
            wizardConfig._rclone_display_method = method;  // ç”¨äº summary æ˜¾ç¤º
            if (method === 'file') {
                // æ–‡ä»¶ä¸Šä¼ : å·²åœ¨ handleRcloneFile ä¸­è®¾ç½® rclone_config_value
                wizardConfig.rclone_config_method = 'base64';  // åç«¯ç»Ÿä¸€ç”¨ base64
            } else {
                wizardConfig.rclone_config_method = method;
                if (method === 'url') wizardConfig.rclone_config_value = document.getElementById('input-rclone-url').value.trim();
                else if (method === 'base64') wizardConfig.rclone_config_value = document.getElementById('input-rclone-base64').value.trim();
                else if (method === 'base64_env') wizardConfig.rclone_config_value = '';
                else wizardConfig.rclone_config_value = '';
            }
            // æ‹‰å–é€‰é¡¹
            wizardConfig.sync_pull = {
                workflows: document.getElementById('sync-pull-workflows')?.checked ?? true,
                loras: document.getElementById('sync-pull-loras')?.checked ?? true,
                wildcards: document.getElementById('sync-pull-wildcards')?.checked ?? true,
            };
            // æ¨é€é€‰é¡¹
            wizardConfig.sync_push = {
                output: document.getElementById('sync-push-output')?.checked ?? false,
            };
            wizardConfig.sync_push_method = document.getElementById('sync-push-method')?.value || 'copy';
            break;
        case 4:
            wizardConfig.civitai_token = document.getElementById('input-civitai-token').value.trim();
            break;
        case 5:
            wizardConfig.plugins = getSelectedPlugins();
            break;
    }
    // Persist to backend
    fetch('/api/setup/save', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ...wizardConfig, current_step: currentStep })
    }).catch(() => {});
}

// â”€â”€ Mode Selection (å…¨æ–°éƒ¨ç½² / æ¢å¤è®¾ç½®) â”€â”€
function selectMode(mode) {
    document.querySelectorAll('.choice-card').forEach(c => c.classList.remove('selected'));

    if (mode === 'import') {
        // æ¢å¤è®¾ç½®æ¨¡å¼ â€” æ˜¾ç¤ºæ–‡ä»¶ä¸Šä¼ åŒº
        document.getElementById('choice-import').classList.add('selected');
        document.getElementById('import-upload-area').style.display = 'block';
        document.getElementById('btn-next-0').disabled = true;  // ç­‰å¯¼å…¥æˆåŠŸåå¯ç”¨
        importedConfig = null;
        return;
    }

    // å…¨æ–°éƒ¨ç½²æ¨¡å¼ â€” éšè—ä¸Šä¼ åŒº
    document.getElementById('import-upload-area').style.display = 'none';
    document.getElementById('import-result').style.display = 'none';
    importedConfig = null;

    document.getElementById('choice-fresh').classList.add('selected');
    document.getElementById('btn-next-0').disabled = false;
}

// â”€â”€ Rclone Input Toggle â”€â”€
function showRcloneInput(method) {
    document.getElementById('rclone-file-input').style.display = method === 'file' ? 'block' : 'none';
    document.getElementById('rclone-url-input').style.display = method === 'url' ? 'block' : 'none';
    document.getElementById('rclone-base64-input').style.display = method === 'base64' ? 'block' : 'none';
    document.getElementById('rclone-skip-note').style.display = method === 'skip' ? 'block' : 'none';
    // åŒæ­¥é€‰é¡¹é¢æ¿: é skip æ—¶æ˜¾ç¤º
    const show = method !== 'skip';
    document.getElementById('sync-pull-panel').style.display = show ? 'block' : 'none';
    document.getElementById('sync-push-panel').style.display = show ? 'block' : 'none';
}

function handleRcloneFile(event) {
    const file = event.target.files?.[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => {
        wizardConfig.rclone_config_value = btoa(reader.result);
        document.getElementById('rclone-file-status').textContent = `âœ… ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
    };
    reader.readAsText(file);
}

// Push output toggle
document.addEventListener('change', (e) => {
    if (e.target.id === 'sync-push-output') {
        document.getElementById('sync-push-method-row').style.display = e.target.checked ? 'block' : 'none';
    }
});

// â”€â”€ Plugins â”€â”€
function renderPluginList(plugins, selectedUrls) {
    const isPrebuilt = wizardConfig.image_type === 'prebuilt';
    const list = document.getElementById('plugin-list');
    if (isPrebuilt) {
        // é¢„æ„å»ºé•œåƒ: å¯¹æ’ä»¶åˆ—è¡¨æ˜¾ç¤ºæç¤º
        list.innerHTML = '<div style="color:var(--t2);font-size:.82rem;margin-bottom:12px">âš¡ é¢„æ„å»ºé•œåƒå·²åŒ…å«ä»¥ä¸‹æ’ä»¶ï¼Œå‡å·²é¢„è£…ä¸”ä¸å¯å–æ¶ˆï¼š</div>' +
        plugins.map((p, i) => {
            return `<div class="plugin-item">
                <input type="checkbox" id="plugin-${i}" checked disabled data-url="${esc(p.url)}">
                <span class="plugin-name">${esc(p.name)} <span class="plugin-required">é¢„è£…</span></span>
            </div>`;
        }).join('') +
        '<div style="color:var(--t2);font-size:.82rem;margin-top:12px">å¯åœ¨ä¸‹æ–¹æ·»åŠ é¢å¤–æ’ä»¶ï¼Œéƒ¨ç½²æ—¶ä¼šå®‰è£…ä¸åœ¨é•œåƒä¸­çš„æ–°æ’ä»¶ï¼š</div>';
    } else {
        list.innerHTML = plugins.map((p, i) => {
            const checked = selectedUrls.includes(p.url) || p.required;
            const disabled = p.required ? 'disabled' : '';
            const req = p.required ? '<span class="plugin-required">* å¿…é€‰</span>' : '';
            return `<div class="plugin-item">
                <input type="checkbox" id="plugin-${i}" ${checked ? 'checked' : ''} ${disabled} data-url="${esc(p.url)}">
                <span class="plugin-name">${esc(p.name)} ${req}</span>
            </div>`;
        }).join('');
    }
}

function getSelectedPlugins() {
    const urls = [];
    document.querySelectorAll('#plugin-list input[type="checkbox"]').forEach(cb => {
        if (cb.checked) urls.push(cb.dataset.url);
    });
    // Extra plugins
    const extra = document.getElementById('input-extra-plugins').value.trim();
    if (extra) {
        extra.split('\n').forEach(u => {
            u = u.trim();
            if (u && u.startsWith('http')) urls.push(u);
        });
    }
    return urls;
}

// â”€â”€ Summary â”€â”€
function renderSummary() {
    saveCurrentStep();
    const c = wizardConfig;
    const pluginCount = (c.plugins || []).length;
    // æ¢å¤æ¨¡å¼é¢å¤–ä¿¡æ¯
    let importNote = '';
    if (importedConfig) {
        importNote = `
        <div class="summary-card" style="border-color:var(--accent)">
            <h4>ğŸ“¦ ä»é…ç½®æ–‡ä»¶æ¢å¤</h4>
            <div class="summary-row"><span class="label">å¯¼å‡ºæ—¶é—´</span><span class="value">${esc(importedConfig._exported_at || 'æœªçŸ¥')}</span></div>
        </div>`;
    }
    const html = importNote + `
        <div class="summary-card">
            <h4>éƒ¨ç½²æ–¹å¼</h4>
            <div class="summary-row"><span class="label">é•œåƒç±»å‹</span><span class="value">${c.image_type === 'prebuilt' ? 'âš¡ é¢„æ„å»ºé•œåƒ' : 'ğŸ”§ é€šç”¨é•œåƒ'}</span></div>
        </div>
        <div class="summary-card">
            <h4>ç½‘ç»œä¸å®‰å…¨</h4>
            <div class="summary-row"><span class="label">Dashboard å¯†ç </span><span class="value">${c.password ? 'å·²è®¾ç½®' : 'æœªè®¾ç½®'}</span></div>
            <div class="summary-row"><span class="label">Cloudflare Tunnel</span><span class="value">${c.cloudflared_token ? 'âœ… å·²é…ç½®' : 'â­ è·³è¿‡'}</span></div>
        </div>
        <div class="summary-card">
            <h4>äº‘å­˜å‚¨ä¸åŒæ­¥</h4>
            <div class="summary-row"><span class="label">Rclone é…ç½®</span><span class="value">${(c._rclone_display_method || c.rclone_config_method) === 'skip' ? 'â­ è·³è¿‡' : (c._rclone_display_method || c.rclone_config_method) === 'url' ? 'ğŸ”— URL å¯¼å…¥' : (c._rclone_display_method || c.rclone_config_method) === 'file' ? 'ğŸ“‚ æ–‡ä»¶ä¸Šä¼ ' : 'ğŸ“‹ Base64'}</span></div>
            ${(c._rclone_display_method || c.rclone_config_method) !== 'skip' ? `
            <div class="summary-row"><span class="label">éƒ¨ç½²æ‹‰å–</span><span class="value">${[c.sync_pull?.workflows && 'å·¥ä½œæµ', c.sync_pull?.loras && 'LoRA', c.sync_pull?.wildcards && 'Wildcards'].filter(Boolean).join(', ') || 'æ— '}</span></div>
            <div class="summary-row"><span class="label">è¾“å‡ºæ¨é€</span><span class="value">${c.sync_push?.output ? (c.sync_push_method === 'move' ? 'âœ… move (é‡Šæ”¾ç©ºé—´)' : 'âœ… copy (ä¿ç•™æœ¬åœ°)') : 'â­ ä¸æ¨é€'}</span></div>
            ` : ''}
        </div>
        <div class="summary-card">
            <h4>æ¨¡å‹ä¸æ’ä»¶</h4>
            <div class="summary-row"><span class="label">CivitAI API Key</span><span class="value">${c.civitai_token ? 'âœ… å·²é…ç½®' : 'â­ è·³è¿‡'}</span></div>
            <div class="summary-row"><span class="label">æ’ä»¶æ•°é‡</span><span class="value">${pluginCount} ä¸ª</span></div>
        </div>`;
    document.getElementById('deploy-summary').innerHTML = html;
}

// â”€â”€ Deploy â”€â”€
async function startDeploy() {
    saveCurrentStep();
    document.getElementById('btn-deploy').disabled = true;

    try {
        const r = await fetch('/api/setup/deploy', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(wizardConfig)
        });
        const d = await r.json();
        if (!d.ok) { alert('éƒ¨ç½²å¯åŠ¨å¤±è´¥: ' + (d.error || '')); return; }
    } catch (e) { alert('è¯·æ±‚å¤±è´¥: ' + e.message); return; }

    showDeployView();
    connectSSE();
}

function showDeployView() {
    document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
    document.getElementById('deploy-view').classList.add('active');
    document.getElementById('progressBar').style.display = 'none';
    // éƒ¨ç½²é¡µå®½å±åˆ©ç”¨æ›´å¤šç©ºé—´
    document.querySelector('.wizard-container').style.maxWidth = '1400px';
    startElapsedTimer();
}

let elapsedTimer = null;
let deployStartTime = Date.now();

function startElapsedTimer() {
    deployStartTime = Date.now();
    elapsedTimer = setInterval(() => {
        const s = Math.floor((Date.now() - deployStartTime) / 1000);
        const m = Math.floor(s / 60);
        const sec = s % 60;
        document.getElementById('deploy-elapsed').textContent = `å·²ç”¨æ—¶: ${m > 0 ? m + ' åˆ† ' : ''}${sec} ç§’`;
    }, 1000);
}

let completedSteps = [];

function connectSSE() {
    const evtSource = new EventSource('/api/setup/log_stream');
    const logEl = document.getElementById('deploy-log');
    const stepsEl = document.getElementById('deploy-steps-list');

    evtSource.onmessage = (event) => {
        const data = JSON.parse(event.data);

        if (data.type === 'step') {
            // Mark previous step as done
            if (completedSteps.length > 0) {
                const prev = stepsEl.querySelector('.deploy-step-item.active');
                if (prev) { prev.classList.remove('active'); prev.classList.add('done'); prev.querySelector('.step-icon').textContent = 'âœ…'; }
            }
            completedSteps.push(data.name);
            const item = document.createElement('div');
            item.className = 'deploy-step-item active';
            item.innerHTML = `<span class="step-icon">â³</span>${esc(data.name)}`;
            stepsEl.appendChild(item);
            return;
        }

        if (data.type === 'done') {
            evtSource.close();
            if (elapsedTimer) clearInterval(elapsedTimer);
            // Mark last step done or failed
            const lastActive = stepsEl.querySelector('.deploy-step-item.active');
            if (lastActive) {
                lastActive.classList.remove('active');
                if (data.success) {
                    lastActive.classList.add('done');
                    lastActive.querySelector('.step-icon').textContent = 'âœ…';
                } else {
                    lastActive.style.color = 'var(--red)';
                    lastActive.querySelector('.step-icon').textContent = 'âŒ';
                }
            }

            if (data.success) {
                document.getElementById('deploy-title').textContent = 'âœ… éƒ¨ç½²å®Œæˆ';
                const doneEl = document.createElement('div');
                doneEl.className = 'log-line info';
                doneEl.style.color = 'var(--green)';
                doneEl.style.fontWeight = '600';
                doneEl.textContent = 'ğŸ‰ éƒ¨ç½²å®Œæˆï¼';
                logEl.appendChild(doneEl);
                document.getElementById('deploy-done-row').style.display = 'flex';
            } else {
                document.getElementById('deploy-title').textContent = 'âŒ éƒ¨ç½²å¤±è´¥';
                const errEl = document.createElement('div');
                errEl.className = 'log-line error';
                errEl.textContent = 'âŒ ' + (data.msg || 'éƒ¨ç½²å¤±è´¥');
                logEl.appendChild(errEl);
                // æ˜¾ç¤ºé”™è¯¯ banner
                const banner = document.getElementById('deploy-error-banner');
                banner.style.display = 'block';
                banner.innerHTML = `<strong>é”™è¯¯:</strong> ${esc(data.msg || 'éƒ¨ç½²è¿›ç¨‹å¼‚å¸¸ç»ˆæ­¢')}<br><small>å·²å®Œæˆçš„æ­¥éª¤ä¼šåœ¨é‡è¯•æ—¶è‡ªåŠ¨è·³è¿‡ï¼ŒèŠ‚çœæ—¶é—´ã€‚</small>`;
                document.getElementById('deploy-fail-row').style.display = 'flex';
            }
            logEl.scrollTop = logEl.scrollHeight;
            return;
        }

        if (data.type === 'log') {
            const line = document.createElement('div');
            line.className = `log-line ${data.level || 'info'}`;
            const timeSpan = data.time ? `<span class="log-time">${esc(data.time)}</span>` : '';
            line.innerHTML = `${timeSpan}${esc(data.msg)}`;
            logEl.appendChild(line);
            // Auto scroll
            if (logEl.scrollHeight - logEl.scrollTop - logEl.clientHeight < 100) {
                logEl.scrollTop = logEl.scrollHeight;
            }
        }
    };

    evtSource.onerror = () => {
        // Connection lost â€” might be done
        setTimeout(() => { evtSource.close(); }, 3000);
    };
}

function retryDeploy() {
    // é‡ç½® deploy view çŠ¶æ€
    document.getElementById('deploy-steps-list').innerHTML = '';
    document.getElementById('deploy-log').innerHTML = '';
    document.getElementById('deploy-error-banner').style.display = 'none';
    document.getElementById('deploy-fail-row').style.display = 'none';
    document.getElementById('deploy-done-row').style.display = 'none';
    document.getElementById('deploy-title').textContent = 'âš™ï¸ æ­£åœ¨éƒ¨ç½²... (æ™ºèƒ½é‡è¯•)';
    completedSteps = [];
    startDeploy();
}

function backToWizard() {
    // å›åˆ°é…ç½®ç¡®è®¤é¡µ
    document.getElementById('deploy-view').classList.remove('active');
    document.getElementById('progressBar').style.display = '';
    document.querySelector('.wizard-container').style.maxWidth = '';
    showStep(TOTAL_STEPS - 1);
    renderSummary();
}

async function handleImportFile(event) {
    const file = event.target.files?.[0];
    if (!file) return;
    event.target.value = '';
    try {
        const text = await file.text();
        const config = JSON.parse(text);

        if (!config._version) {
            showImportResult('âŒ æ— æ•ˆçš„é…ç½®æ–‡ä»¶æ ¼å¼', true);
            return;
        }

        // é•œåƒç±»å‹åŒ¹é…éªŒè¯ â€” é…ç½®æ–‡ä»¶çš„ image_type å¿…é¡»ä¸å½“å‰ç¯å¢ƒä¸€è‡´
        const cfgType = config.image_type;
        if (cfgType && detectedImageType && cfgType !== detectedImageType) {
            const cfgLabel = cfgType === 'prebuilt' ? 'é¢„æ„å»ºé•œåƒ' : 'é€šç”¨é•œåƒ';
            const envLabel = detectedImageType === 'prebuilt' ? 'é¢„æ„å»ºé•œåƒ' : 'é€šç”¨é•œåƒ';
            showImportResult(
                `âŒ é•œåƒç±»å‹ä¸åŒ¹é…ï¼<br>é…ç½®æ–‡ä»¶ä¸ºã€Œ<b>${esc(cfgLabel)}</b>ã€ï¼Œå½“å‰ç¯å¢ƒä¸ºã€Œ<b>${esc(envLabel)}</b>ã€ã€‚<br>` +
                `è¯·ä¸Šä¼ ä¸å½“å‰ç¯å¢ƒåŒ¹é…çš„é…ç½®æ–‡ä»¶ï¼Œæˆ–ä½¿ç”¨å¯¹åº”çš„ Docker é•œåƒé‡æ–°åˆ›å»ºå®ä¾‹ã€‚`,
                true
            );
            return;
        }

        // è°ƒç”¨åç«¯å¯¼å…¥ API
        const r = await fetch('/api/settings/import-config', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: text
        });
        const d = await r.json();
        if (!d.ok) {
            showImportResult('âŒ å¯¼å…¥å¤±è´¥: ' + esc(d.error || 'æœªçŸ¥é”™è¯¯'), true);
            return;
        }

        // å¯¼å…¥æˆåŠŸ â€” å¡«å…… wizardConfig (image_type å§‹ç»ˆç”¨å½“å‰ç¯å¢ƒæ£€æµ‹å€¼)
        importedConfig = config;
        wizardConfig.image_type = detectedImageType || cfgType || 'generic';
        if (config.password) wizardConfig.password = config.password;
        if (config.cloudflared_token) wizardConfig.cloudflared_token = config.cloudflared_token;
        if (config.civitai_token) wizardConfig.civitai_token = config.civitai_token;
        if (config.rclone_config_base64) {
            wizardConfig.rclone_config_method = 'base64';
            wizardConfig.rclone_config_value = config.rclone_config_base64;
        }
        // æ’ä»¶
        if (config.extra_plugins !== undefined || config.disabled_default_plugins !== undefined) {
            const defaultUrls = pluginData.map(p => p.url);
            const disabled = new Set(config.disabled_default_plugins || []);
            const plugins = defaultUrls.filter(u => !disabled.has(u));
            plugins.push(...(config.extra_plugins || []));
            wizardConfig.plugins = plugins;
        }
        // åŒæ­¥è§„åˆ™ (v2) â€” å¦‚æœæœ‰åˆ™ç›´æ¥ä½¿ç”¨ï¼Œä¸å†éœ€è¦ wizard åˆ›å»º
        if (config.sync_rules && config.sync_rules.length > 0) {
            wizardConfig._imported_sync_rules = true;
        }

        showImportResult(
            `âœ… å¯¼å…¥æˆåŠŸï¼å·²æ¢å¤ ${d.applied?.length || 0} é¡¹é…ç½®ã€‚<br><small>ç‚¹å‡»ã€Œä¸‹ä¸€æ­¥ã€æŸ¥çœ‹é…ç½®æ‘˜è¦å¹¶å¼€å§‹éƒ¨ç½²ã€‚</small>`,
            false
        );
        document.getElementById('btn-next-0').disabled = false;

    } catch (e) {
        showImportResult('âŒ æ–‡ä»¶è§£æå¤±è´¥: ' + e.message, true);
    }
}

function showImportResult(html, isError) {
    const el = document.getElementById('import-result');
    el.style.display = 'block';
    el.innerHTML = html;
    el.style.background = isError ? 'rgba(255,80,80,0.12)' : 'rgba(74,222,128,0.12)';
    el.style.border = `1px solid ${isError ? 'var(--red)' : 'var(--green)'}`;
    el.style.color = isError ? 'var(--red)' : 'var(--green)';
}

// â”€â”€ Start â”€â”€
init();
</script>
</body>
</html>
